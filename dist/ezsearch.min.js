var __async=(L,F,C)=>new Promise((z,K)=>{var M=O=>{try{k(C.next(O))}catch(P){K(P)}},x=O=>{try{k(C.throw(O))}catch(P){K(P)}},k=O=>O.done?z(O.value):Promise.resolve(O.value).then(M,x);k((C=C.apply(L,F)).next())});(function(L,F){typeof exports=="object"&&typeof module<"u"?module.exports=F():typeof define=="function"&&define.amd?define(F):(L=typeof globalThis<"u"?globalThis:L||self,L.EZSearch=F())})(this,function(){"use strict";const L=e=>Object.prototype.toString.call(e).slice(8,-1),F=e=>L(e)==="Object";let C="[EZSearch] :: ";function z(...e){return console.log(C,...e)}z.warn=(...e)=>console.warn(C,...e),z.info=(...e)=>console.info(C,...e),z.error=(...e)=>console.error(C,...e);function K(e){let t=[],r=!1;for(let n=0,o=0,s=0;s<e.length;s++){let c=e[s],m=e[s+1];if(t[n]=t[n]||[],t[n][o]=t[n][o]||"",c=='"'&&r&&m=='"'){t[n][o]+=c,++s;continue}if(c=='"'){r=!r;continue}if(c==","&&!r){++o;continue}if(c=="\r"&&m==`
`&&!r){++n,o=0,++s;continue}if(c==`
`&&!r){++n,o=0;continue}if(c=="\r"&&!r){++n,o=0;continue}t[n][o]+=c}return t}function M(e,t){return __async(this,null,function*(){if(typeof t=="function")return t({parseCSV:K});let r=yield fetch(e);if(!r.ok)return z("Unable to fetch CSV"),null;let n=yield r.text();return K(n)})}function x(e){return typeof e=="string"&&e.split(/,\s*/),null}function k(e,t="null"){try{return JSON.parse(e||t)}catch{return typeof t=="string"?JSON.parse(t):t}}function O(e,t){let r=0,n=null;return t.forEach((o,s)=>{s===e&&n==null&&(n=r),r++}),n}const P={ATTR:{id:"data-ezs-id",filter:"data-ezs-filter",csv_url:"data-ezs-csv-url",coll_handle:"data-ezs-collection-handle",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",filtered_title:"data-ezs-filtered-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",clear_cache:"data-ezs-clear-cache",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click"}};function ae(e){return e[e.length-1]}const se=()=>new Promise(e=>{document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",()=>e())});function B(e,t,r,n,o=!1){return n!=null?e.addEventListener(t,r,n):e.addEventListener(t,r),o&&r(),function(){e.removeEventListener(t,r)}}function V(e,t,r=0){if(F(e)){let n=Object.keys(e);n.forEach(o=>{let s=e[o];V(s,t,r+1)}),t(e,n,r)}return Array.isArray(e)&&e.forEach(n=>{V(n,t,r)}),e}function oe({data:e,keys:t=[],path:r=[],keysSort:n=[]}){let o={};return t.forEach((s,c)=>{let m=c===t.length-1;e.forEach(y=>{if(!y)return;let i=r.reduce((w,u)=>w[u],y);if(!i)return;let S=i[s];if(typeof S=="number"&&(S=S.toString()),typeof S!="string")return;let A=t.slice(0,c).reduce((w,u)=>w[i[u]],o);!A||(A[S]=m?y:{})})}),Object.keys(o).length>0?V(o,(s,c,m)=>{var y;if(!s._tag){const i=(y=n[m])==null?void 0:y.desc;s._keys_=c.sort((S,A)=>i?A.localeCompare(S):S.localeCompare(A))}}):o}function ce(e,t){if(t<0||t>=e.length)return!1;let r=e.slice(0,t);return Array.isArray(e[0])?r.every(([o,s])=>!!s):r.every(o=>!!o)}function ue({selectedValues:e,index:t,filterTree:r}){let n=ce(e,t);if(!n)return null;if(n){const o=Array.isArray(e[0]);return e.slice(0,t).reduce((c,m)=>{let y=o?m[1]:m;return c[y]},r)}}function fe({keys:e,filterTree:t,activeFilters:r}){return e.reduce((n,o)=>{let s=r.get(o);return s&&n?.[s]||null},t)}const j=e=>`ezs_${e}`,J=e=>`${e}__expiresIn`;function $(e){const t=j(e);return window.localStorage.removeItem(t),window.localStorage.removeItem(J(t)),!0}function Y(e){const t=j(e);let r=Date.now();return Number(window.localStorage.getItem(J(t))||"0")<r?($(t),null):window.localStorage.getItem(t)}function N(e,t,r=60*5){const n=j(e);r=Math.abs(r);let s=Date.now()+r*1e3;return window.localStorage.setItem(n,t),window.localStorage.setItem(J(n),s),!0}const{ATTR:h}=P;let ee={};function de({rootNode:e,fetchData:t,collectionHandle:r,onEvent:n,autoSearch:o=!1,productTags:s=null,cacheSeconds:c,hasCsvHeaders:m=!1,isFitmentWidget:y=!1}={}){let i={};if(!(e instanceof HTMLElement))throw new Error("rootNode must be specified");i.rootNode=e;let S=e.getAttribute(h.id)||"";if(i.filterSelects=Array.from(e.querySelectorAll(`select[${h.filter}]`)).map(u=>(u.setAttribute(h.filter,(u.getAttribute(h.filter)||"")+S),u)),i.filterKeys=i.filterSelects.map(u=>u.getAttribute(h.filter)).filter(Boolean),i.filterKeys.length<1||i.filterSelects.length!==i.filterKeys.length)throw new Error("Filter keys/selects mismatch");i.filterKeysSortBy=i.filterSelects.map(u=>{let q=u.getAttribute(h.sort_by)==="desc";return{desc:q,asc:!q}});let A=e.getAttribute(h.csv_url);if(typeof A!="string"&&!t)throw new Error("URL or `fetchData` must be specified");if(i.collectionHandle=typeof r=="string"?r:e.getAttribute(h.coll_handle)||"all",i.onEvent=typeof n=="function"?n:null,i.autoSearch=!!o||e.hasAttribute(h.auto_search),i.hasCsvHeaders=!!m||e.hasAttribute(h.csv_headers),i.isFitmentWidget=!!y||e.hasAttribute(h.fitment_widget),i.filteredLinks=Array.from(e.querySelectorAll(`a[${h.filtered_link}]`)),i.filteredTitle=Array.from(e.querySelectorAll(`[${h.filtered_title}]`)),i.triggerVerifyBtns=Array.from(e.querySelectorAll(`[${h.filter_trigger_verify}]`)),i.toggleOpenBtns=Array.from(e.querySelectorAll(`[${h.toggle_open}]`)),Array.from(e.querySelectorAll(`[${h.loading_on_click}]`)).forEach(u=>{u.__ezs_loadable=!0}),i.gotoPendingBtns=Array.from(e.querySelectorAll(`[${h.goto_pending}]`)).map(u=>(u.hasAttribute(h.clear_cache)&&(u.__ezs_clear_cache=!0),u)),i.gotoBaseCollectionBtns=Array.from(e.querySelectorAll(`[${h.goto_base_collection}]`)).map(u=>(u.hasAttribute(h.clear_cache)&&(u.__ezs_clear_cache=!0),u)),i.productTags=typeof s=="string"?x(s):Array.isArray(s)?s:null,i.productTags==null&&e.hasAttribute(h.prod_tags)){let u=e.getAttribute(h.prod_tags);i.productTags=k(u)||x(u)}c=typeof c=="number"?Math.trunc(c):0,i.cacheSeconds=c>0?c:null,typeof A=="string"&&(i.url=A),typeof t=="function"&&(i.fetchData=t);let w=e.querySelector("form[data-ezs-form]");return w&&(i.filterForm=w,i.filterFormSubmitBtn=w.querySelector('[type="submit"]')),i}function te(e){return __async(this,null,function*(){const{filterSelects:t,filterKeys:r,url:n,fetchData:o,collectionHandle:s,filterForm:c,filterFormSubmitBtn:m,rootNode:y,onEvent:i,autoSearch:S,productTags:A,cacheSeconds:w,gotoPendingBtns:u,gotoBaseCollectionBtns:q,loadableClassBtns:Ie,toggleOpenBtns:pe,filteredLinks:ye,filteredTitle:_e,hasCsvHeaders:me,triggerVerifyBtns:ve,isFitmentWidget:Se,filterKeysSortBy:Ae}=de(e);if(y.__ezs_hydrated){z("Already hydrated");return}y.__ezs_hydrated=!0;const H=[()=>{y.__ezs_hydrated=!1}],re=`/collections/${s}`,le=w&&w>0,ne=A&&A.length>0?A.reduce((a,g)=>(a[g]=!0,a),{}):null,E=new Map(Array.from({length:r.length},(a,g)=>[r[g],le&&Y(r[g])||""]));let R=null;function U({selectIndex:a,updateSelectValue:g=!1,forcePending:l=!1}={}){let f=[...E];f.forEach(([_,p],T)=>{const v=ue({selectedValues:f,index:T,filterTree:R});v?.[p]||E.set(_,"");const I=T>a,d=t[T],b=v?._keys_||[],G=Array.isArray(b)&&b.length>0;d.disabled=!G,le&&(p?N(_,p,w):$(_)),(a===-1||g?!1:I?b.length===d.options.length-1&&b.every((D,Q)=>D===d.options[Q+1].value):!0)||(d.options.length=1,requestAnimationFrame(()=>{b.forEach((D,Q)=>{d.options[Q+1]=new Option(D,D)}),d.value=E.get(_)}))}),(S||l||a===-1)&&Z({forcePending:l,preventAutosearch:a===-1,activeFiltersList:f}),i?.("SELECTION_UPDATE",{index:a,select:t[a]})}function Z({forcePending:a=!1,fromCache:g=!1,preventAutosearch:l=!1,activeFiltersList:f}={}){let _=(f||[...E]).every(([,d])=>!!d);y.setAttribute("data-ezs-selected-filters",_?"all":"partial");let p=a?null:g?k(Y("selectedItem"),"null"):fe({keys:r,activeFilters:E,filterTree:R}),T=p?._path;if(ne){let d=p?._tag,b=ne[d];y.setAttribute("data-ezs-state",p?b?"valid":"invalid":"pending")}c&&(T?(c.action=T,m&&(m.disabled=!1)):(c.removeAttribute("action"),m&&(m.disabled=!0))),p&&(i?.("SELECTION_COMPLETE",{selected:p}),y.dispatchEvent(new CustomEvent("EZSearch_Selected",{detail:{selected:p},bubbles:!1,cancelable:!1}))),ye.forEach(d=>{T?(d.setAttribute("href",p?._path),d.disabled=!0):(d.removeAttribute("href"),d.disabled=!0)});let v=p?r.map(d=>E.get(d)).join(" "):"";_e.forEach(d=>{d.textContent=v}),p?N("selectedItem",JSON.stringify(p)):$("selectedItem");let I=T&&c&&S&&!l;I&&(document.body.setAttribute("data-ezs-navigating",""),I&&c.submit())}function Ee(a){var g;let l=(g=a?.target)==null?void 0:g.__ezs_index;if(typeof l!="number"){z.warn("no `__ezs_index` found");return}const f=r[l],p=t[l].value;p?E.set(f,p):E.set(f,""),U({selectIndex:l})}function ie(a,g){if(!E.has(a))return;typeof g=="string"?g=g.trim():g="";let f=O(a,E);f!=null&&(E.set(a,g),U({selectIndex:f,updateSelectValue:!0,forcePending:!0}))}function W(){$("selectedItem"),r.forEach(a=>$(a))}function be(a){let g=a.map((l,f)=>{l.__ezs_index=f;let _=l.options[0];return _?(_.value="",_):(_=new Option("All","",!0,!0),_)});a.forEach((l,f)=>{let _=B(l,"change",Ee);H.push(_),l.options.length=1,l.options[0]=g[f]}),H.push(...ve.map(l=>(l.disabled&&(l.disabled=!1),B(l,"click",()=>{Z()}))),...u.map(l=>(l.disabled&&(l.disabled=!1),B(l,"click",()=>{l.__ezs_clear_cache&&(W(),ie(r[0],"")),Z({forcePending:!0}),a[0].focus()}))),...q.map(l=>(l.disabled&&(l.disabled=!1),B(l,"click",()=>{l.disabled=!0,l.__ezs_clear_cache&&W(),c?(c.action=re,c.submit()):window.location.href=re}))),...pe.map(l=>B(l,"click",()=>{y.classList.toggle("is-open")})),B(y,"click",l=>{let f=l?.target;f&&f.__ezs_loadable&&f.classList.add("btn--loading")})),U({selectIndex:-1})}function we(){return __async(this,null,function*(){let a=ee[n];if(a)return a;let g=M(n,o).then(l=>{if(l.length===0)return l;(me||r.every((v,I)=>l[0][I]===v))&&(l=l.slice(1));let f=!0,_=r.length,p=l.map(v=>(f&&v.length-1!==_&&(z.error("CSV data and `filterKeys` mismatch",{filterKeys:r,line:v}),f=!1),f?v.reduce((d,b,G)=>{let X=r[G];return X?d[X]=b:(d._path=s?b.replace("/all/",`/${s}/`):b,d._tag=ae(b.split("/"))),d},{}):[]));if(!f)throw new Error("CSV data and `filterKeys` mismatch");return oe({data:p,activeFilters:[...E],path:[],keys:r,keysSort:Ae,getValue:(v,I,d)=>v[d]})});return ee[n]=g,g})}function Ce(){Se&&Z({fromCache:!0})}function ze(){y.setAttribute("data-ezs-loaded","true")}function Oe(){return __async(this,null,function*(){return Ce(),we().then(a=>__async(this,null,function*(){R=a,be(t)})).then(()=>{ze()})})}return Oe().then(()=>({filterTree:R,getActiveFilters(){return[...E]},updateFilterValue:ie,clearAllCache:W,destory(){t.forEach(a=>{a.options.length=1}),H.forEach(a=>a()),H.length=1}}))})}var Te="";window.EZSearchDefaultInstances=[];function he(){Array.from(document.querySelectorAll('[data-ezs="search"]:not([data-ezs-auto-initialize="false"])')).forEach(t=>{document.dispatchEvent(new CustomEvent("EZSearch_Loading",{detail:t})),te({rootNode:t,autoSearch:!1,cacheSeconds:300,hasCsvHeaders:!1,onEvent:null}).then(r=>{window.EZSearchDefaultInstances.push(r),document.dispatchEvent(new CustomEvent("EZSearch_Loaded",{detail:t}))})})}se().then(he);var ge={hydrate:te};return ge});
