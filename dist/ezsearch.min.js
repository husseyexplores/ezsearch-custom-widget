var __async=(K,P,k)=>new Promise((F,D)=>{var N=$=>{try{R(k.next($))}catch(H){D(H)}},U=$=>{try{R(k.throw($))}catch(H){D(H)}},R=$=>$.done?F($.value):Promise.resolve($.value).then(N,U);R((k=k.apply(K,P)).next())});(function(K,P){typeof exports=="object"&&typeof module<"u"?module.exports=P():typeof define=="function"&&define.amd?define(P):(K=typeof globalThis<"u"?globalThis:K||self,K.EZSearch=P())})(this,function(){"use strict";const K=e=>Object.prototype.toString.call(e).slice(8,-1),P=e=>K(e)==="Object";let k="[EZSearch] :: ";function F(...e){return console.log(k,...e)}F.warn=(...e)=>console.warn(k,...e),F.info=(...e)=>console.info(k,...e),F.error=(...e)=>console.error(k,...e);function D(e){let r=[],t=!1;for(let l=0,a=0,o=0;o<e.length;o++){let c=e[o],y=e[o+1];if(r[l]=r[l]||[],r[l][a]=r[l][a]||"",c=='"'&&t&&y=='"'){r[l][a]+=c,++o;continue}if(c=='"'){t=!t;continue}if(c==","&&!t){++a;continue}if(c=="\r"&&y==`
`&&!t){++l,a=0,++o;continue}if(c==`
`&&!t){++l,a=0;continue}if(c=="\r"&&!t){++l,a=0;continue}r[l][a]+=c}return r}function N(e,r){return __async(this,null,function*(){if(typeof r=="function")return r(e).then(a=>typeof a=="string"?D(a):a);let t=yield fetch(e.replace(/\\\//g,"/"));if(!t.ok)return F("Unable to fetch CSV"),null;let l=yield t.text();return D(l)})}function U(e){return typeof e=="string"&&e.split(/,\s*/),null}function R(e,r="null"){try{return JSON.parse(e||r)}catch{return typeof r=="string"?JSON.parse(r):r}}function $(e,r){let t=0,l=null;return r.forEach((a,o)=>{o===e&&l==null&&(l=t),t++}),l}const H={ATTR:{id:"data-ezs-id",legacy_search:"data-legacy-search",filter:"data-ezs-filter",csv_url:"data-ezs-csv-url",coll_handle:"data-ezs-collection-handle",rest_next_selects_on_change:"data-ezs-reset-next-selects-on-change",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",filtered_title:"data-ezs-filtered-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_cache:"data-ezs-clear-cache",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function ie(e){return e[e.length-1]}const pe=()=>new Promise(e=>{document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",()=>e())});function V(e,r,t,l,a=!1){return l!=null?e.addEventListener(r,t,l):e.addEventListener(r,t),a&&t(),function(){e.removeEventListener(r,t)}}function ee(e,r,t=0){if(P(e)){let l=Object.keys(e);l.forEach(a=>{let o=e[a];ee(o,r,t+1)}),r(e,l,t)}return Array.isArray(e)&&e.forEach(l=>{ee(l,r,t)}),e}function _e({data:e,keys:r=[],path:t=[],keysSort:l=[]}){let a={};return r.forEach((o,c)=>{let y=c===r.length-1;e.forEach(S=>{if(!S)return;let d=t.reduce((I,i)=>I[i],S);if(!d)return;let v=d[o];if(typeof v=="number"&&(v=v.toString()),typeof v!="string"||v==="")return;let w=r.slice(0,c).reduce((I,i)=>I[d[i]],a);if(w)if(y){const I=new ae(S);w[v]?Array.isArray(w[v])?w[v].push(I):w[v]=[w[v],I]:w[v]=I}else w[v]={}})}),Object.keys(a).length>0?ee(a,(o,c,y)=>{var S;if(!o._tag){const d=(S=l[y])==null?void 0:S.desc;o._keys_=c.sort((v,w)=>d?w.localeCompare(v):v.localeCompare(w))}}):a}function ye(e,r){if(r<0||r>=e.length)return!1;let t=e.slice(0,r);return Array.isArray(e[0])?t.every(([a,o])=>!!o):t.every(a=>!!a)}function me({selectedValues:e,index:r,filterTree:t}){let l=ye(e,r);if(!l)return null;if(l){const a=Array.isArray(e[0]);return e.slice(0,r).reduce((c,y)=>{if(c==null)return null;let S=a?y[1]:y;return c[S]},t)}}function ve({keys:e,filterTree:r,activeFilters:t}){return e.reduce((l,a)=>{let o=t.get(a);return o&&l?.[o]||null},r)}class ae{constructor(r){this.value=r}}const te=e=>`ezs_${e}`,re=e=>`${e}__expiresIn`;function M(e){const r=te(e);return window.localStorage.removeItem(r),window.localStorage.removeItem(re(r)),!0}function se(e){const r=te(e);let t=Date.now();return Number(window.localStorage.getItem(re(r))||"0")<t?(M(r),null):window.localStorage.getItem(r)}function oe(e,r,t=60*5){const l=te(e);t=Math.abs(t);let o=Date.now()+t*1e3;return window.localStorage.setItem(l,r),window.localStorage.setItem(re(l),o),!0}const{ATTR:f}=H;let ce={};function be({legacySearch:e,url:r=void 0,rootNode:t,fetchData:l,collectionHandle:a,onEvent:o,resetNextSelectsOnChange:c=!1,autoSearch:y=!1,productTags:S=null,cacheSeconds:d=300,hasCsvHeaders:v=!1,isFitmentWidget:w=!1,loadingBtnClass:I="btn--loading"}={}){let i={__validated:!0};if(!(t instanceof HTMLElement))throw new Error("rootNode must be specified");i.rootNode=t,typeof e>"u"&&(e=t.getAttribute(f.legacy_search)),i.legacySearch=typeof e=="boolean"?e:e==="true"?!0:e!=="false";let J=t.getAttribute(f.id)||"";if(i.filterSelects=Array.from(t.querySelectorAll(`select[${f.filter}]`)).map(b=>(b.setAttribute(f.filter,(b.getAttribute(f.filter)||"")+J),b)),i.filterKeys=i.filterSelects.map(b=>b.getAttribute(f.filter)).filter(Boolean),i.filterKeys.length<1||i.filterSelects.length!==i.filterKeys.length)throw new Error("Filter keys/selects mismatch");if(i.filterKeysSortBy=i.filterSelects.map(b=>{let q=b.getAttribute(f.sort_by)==="desc";return{desc:q,asc:!q}}),(typeof r!="string"||!r.trim())&&(r=t.getAttribute(f.csv_url),typeof r!="string"&&!l))throw new Error("URL or `fetchData` must be specified");if(i.collectionHandle=typeof a=="string"?a:t.getAttribute(f.coll_handle)||"all",i.onEvent=typeof o=="function"?o:null,i.autoSearch=!!y||t.hasAttribute(f.auto_search),i.resetNextSelectsOnChange=!!c||t.hasAttribute(f.rest_next_selects_on_change),i.hasCsvHeaders=!!v||t.hasAttribute(f.csv_headers),i.isFitmentWidget=!!w||t.hasAttribute(f.fitment_widget),i.loadingBtnClass=(typeof I=="string"?I:t.getAttribute(f.loading_btn_class)||"").split(" ").filter(Boolean),i.loadingBtnClass.length===0&&(i.loadingBtnClass=null),i.filteredLinks=Array.from(t.querySelectorAll(`a[${f.filtered_link}]`)),i.filteredTitle=Array.from(t.querySelectorAll(`[${f.filtered_title}]`)),i.triggerVerifyBtns=Array.from(t.querySelectorAll(`[${f.filter_trigger_verify}]`)),i.toggleOpenBtns=Array.from(t.querySelectorAll(`[${f.toggle_open}]`)),Array.from(t.querySelectorAll(`[${f.loading_on_click}]`)).forEach(b=>{b.__ezs_loadable=!0}),i.gotoPendingBtns=Array.from(t.querySelectorAll(`[${f.goto_pending}]`)).map(b=>(b.hasAttribute(f.clear_cache)&&(b.__ezs_clear_cache=!0),b)),i.gotoBaseCollectionBtns=Array.from(t.querySelectorAll(`[${f.goto_base_collection}]`)).map(b=>(b.hasAttribute(f.clear_cache)&&(b.__ezs_clear_cache=!0),b)),i.productTags=typeof S=="string"?U(S):Array.isArray(S)?S:null,i.productTags==null&&t.hasAttribute(f.prod_tags)){let b=t.getAttribute(f.prod_tags);i.productTags=R(b)||U(b)}d=t.getAttribute(f.cache_seconds)||d,typeof d=="string"&&(d=Number(d)||300),i.cacheSeconds=typeof d=="number"?Math.max(Math.trunc(d),0):0,i.preClearCache=t.hasAttribute(f.pre_clear_cache),typeof r=="string"&&(i.url=r),typeof l=="function"&&(i.fetchData=l);let Z=t.querySelector("form[data-ezs-form]");return Z&&(i.filterForm=Z,i.filterFormSubmitBtn=Z.querySelector('[type="submit"]')),i}function ue(e){return __async(this,null,function*(){const{legacySearch:r,filterSelects:t,filterKeys:l,url:a,fetchData:o,collectionHandle:c,filterForm:y,filterFormSubmitBtn:S,rootNode:d,onEvent:v,autoSearch:w,productTags:I,cacheSeconds:i,preClearCache:J,gotoPendingBtns:Z,gotoBaseCollectionBtns:b,loadingBtnClass:q,toggleOpenBtns:Ee,filteredLinks:Se,filteredTitle:Ce,hasCsvHeaders:we,triggerVerifyBtns:ze,isFitmentWidget:Oe,filterKeysSortBy:Ie,resetNextSelectsOnChange:fe}=e.__validated?e:be(e);if(d.__ezs_hydrated){F("Already hydrated");return}d.__ezs_hydrated=!0;const W=[()=>{d.__ezs_hydrated=!1}],de=`/collections/${c}`,he=i&&i>0,j=I&&I.length>0?I.reduce((s,A)=>(s[A]=!0,s),{}):null,O=new Map(Array.from({length:l.length},(s,A)=>[l[A],!he||J?"":se(l[A])||""]));let Y=null;function le({selectIndex:s,updateSelectValue:A=!1,forcePending:n=!1}={}){let h=[...O];h.forEach(([m,g],L)=>{const T=me({selectedValues:h,index:L,filterTree:Y});T?.[g]||O.set(m,"");const p=L>s,u=t[L],z=T?._keys_||[],_=Array.isArray(z)&&z.length>0;u.disabled=!_,he&&(g?oe(m,g,i):M(m)),(s===-1||A?!1:p?fe?!1:z.length===u.options.length-1&&z.every((E,C)=>E===u.options[C+1].value):!0)||(u.options.length=1,requestAnimationFrame(()=>{z.forEach((E,C)=>{u.options[C+1]=new Option(E,E)}),u.value=O.get(m)}))}),(w||n||s===-1)&&G({forcePending:n,preventAutosearch:s===-1,activeFiltersList:h}),v?.("SELECTION_UPDATE",{index:s,select:t[s]}),d.dispatchEvent(new CustomEvent("ezsearch::selection_update",{detail:{index:s,select:t[s]},bubbles:!1,cancelable:!1}))}function G({forcePending:s=!1,fromCache:A=!1,preventAutosearch:n=!1}={}){let h=[...O].every(([,_])=>!!_);d.setAttribute("data-ezs-selected-filters",h?"all":"partial");let m=s?null:A?R(se("selectedItem"),"null"):ve({keys:l,activeFilters:O,filterTree:Y}),g=m instanceof ae?m.value:null;Array.isArray(m)&&(g=((j?m.find(_=>{var B;const E=(B=_.value)==null?void 0:B._tag;return!!j[E]}):null)||m[0]).value);let L=g?._path,T=g?._tag,p=j?j[T]:null;if(d.setAttribute("data-ezs-state",g?p?"valid":"invalid":"pending"),y){let _=null;r||(_=y._filter_p_tag_el,_||(_=document.createElement("input"),_.setAttribute("type","hidden"),_.setAttribute("name","filter.p.tag"),y._filter_p_tag_el=_,y.appendChild(_))),_&&(_.value=T||""),L?(y.action=L,S&&(S.disabled=!1)):(y.removeAttribute("action"),S&&(S.disabled=!0))}g&&(v?.("SELECTION_COMPLETE",{selected:g}),d.dispatchEvent(new CustomEvent("ezsearch::selection_complete",{detail:{selected:g,fits:p==null?void 0:!!p},bubbles:!1,cancelable:!1}))),Se.forEach(_=>{L?(_.setAttribute("href",g?._path),_.disabled=!0):(_.removeAttribute("href"),_.disabled=!0)});let u=g?l.map(_=>O.get(_)).join(" "):"";Ce.forEach(_=>{_.textContent=u}),g?oe("selectedItem",JSON.stringify(g)):M("selectedItem");let z=L&&y&&w&&!n;z&&(document.body.setAttribute("data-ezs-navigating",""),z&&y.submit())}function Le(s){var A;let n=(A=s?.target)==null?void 0:A.__ezs_index;if(typeof n!="number"){F.warn("no `__ezs_index` found");return}const h=l[n],g=t[n].value;g?O.set(h,g):O.set(h,""),fe&&[...O].forEach(([L],T)=>{T>n&&O.set(L,"")}),le({selectIndex:n})}function ge(s,A){if(!O.has(s))return;typeof A=="string"?A=A.trim():A="";let h=$(s,O);h!=null&&(O.set(s,A),le({selectIndex:h,updateSelectValue:!0,forcePending:!0}))}function X(){M("selectedItem"),l.forEach(s=>M(s))}function Te(s){let A=s.map((n,h)=>{n.__ezs_index=h;let m=n.options[0];return m?(m.value="",m):(m=new Option("All","",!0,!0),m)});s.forEach((n,h)=>{let m=V(n,"change",Le);W.push(m),n.options.length=1,n.options[0]=A[h]}),W.push(...ze.map(n=>(n.disabled&&(n.disabled=!1),V(n,"click",()=>{G()}))),...Z.map(n=>(n.disabled&&(n.disabled=!1),V(n,"click",()=>{n.__ezs_clear_cache&&(X(),ge(l[0],"")),G({forcePending:!0}),s[0].focus()}))),...b.map(n=>(n.disabled&&(n.disabled=!1),V(n,"click",()=>{n.disabled=!0,n.__ezs_clear_cache&&X(),y?(y.action=de,y.submit()):window.location.href=de}))),...Ee.map(n=>V(n,"click",()=>{d.classList.toggle("is-open")})),V(d,"click",n=>{let h=n?.target;h&&h.__ezs_loadable&&q?.forEach(m=>{h.classList.add(m)})})),le({selectIndex:-1})}function Fe(){return __async(this,null,function*(){let s=ce[a];if(s)return s;if(!a){F.error("no `url` found"),d.classList.add("is-invalid"),d.style.display="none";return}let A=N(a,o).then(n=>{if(n.length===0)return n;(we||l.every((p,u)=>n[0][u]===p))&&(n=n.slice(1));let h=!0,m=l.length,g=l.findIndex(p=>p.toLowerCase()==="year");g!==-1&&(n=n.reduce((p,u)=>{const z=u[g];if(!z.includes("-"))return p.push(u),p;let[B,E]=z.split("-").map(C=>Number(C)).reduce((C,x)=>(C.push(Number.isNaN(x)?null:x),C),[]);if(B&&E){for(let C=B;C<=E;C++)p.push(u.map((x,Q)=>Q===g?C:x));return p}return!E&&B&&p.push(u.map((C,x)=>x===g?B:C)),p},[]));let L=n.map(p=>{if(h&&p.length-1!==m&&(F.error("CSV data and `filterKeys` mismatch",{filterKeys:l,line:p}),h=!1),!h)return[];let u=p[l.length];u.startsWith(">>")&&(u=u.slice(2),p[l.length]=u);const z="/collections/all/";if(u.startsWith(z)&&(u=u.slice(z.length)),u.includes("$$$")){const[E]=u.split("$$$");if(E)u=E,p[l.length]=u;else return[]}return p.reduce((E,C,x)=>{let Q=l[x];if(Q)E[Q]=C;else{const ne=ie(C.split("/"));E._path=`/collections/${c||"all"}/${ne}`,E._tag=ie(ne.split("/")),r||(E._path=`/collections/${c||"all"}?filter.p.tag=${ne}`)}return E},{})});if(!h)throw new Error("CSV data and `filterKeys` mismatch");return _e({data:L,activeFilters:[...O],path:[],keys:l,keysSort:Ie,getValue:(p,u,z)=>p[z]})});return ce[a]=A,A})}function ke(){Oe&&G({fromCache:!0})}function $e(){d.setAttribute("data-ezs-loaded","true")}function Be(){return __async(this,null,function*(){return J&&X(),ke(),Fe().then(s=>__async(this,null,function*(){Y=s,Te(t)})).then(()=>{$e()})})}return Be().then(()=>({filterTree:Y,getActiveFilters(){return[...O]},updateFilterValue:ge,clearAllCache:X,prodcutTagsLookup:j,destory(){t.forEach(s=>{s.options.length=1}),W.forEach(s=>s()),W.length=1}}))})}const xe="";window.EZSearchDefaultInstances=[];function Ae(){return __async(this,null,function*(){Array.from(document.querySelectorAll('[data-ezs="search"]:not([data-ezs-auto-initialize="false"])')).forEach(r=>__async(this,null,function*(){var t,l;document.dispatchEvent(new CustomEvent("EZSearch_Loading",{detail:r}));const a=r.getAttribute("data-ezs-config-url");let o="";if(a){const c=yield fetch(a).then(y=>y.json());(l=(t=c?.settings)==null?void 0:t.form)!=null&&l.db&&(o=c.settings.form.db)}ue({url:o,rootNode:r,onEvent:null}).then(c=>{window.EZSearchDefaultInstances.push(c),document.dispatchEvent(new CustomEvent("EZSearch_Loaded",{detail:r}))})}))})}return pe().then(Ae),{hydrate:ue}});
