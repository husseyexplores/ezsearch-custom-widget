var __async=(K,q,F)=>new Promise(($,D)=>{var Q=k=>{try{R(F.next(k))}catch(H){D(H)}},j=k=>{try{R(F.throw(k))}catch(H){D(H)}},R=k=>k.done?$(k.value):Promise.resolve(k.value).then(Q,j);R((F=F.apply(K,q)).next())});(function(K,q){typeof exports=="object"&&typeof module<"u"?module.exports=q():typeof define=="function"&&define.amd?define(q):(K=typeof globalThis<"u"?globalThis:K||self,K.EZSearch=q())})(this,function(){"use strict";const K=e=>Object.prototype.toString.call(e).slice(8,-1),q=e=>K(e)==="Object";let F="[EZSearch] :: ";function $(...e){return console.log(F,...e)}$.warn=(...e)=>console.warn(F,...e),$.info=(...e)=>console.info(F,...e),$.error=(...e)=>console.error(F,...e);function D(e){let t=[],r=!1;for(let i=0,a=0,o=0;o<e.length;o++){let c=e[o],g=e[o+1];if(t[i]=t[i]||[],t[i][a]=t[i][a]||"",c=='"'&&r&&g=='"'){t[i][a]+=c,++o;continue}if(c=='"'){r=!r;continue}if(c==","&&!r){++a;continue}if(c=="\r"&&g==`
`&&!r){++i,a=0,++o;continue}if(c==`
`&&!r){++i,a=0;continue}if(c=="\r"&&!r){++i,a=0;continue}t[i][a]+=c}return t}function Q(e,t){return __async(this,null,function*(){if(typeof t=="function")return t(e).then(a=>typeof a=="string"?D(a):a);let r=yield fetch(e.replace(/\\\//g,"/"));if(!r.ok)return $("Unable to fetch CSV"),null;let i=yield r.text();return D(i)})}function j(e){return typeof e=="string"&&e.split(/,\s*/),null}function R(e,t="null"){try{return JSON.parse(e||t)}catch{return typeof t=="string"?JSON.parse(t):t}}function k(e,t){let r=0,i=null;return t.forEach((a,o)=>{o===e&&i==null&&(i=r),r++}),i}const H={ATTR:{id:"data-ezs-id",filter:"data-ezs-filter",csv_url:"data-ezs-csv-url",coll_handle:"data-ezs-collection-handle",rest_next_selects_on_change:"data-ezs-reset-next-selects-on-change",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",filtered_title:"data-ezs-filtered-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_cache:"data-ezs-clear-cache",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function de(e){return e[e.length-1]}const he=()=>new Promise(e=>{document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",()=>e())});function V(e,t,r,i,a=!1){return i!=null?e.addEventListener(t,r,i):e.addEventListener(t,r),a&&r(),function(){e.removeEventListener(t,r)}}function N(e,t,r=0){if(q(e)){let i=Object.keys(e);i.forEach(a=>{let o=e[a];N(o,t,r+1)}),t(e,i,r)}return Array.isArray(e)&&e.forEach(i=>{N(i,t,r)}),e}function ge({data:e,keys:t=[],path:r=[],keysSort:i=[]}){let a={};return t.forEach((o,c)=>{let g=c===t.length-1;e.forEach(p=>{if(!p)return;let I=r.reduce((z,T)=>z[T],p);if(!I)return;let v=I[o];if(typeof v=="number"&&(v=v.toString()),typeof v!="string"||v==="")return;let l=t.slice(0,c).reduce((z,T)=>z[I[T]],a);if(l)if(g){const z=new le(p);l[v]?Array.isArray(l[v])?l[v].push(z):l[v]=[l[v],z]:l[v]=z}else l[v]={}})}),Object.keys(a).length>0?N(a,(o,c,g)=>{var p;if(!o._tag){const I=(p=i[g])==null?void 0:p.desc;o._keys_=c.sort((v,l)=>I?l.localeCompare(v):v.localeCompare(l))}}):a}function pe(e,t){if(t<0||t>=e.length)return!1;let r=e.slice(0,t);return Array.isArray(e[0])?r.every(([a,o])=>!!o):r.every(a=>!!a)}function _e({selectedValues:e,index:t,filterTree:r}){let i=pe(e,t);if(!i)return null;if(i){const a=Array.isArray(e[0]);return e.slice(0,t).reduce((c,g)=>{if(c==null)return null;let p=a?g[1]:g;return c[p]},r)}}function ye({keys:e,filterTree:t,activeFilters:r}){return e.reduce((i,a)=>{let o=r.get(a);return o&&i?.[o]||null},t)}class le{constructor(t){this.value=t}}const ee=e=>`ezs_${e}`,te=e=>`${e}__expiresIn`;function M(e){const t=ee(e);return window.localStorage.removeItem(t),window.localStorage.removeItem(te(t)),!0}function ne(e){const t=ee(e);let r=Date.now();return Number(window.localStorage.getItem(te(t))||"0")<r?(M(t),null):window.localStorage.getItem(t)}function ie(e,t,r=60*5){const i=ee(e);r=Math.abs(r);let o=Date.now()+r*1e3;return window.localStorage.setItem(i,t),window.localStorage.setItem(te(i),o),!0}const{ATTR:d}=H;let ae={};function me({rootNode:e,fetchData:t,collectionHandle:r,onEvent:i,resetNextSelectsOnChange:a=!1,autoSearch:o=!1,productTags:c=null,cacheSeconds:g=300,hasCsvHeaders:p=!1,isFitmentWidget:I=!1,loadingBtnClass:v="btn--loading"}={}){let l={};if(!(e instanceof HTMLElement))throw new Error("rootNode must be specified");l.rootNode=e;let z=e.getAttribute(d.id)||"";if(l.filterSelects=Array.from(e.querySelectorAll(`select[${d.filter}]`)).map(_=>(_.setAttribute(d.filter,(_.getAttribute(d.filter)||"")+z),_)),l.filterKeys=l.filterSelects.map(_=>_.getAttribute(d.filter)).filter(Boolean),l.filterKeys.length<1||l.filterSelects.length!==l.filterKeys.length)throw new Error("Filter keys/selects mismatch");l.filterKeysSortBy=l.filterSelects.map(_=>{let P=_.getAttribute(d.sort_by)==="desc";return{desc:P,asc:!P}});let T=e.getAttribute(d.csv_url);if(typeof T!="string"&&!t)throw new Error("URL or `fetchData` must be specified");if(l.collectionHandle=typeof r=="string"?r:e.getAttribute(d.coll_handle)||"all",l.onEvent=typeof i=="function"?i:null,l.autoSearch=!!o||e.hasAttribute(d.auto_search),l.resetNextSelectsOnChange=!!a||e.hasAttribute(d.rest_next_selects_on_change),l.hasCsvHeaders=!!p||e.hasAttribute(d.csv_headers),l.isFitmentWidget=!!I||e.hasAttribute(d.fitment_widget),l.loadingBtnClass=(typeof v=="string"?v:e.getAttribute(d.loading_btn_class)||"").split(" ").filter(Boolean),l.loadingBtnClass.length===0&&(l.loadingBtnClass=null),l.filteredLinks=Array.from(e.querySelectorAll(`a[${d.filtered_link}]`)),l.filteredTitle=Array.from(e.querySelectorAll(`[${d.filtered_title}]`)),l.triggerVerifyBtns=Array.from(e.querySelectorAll(`[${d.filter_trigger_verify}]`)),l.toggleOpenBtns=Array.from(e.querySelectorAll(`[${d.toggle_open}]`)),Array.from(e.querySelectorAll(`[${d.loading_on_click}]`)).forEach(_=>{_.__ezs_loadable=!0}),l.gotoPendingBtns=Array.from(e.querySelectorAll(`[${d.goto_pending}]`)).map(_=>(_.hasAttribute(d.clear_cache)&&(_.__ezs_clear_cache=!0),_)),l.gotoBaseCollectionBtns=Array.from(e.querySelectorAll(`[${d.goto_base_collection}]`)).map(_=>(_.hasAttribute(d.clear_cache)&&(_.__ezs_clear_cache=!0),_)),l.productTags=typeof c=="string"?j(c):Array.isArray(c)?c:null,l.productTags==null&&e.hasAttribute(d.prod_tags)){let _=e.getAttribute(d.prod_tags);l.productTags=R(_)||j(_)}g=e.getAttribute(d.cache_seconds)||g,typeof g=="string"&&(g=Number(g)||300),l.cacheSeconds=typeof g=="number"?Math.max(Math.trunc(g),0):0,l.preClearCache=e.hasAttribute(d.pre_clear_cache),typeof T=="string"&&(l.url=T),typeof t=="function"&&(l.fetchData=t);let U=e.querySelector("form[data-ezs-form]");return U&&(l.filterForm=U,l.filterFormSubmitBtn=U.querySelector('[type="submit"]')),l}function se(e){return __async(this,null,function*(){const{filterSelects:t,filterKeys:r,url:i,fetchData:a,collectionHandle:o,filterForm:c,filterFormSubmitBtn:g,rootNode:p,onEvent:I,autoSearch:v,productTags:l,cacheSeconds:z,preClearCache:T,gotoPendingBtns:U,gotoBaseCollectionBtns:_,loadingBtnClass:P,toggleOpenBtns:Ae,filteredLinks:Se,filteredTitle:be,hasCsvHeaders:Ee,triggerVerifyBtns:Ce,isFitmentWidget:we,filterKeysSortBy:ze,resetNextSelectsOnChange:oe}=me(e);if(p.__ezs_hydrated){$("Already hydrated");return}p.__ezs_hydrated=!0;const J=[()=>{p.__ezs_hydrated=!1}],ce=`/collections/${o}`,ue=z&&z>0,W=l&&l.length>0?l.reduce((s,y)=>(s[y]=!0,s),{}):null,w=new Map(Array.from({length:r.length},(s,y)=>[r[y],!ue||T?"":ne(r[y])||""]));let Y=null;function re({selectIndex:s,updateSelectValue:y=!1,forcePending:n=!1}={}){let u=[...w];u.forEach(([S,C],m)=>{const L=_e({selectedValues:u,index:m,filterTree:Y});L?.[C]||w.set(S,"");const h=m>s,A=t[m],O=L?._keys_||[],Z=Array.isArray(O)&&O.length>0;A.disabled=!Z,ue&&(C?ie(S,C,z):M(S)),(s===-1||y?!1:h?oe?!1:O.length===A.options.length-1&&O.every((E,b)=>E===A.options[b+1].value):!0)||(A.options.length=1,requestAnimationFrame(()=>{O.forEach((E,b)=>{A.options[b+1]=new Option(E,E)}),A.value=w.get(S)}))}),(v||n||s===-1)&&G({forcePending:n,preventAutosearch:s===-1,activeFiltersList:u}),I?.("SELECTION_UPDATE",{index:s,select:t[s]})}function G({forcePending:s=!1,fromCache:y=!1,preventAutosearch:n=!1}={}){var u;let S=[...w].every(([,f])=>!!f);p.setAttribute("data-ezs-selected-filters",S?"all":"partial");let C=s?null:y?R(ne("selectedItem"),"null"):ye({keys:r,activeFilters:w,filterTree:Y}),m=C instanceof le?C.value:null;Array.isArray(C)&&(m=((u=C.find(f=>{var E;const b=(E=f.value)==null?void 0:E._tag;return!!W[b]}))==null?void 0:u.value)||null);let L=m?._path,h=m?._tag,A=W?W[h]:null;p.setAttribute("data-ezs-state",m?A?"valid":"invalid":"pending"),c&&(L?(c.action=L,g&&(g.disabled=!1)):(c.removeAttribute("action"),g&&(g.disabled=!0))),m&&(I?.("SELECTION_COMPLETE",{selected:m}),p.dispatchEvent(new CustomEvent("EZSearch_Selected",{detail:{selected:m},bubbles:!1,cancelable:!1}))),Se.forEach(f=>{L?(f.setAttribute("href",m?._path),f.disabled=!0):(f.removeAttribute("href"),f.disabled=!0)});let O=m?r.map(f=>w.get(f)).join(" "):"";be.forEach(f=>{f.textContent=O}),m?ie("selectedItem",JSON.stringify(m)):M("selectedItem");let Z=L&&c&&v&&!n;Z&&(document.body.setAttribute("data-ezs-navigating",""),Z&&c.submit())}function Oe(s){var y;let n=(y=s?.target)==null?void 0:y.__ezs_index;if(typeof n!="number"){$.warn("no `__ezs_index` found");return}const u=r[n],C=t[n].value;C?w.set(u,C):w.set(u,""),oe&&[...w].forEach(([m],L)=>{L>n&&w.set(m,"")}),re({selectIndex:n})}function fe(s,y){if(!w.has(s))return;typeof y=="string"?y=y.trim():y="";let u=k(s,w);u!=null&&(w.set(s,y),re({selectIndex:u,updateSelectValue:!0,forcePending:!0}))}function X(){M("selectedItem"),r.forEach(s=>M(s))}function Ie(s){let y=s.map((n,u)=>{n.__ezs_index=u;let S=n.options[0];return S?(S.value="",S):(S=new Option("All","",!0,!0),S)});s.forEach((n,u)=>{let S=V(n,"change",Oe);J.push(S),n.options.length=1,n.options[0]=y[u]}),J.push(...Ce.map(n=>(n.disabled&&(n.disabled=!1),V(n,"click",()=>{G()}))),...U.map(n=>(n.disabled&&(n.disabled=!1),V(n,"click",()=>{n.__ezs_clear_cache&&(X(),fe(r[0],"")),G({forcePending:!0}),s[0].focus()}))),..._.map(n=>(n.disabled&&(n.disabled=!1),V(n,"click",()=>{n.disabled=!0,n.__ezs_clear_cache&&X(),c?(c.action=ce,c.submit()):window.location.href=ce}))),...Ae.map(n=>V(n,"click",()=>{p.classList.toggle("is-open")})),V(p,"click",n=>{let u=n?.target;u&&u.__ezs_loadable&&P?.forEach(S=>{u.classList.add(S)})})),re({selectIndex:-1})}function Le(){return __async(this,null,function*(){let s=ae[i];if(s)return s;if(!i){$.error("no `url` found"),p.classList.add("is-invalid"),p.style.display="none";return}let y=Q(i,a).then(n=>{if(n.length===0)return n;(Ee||r.every((h,A)=>n[0][A]===h))&&(n=n.slice(1));let u=!0,S=r.length,C=r.findIndex(h=>h.toLowerCase()==="year");C!==-1&&(n=n.reduce((h,A)=>{const O=A[C];if(!O.includes("-"))return h.push(A),h;let[f,E]=O.split("-").map(b=>Number(b)).reduce((b,B)=>(b.push(Number.isNaN(B)?null:B),b),[]);if(f&&E){for(let b=f;b<=E;b++)h.push(A.map((B,x)=>x===C?b:B));return h}return!E&&f&&h.push(A.map((b,B)=>B===C?f:b)),h},[]));let m=n.map(h=>{if(u&&h.length-1!==S&&($.error("CSV data and `filterKeys` mismatch",{filterKeys:r,line:h}),u=!1),!u)return[];let A=h[r.length];if(A.includes("$$$products$$$")){const[f]=A.split("$$$products$$$"),E="/collections/all/";if(f.startsWith(E)&&f.length>E.length)A=f,h[r.length]=A;else return[]}return h.reduce((f,E,b)=>{let B=r[b];if(B)f[B]=E;else{let x=E.split("$$")[0];typeof x=="string"&&(x=x.replace("/collection/","/collections/")),f._path=o?x.replace("/all/",`/${o}/`):x,f._tag=de(x.split("/"))}return f},{})});if(!u)throw new Error("CSV data and `filterKeys` mismatch");return ge({data:m,activeFilters:[...w],path:[],keys:r,keysSort:ze,getValue:(h,A,O)=>h[O]})});return ae[i]=y,y})}function $e(){we&&G({fromCache:!0})}function Te(){p.setAttribute("data-ezs-loaded","true")}function Fe(){return __async(this,null,function*(){return T&&X(),$e(),Le().then(s=>__async(this,null,function*(){Y=s,Ie(t)})).then(()=>{Te()})})}return Fe().then(()=>({filterTree:Y,getActiveFilters(){return[...w]},updateFilterValue:fe,clearAllCache:X,prodcutTagsLookup:W,destory(){t.forEach(s=>{s.options.length=1}),J.forEach(s=>s()),J.length=1}}))})}const ke="";window.EZSearchDefaultInstances=[];function ve(){Array.from(document.querySelectorAll('[data-ezs="search"]:not([data-ezs-auto-initialize="false"])')).forEach(t=>{document.dispatchEvent(new CustomEvent("EZSearch_Loading",{detail:t})),se({rootNode:t,onEvent:null}).then(r=>{window.EZSearchDefaultInstances.push(r),document.dispatchEvent(new CustomEvent("EZSearch_Loaded",{detail:t}))})})}return he().then(ve),{hydrate:se}});
