var __async=(L,F,O)=>new Promise((T,P)=>{var j=I=>{try{k(O.next(I))}catch($){P($)}},R=I=>{try{k(O.throw(I))}catch($){P($)}},k=I=>I.done?T(I.value):Promise.resolve(I.value).then(j,R);k((O=O.apply(L,F)).next())});(function(L,F){typeof exports=="object"&&typeof module<"u"?module.exports=F():typeof define=="function"&&define.amd?define(F):(L=typeof globalThis<"u"?globalThis:L||self,L.EZSearch=F())})(this,function(){"use strict";const L=e=>Object.prototype.toString.call(e).slice(8,-1),F=e=>L(e)==="Object";let O="[EZSearch] :: ";function T(...e){return console.log(O,...e)}T.warn=(...e)=>console.warn(O,...e),T.info=(...e)=>console.info(O,...e),T.error=(...e)=>console.error(O,...e);function P(e){let t=[],r=!1;for(let i=0,u=0,s=0;s<e.length;s++){let o=e[s],y=e[s+1];if(t[i]=t[i]||[],t[i][u]=t[i][u]||"",o=='"'&&r&&y=='"'){t[i][u]+=o,++s;continue}if(o=='"'){r=!r;continue}if(o==","&&!r){++u;continue}if(o=="\r"&&y==`
`&&!r){++i,u=0,++s;continue}if(o==`
`&&!r){++i,u=0;continue}if(o=="\r"&&!r){++i,u=0;continue}t[i][u]+=o}return t}function j(e,t){return __async(this,null,function*(){if(typeof t=="function")return t({parseCSV:P});let r=yield fetch(e);if(!r.ok)return T("Unable to fetch CSV"),null;let i=yield r.text();return P(i)})}function R(e){return typeof e=="string"&&e.split(/,\s*/),null}function k(e,t="null"){try{return JSON.parse(e||t)}catch{return typeof t=="string"?JSON.parse(t):t}}function I(e,t){let r=0,i=null;return t.forEach((u,s)=>{s===e&&i==null&&(i=r),r++}),i}const $={ATTR:{id:"data-ezs-id",filter:"data-ezs-filter",csv_url:"data-ezs-csv-url",coll_handle:"data-ezs-collection-handle",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",filtered_title:"data-ezs-filtered-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_cache:"data-ezs-clear-cache",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function oe(e){return e[e.length-1]}const ce=()=>new Promise(e=>{document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",()=>e())});function B(e,t,r,i,u=!1){return i!=null?e.addEventListener(t,r,i):e.addEventListener(t,r),u&&r(),function(){e.removeEventListener(t,r)}}function J(e,t,r=0){if(F(e)){let i=Object.keys(e);i.forEach(u=>{let s=e[u];J(s,t,r+1)}),t(e,i,r)}return Array.isArray(e)&&e.forEach(i=>{J(i,t,r)}),e}function ue({data:e,keys:t=[],path:r=[],keysSort:i=[]}){let u={};return t.forEach((s,o)=>{let y=o===t.length-1;e.forEach(p=>{if(!p)return;let A=r.reduce((w,C)=>w[C],p);if(!A)return;let l=A[s];if(typeof l=="number"&&(l=l.toString()),typeof l!="string"||l==="")return;let b=t.slice(0,o).reduce((w,C)=>w[A[C]],u);!b||(b[l]=y?p:{})})}),Object.keys(u).length>0?J(u,(s,o,y)=>{var p;if(!s._tag){const A=(p=i[y])==null?void 0:p.desc;s._keys_=o.sort((l,b)=>A?b.localeCompare(l):l.localeCompare(b))}}):u}function fe(e,t){if(t<0||t>=e.length)return!1;let r=e.slice(0,t);return Array.isArray(e[0])?r.every(([u,s])=>!!s):r.every(u=>!!u)}function de({selectedValues:e,index:t,filterTree:r}){let i=fe(e,t);if(!i)return null;if(i){const u=Array.isArray(e[0]);return e.slice(0,t).reduce((o,y)=>{if(o==null)return null;let p=u?y[1]:y;return o[p]},r)}}function he({keys:e,filterTree:t,activeFilters:r}){return e.reduce((i,u)=>{let s=r.get(u);return s&&i?.[s]||null},t)}const U=e=>`ezs_${e}`,W=e=>`${e}__expiresIn`;function x(e){const t=U(e);return window.localStorage.removeItem(t),window.localStorage.removeItem(W(t)),!0}function N(e){const t=U(e);let r=Date.now();return Number(window.localStorage.getItem(W(t))||"0")<r?(x(t),null):window.localStorage.getItem(t)}function ee(e,t,r=60*5){const i=U(e);r=Math.abs(r);let s=Date.now()+r*1e3;return window.localStorage.setItem(i,t),window.localStorage.setItem(W(i),s),!0}const{ATTR:d}=$;let te={};function ge({rootNode:e,fetchData:t,collectionHandle:r,onEvent:i,autoSearch:u=!1,productTags:s=null,cacheSeconds:o=300,hasCsvHeaders:y=!1,isFitmentWidget:p=!1,loadingBtnClass:A="btn--loading"}={}){let l={};if(!(e instanceof HTMLElement))throw new Error("rootNode must be specified");l.rootNode=e;let b=e.getAttribute(d.id)||"";if(l.filterSelects=Array.from(e.querySelectorAll(`select[${d.filter}]`)).map(h=>(h.setAttribute(d.filter,(h.getAttribute(d.filter)||"")+b),h)),l.filterKeys=l.filterSelects.map(h=>h.getAttribute(d.filter)).filter(Boolean),l.filterKeys.length<1||l.filterSelects.length!==l.filterKeys.length)throw new Error("Filter keys/selects mismatch");l.filterKeysSortBy=l.filterSelects.map(h=>{let q=h.getAttribute(d.sort_by)==="desc";return{desc:q,asc:!q}});let w=e.getAttribute(d.csv_url);if(typeof w!="string"&&!t)throw new Error("URL or `fetchData` must be specified");if(l.collectionHandle=typeof r=="string"?r:e.getAttribute(d.coll_handle)||"all",l.onEvent=typeof i=="function"?i:null,l.autoSearch=!!u||e.hasAttribute(d.auto_search),l.hasCsvHeaders=!!y||e.hasAttribute(d.csv_headers),l.isFitmentWidget=!!p||e.hasAttribute(d.fitment_widget),l.loadingBtnClass=(typeof A=="string"?A:e.getAttribute(d.loading_btn_class)||"").split(" ").filter(Boolean),l.loadingBtnClass.length===0&&(l.loadingBtnClass=null),l.filteredLinks=Array.from(e.querySelectorAll(`a[${d.filtered_link}]`)),l.filteredTitle=Array.from(e.querySelectorAll(`[${d.filtered_title}]`)),l.triggerVerifyBtns=Array.from(e.querySelectorAll(`[${d.filter_trigger_verify}]`)),l.toggleOpenBtns=Array.from(e.querySelectorAll(`[${d.toggle_open}]`)),Array.from(e.querySelectorAll(`[${d.loading_on_click}]`)).forEach(h=>{h.__ezs_loadable=!0}),l.gotoPendingBtns=Array.from(e.querySelectorAll(`[${d.goto_pending}]`)).map(h=>(h.hasAttribute(d.clear_cache)&&(h.__ezs_clear_cache=!0),h)),l.gotoBaseCollectionBtns=Array.from(e.querySelectorAll(`[${d.goto_base_collection}]`)).map(h=>(h.hasAttribute(d.clear_cache)&&(h.__ezs_clear_cache=!0),h)),l.productTags=typeof s=="string"?R(s):Array.isArray(s)?s:null,l.productTags==null&&e.hasAttribute(d.prod_tags)){let h=e.getAttribute(d.prod_tags);l.productTags=k(h)||R(h)}o=e.getAttribute(d.cache_seconds)||o,typeof o=="string"&&(o=Number(o)||300),l.cacheSeconds=typeof o=="number"?Math.max(Math.trunc(o),0):0,l.preClearCache=e.hasAttribute(d.pre_clear_cache),typeof w=="string"&&(l.url=w),typeof t=="function"&&(l.fetchData=t);let C=e.querySelector("form[data-ezs-form]");return C&&(l.filterForm=C,l.filterFormSubmitBtn=C.querySelector('[type="submit"]')),l}function re(e){return __async(this,null,function*(){const{filterSelects:t,filterKeys:r,url:i,fetchData:u,collectionHandle:s,filterForm:o,filterFormSubmitBtn:y,rootNode:p,onEvent:A,autoSearch:l,productTags:b,cacheSeconds:w,preClearCache:C,gotoPendingBtns:h,gotoBaseCollectionBtns:q,loadingBtnClass:le,toggleOpenBtns:ye,filteredLinks:me,filteredTitle:ve,hasCsvHeaders:Ae,triggerVerifyBtns:Ee,isFitmentWidget:Se,filterKeysSortBy:be}=ge(e);if(p.__ezs_hydrated){T("Already hydrated");return}p.__ezs_hydrated=!0;const Z=[()=>{p.__ezs_hydrated=!1}],ne=`/collections/${s}`,ie=w&&w>0,ae=b&&b.length>0?b.reduce((a,g)=>(a[g]=!0,a),{}):null,E=new Map(Array.from({length:r.length},(a,g)=>[r[g],!ie||C?"":N(r[g])||""]));let D=null;function G({selectIndex:a,updateSelectValue:g=!1,forcePending:n=!1}={}){let f=[...E];f.forEach(([c,S],K)=>{const m=de({selectedValues:f,index:K,filterTree:D});m?.[S]||E.set(c,"");const _=K>a,v=t[K],z=m?._keys_||[],X=Array.isArray(z)&&z.length>0;v.disabled=!X,ie&&(S?ee(c,S,w):x(c)),(a===-1||g?!1:_?z.length===v.options.length-1&&z.every((V,Y)=>V===v.options[Y+1].value):!0)||(v.options.length=1,requestAnimationFrame(()=>{z.forEach((V,Y)=>{v.options[Y+1]=new Option(V,V)}),v.value=E.get(c)}))}),(l||n||a===-1)&&H({forcePending:n,preventAutosearch:a===-1,activeFiltersList:f}),A?.("SELECTION_UPDATE",{index:a,select:t[a]})}function H({forcePending:a=!1,fromCache:g=!1,preventAutosearch:n=!1}={}){let f=[...E].every(([,_])=>!!_);p.setAttribute("data-ezs-selected-filters",f?"all":"partial");let c=a?null:g?k(N("selectedItem"),"null"):he({keys:r,activeFilters:E,filterTree:D}),S=c?._path;if(ae){let _=c?._tag,v=ae[_];p.setAttribute("data-ezs-state",c?v?"valid":"invalid":"pending")}o&&(S?(o.action=S,y&&(y.disabled=!1)):(o.removeAttribute("action"),y&&(y.disabled=!0))),c&&(A?.("SELECTION_COMPLETE",{selected:c}),p.dispatchEvent(new CustomEvent("EZSearch_Selected",{detail:{selected:c},bubbles:!1,cancelable:!1}))),me.forEach(_=>{S?(_.setAttribute("href",c?._path),_.disabled=!0):(_.removeAttribute("href"),_.disabled=!0)});let K=c?r.map(_=>E.get(_)).join(" "):"";ve.forEach(_=>{_.textContent=K}),c?ee("selectedItem",JSON.stringify(c)):x("selectedItem");let m=S&&o&&l&&!n;m&&(document.body.setAttribute("data-ezs-navigating",""),m&&o.submit())}function we(a){var g;let n=(g=a?.target)==null?void 0:g.__ezs_index;if(typeof n!="number"){T.warn("no `__ezs_index` found");return}const f=r[n],S=t[n].value;S?E.set(f,S):E.set(f,""),G({selectIndex:n})}function se(a,g){if(!E.has(a))return;typeof g=="string"?g=g.trim():g="";let f=I(a,E);f!=null&&(E.set(a,g),G({selectIndex:f,updateSelectValue:!0,forcePending:!0}))}function M(){x("selectedItem"),r.forEach(a=>x(a))}function Ce(a){let g=a.map((n,f)=>{n.__ezs_index=f;let c=n.options[0];return c?(c.value="",c):(c=new Option("All","",!0,!0),c)});a.forEach((n,f)=>{let c=B(n,"change",we);Z.push(c),n.options.length=1,n.options[0]=g[f]}),Z.push(...Ee.map(n=>(n.disabled&&(n.disabled=!1),B(n,"click",()=>{H()}))),...h.map(n=>(n.disabled&&(n.disabled=!1),B(n,"click",()=>{n.__ezs_clear_cache&&(M(),se(r[0],"")),H({forcePending:!0}),a[0].focus()}))),...q.map(n=>(n.disabled&&(n.disabled=!1),B(n,"click",()=>{n.disabled=!0,n.__ezs_clear_cache&&M(),o?(o.action=ne,o.submit()):window.location.href=ne}))),...ye.map(n=>B(n,"click",()=>{p.classList.toggle("is-open")})),B(p,"click",n=>{let f=n?.target;f&&f.__ezs_loadable&&le?.forEach(c=>{f.classList.add(c)})})),G({selectIndex:-1})}function ze(){return __async(this,null,function*(){let a=te[i];if(a)return a;let g=j(i,u).then(n=>{if(n.length===0)return n;(Ae||r.every((m,_)=>n[0][_]===m))&&(n=n.slice(1));let f=!0,c=r.length,S=n.map(m=>(f&&m.length-1!==c&&(T.error("CSV data and `filterKeys` mismatch",{filterKeys:r,line:m}),f=!1),f?m.reduce((v,z,X)=>{let Q=r[X];return Q?v[Q]=z:(v._path=s?z.replace("/all/",`/${s}/`):z,v._tag=oe(z.split("/"))),v},{}):[]));if(!f)throw new Error("CSV data and `filterKeys` mismatch");return ue({data:S,activeFilters:[...E],path:[],keys:r,keysSort:be,getValue:(m,_,v)=>m[v]})});return te[i]=g,g})}function Oe(){Se&&H({fromCache:!0})}function Te(){p.setAttribute("data-ezs-loaded","true")}function Ie(){return __async(this,null,function*(){return C&&M(),Oe(),ze().then(a=>__async(this,null,function*(){D=a,Ce(t)})).then(()=>{Te()})})}return Ie().then(()=>({filterTree:D,getActiveFilters(){return[...E]},updateFilterValue:se,clearAllCache:M,destory(){t.forEach(a=>{a.options.length=1}),Z.forEach(a=>a()),Z.length=1}}))})}var Le="";window.EZSearchDefaultInstances=[];function pe(){Array.from(document.querySelectorAll('[data-ezs="search"]:not([data-ezs-auto-initialize="false"])')).forEach(t=>{document.dispatchEvent(new CustomEvent("EZSearch_Loading",{detail:t})),re({rootNode:t,onEvent:null}).then(r=>{window.EZSearchDefaultInstances.push(r),document.dispatchEvent(new CustomEvent("EZSearch_Loaded",{detail:t}))})})}ce().then(pe);var _e={hydrate:re};return _e});
