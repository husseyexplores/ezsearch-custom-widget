var __async=(K,q,L)=>new Promise((z,D)=>{var G=T=>{try{R(L.next(T))}catch(H){D(H)}},j=T=>{try{R(L.throw(T))}catch(H){D(H)}},R=T=>T.done?z(T.value):Promise.resolve(T.value).then(G,j);R((L=L.apply(K,q)).next())});(function(K,q){typeof exports=="object"&&typeof module<"u"?module.exports=q():typeof define=="function"&&define.amd?define(q):(K=typeof globalThis<"u"?globalThis:K||self,K.EZSearch=q())})(this,function(){"use strict";const K=e=>Object.prototype.toString.call(e).slice(8,-1),q=e=>K(e)==="Object";let L="[EZSearch] :: ";function z(...e){return console.log(L,...e)}z.warn=(...e)=>console.warn(L,...e),z.info=(...e)=>console.info(L,...e),z.error=(...e)=>console.error(L,...e);function D(e){let t=[],r=!1;for(let l=0,a=0,o=0;o<e.length;o++){let u=e[o],h=e[o+1];if(t[l]=t[l]||[],t[l][a]=t[l][a]||"",u=='"'&&r&&h=='"'){t[l][a]+=u,++o;continue}if(u=='"'){r=!r;continue}if(u==","&&!r){++a;continue}if(u=="\r"&&h==`
`&&!r){++l,a=0,++o;continue}if(u==`
`&&!r){++l,a=0;continue}if(u=="\r"&&!r){++l,a=0;continue}t[l][a]+=u}return t}function G(e,t){return __async(this,null,function*(){if(typeof t=="function")return t(e).then(a=>typeof a=="string"?D(a):a);let r=yield fetch(e.replace(/\\\//g,"/"));if(!r.ok)return z("Unable to fetch CSV"),null;let l=yield r.text();return D(l)})}function j(e){return typeof e=="string"&&e.split(/,\s*/),null}function R(e,t="null"){try{return JSON.parse(e||t)}catch{return typeof t=="string"?JSON.parse(t):t}}function T(e,t){let r=0,l=null;return t.forEach((a,o)=>{o===e&&l==null&&(l=r),r++}),l}const H={ATTR:{id:"data-ezs-id",filter:"data-ezs-filter",csv_url:"data-ezs-csv-url",coll_handle:"data-ezs-collection-handle",rest_next_selects_on_change:"data-ezs-reset-next-selects-on-change",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",filtered_title:"data-ezs-filtered-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_cache:"data-ezs-clear-cache",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function fe(e){return e[e.length-1]}const de=()=>new Promise(e=>{document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",()=>e())});function Z(e,t,r,l,a=!1){return l!=null?e.addEventListener(t,r,l):e.addEventListener(t,r),a&&r(),function(){e.removeEventListener(t,r)}}function X(e,t,r=0){if(q(e)){let l=Object.keys(e);l.forEach(a=>{let o=e[a];X(o,t,r+1)}),t(e,l,r)}return Array.isArray(e)&&e.forEach(l=>{X(l,t,r)}),e}function he({data:e,keys:t=[],path:r=[],keysSort:l=[]}){let a={};return t.forEach((o,u)=>{let h=u===t.length-1;e.forEach(g=>{if(!g)return;let C=r.reduce((F,O)=>F[O],g);if(!C)return;let b=C[o];if(typeof b=="number"&&(b=b.toString()),typeof b!="string"||b==="")return;let i=t.slice(0,u).reduce((F,O)=>F[C[O]],a);i&&(i[b]=h?g:{})})}),Object.keys(a).length>0?X(a,(o,u,h)=>{var g;if(!o._tag){const C=(g=l[h])==null?void 0:g.desc;o._keys_=u.sort((b,i)=>C?i.localeCompare(b):b.localeCompare(i))}}):a}function ge(e,t){if(t<0||t>=e.length)return!1;let r=e.slice(0,t);return Array.isArray(e[0])?r.every(([a,o])=>!!o):r.every(a=>!!a)}function pe({selectedValues:e,index:t,filterTree:r}){let l=ge(e,t);if(!l)return null;if(l){const a=Array.isArray(e[0]);return e.slice(0,t).reduce((u,h)=>{if(u==null)return null;let g=a?h[1]:h;return u[g]},r)}}function _e({keys:e,filterTree:t,activeFilters:r}){return e.reduce((l,a)=>{let o=r.get(a);return o&&l?.[o]||null},t)}const Q=e=>`ezs_${e}`,N=e=>`${e}__expiresIn`;function M(e){const t=Q(e);return window.localStorage.removeItem(t),window.localStorage.removeItem(N(t)),!0}function ne(e){const t=Q(e);let r=Date.now();return Number(window.localStorage.getItem(N(t))||"0")<r?(M(t),null):window.localStorage.getItem(t)}function le(e,t,r=60*5){const l=Q(e);r=Math.abs(r);let o=Date.now()+r*1e3;return window.localStorage.setItem(l,t),window.localStorage.setItem(N(l),o),!0}const{ATTR:f}=H;let ie={};function ye({rootNode:e,fetchData:t,collectionHandle:r,onEvent:l,resetNextSelectsOnChange:a=!1,autoSearch:o=!1,productTags:u=null,cacheSeconds:h=300,hasCsvHeaders:g=!1,isFitmentWidget:C=!1,loadingBtnClass:b="btn--loading"}={}){let i={};if(!(e instanceof HTMLElement))throw new Error("rootNode must be specified");i.rootNode=e;let F=e.getAttribute(f.id)||"";if(i.filterSelects=Array.from(e.querySelectorAll(`select[${f.filter}]`)).map(p=>(p.setAttribute(f.filter,(p.getAttribute(f.filter)||"")+F),p)),i.filterKeys=i.filterSelects.map(p=>p.getAttribute(f.filter)).filter(Boolean),i.filterKeys.length<1||i.filterSelects.length!==i.filterKeys.length)throw new Error("Filter keys/selects mismatch");i.filterKeysSortBy=i.filterSelects.map(p=>{let P=p.getAttribute(f.sort_by)==="desc";return{desc:P,asc:!P}});let O=e.getAttribute(f.csv_url);if(typeof O!="string"&&!t)throw new Error("URL or `fetchData` must be specified");if(i.collectionHandle=typeof r=="string"?r:e.getAttribute(f.coll_handle)||"all",i.onEvent=typeof l=="function"?l:null,i.autoSearch=!!o||e.hasAttribute(f.auto_search),i.resetNextSelectsOnChange=!!a||e.hasAttribute(f.rest_next_selects_on_change),i.hasCsvHeaders=!!g||e.hasAttribute(f.csv_headers),i.isFitmentWidget=!!C||e.hasAttribute(f.fitment_widget),i.loadingBtnClass=(typeof b=="string"?b:e.getAttribute(f.loading_btn_class)||"").split(" ").filter(Boolean),i.loadingBtnClass.length===0&&(i.loadingBtnClass=null),i.filteredLinks=Array.from(e.querySelectorAll(`a[${f.filtered_link}]`)),i.filteredTitle=Array.from(e.querySelectorAll(`[${f.filtered_title}]`)),i.triggerVerifyBtns=Array.from(e.querySelectorAll(`[${f.filter_trigger_verify}]`)),i.toggleOpenBtns=Array.from(e.querySelectorAll(`[${f.toggle_open}]`)),Array.from(e.querySelectorAll(`[${f.loading_on_click}]`)).forEach(p=>{p.__ezs_loadable=!0}),i.gotoPendingBtns=Array.from(e.querySelectorAll(`[${f.goto_pending}]`)).map(p=>(p.hasAttribute(f.clear_cache)&&(p.__ezs_clear_cache=!0),p)),i.gotoBaseCollectionBtns=Array.from(e.querySelectorAll(`[${f.goto_base_collection}]`)).map(p=>(p.hasAttribute(f.clear_cache)&&(p.__ezs_clear_cache=!0),p)),i.productTags=typeof u=="string"?j(u):Array.isArray(u)?u:null,i.productTags==null&&e.hasAttribute(f.prod_tags)){let p=e.getAttribute(f.prod_tags);i.productTags=R(p)||j(p)}h=e.getAttribute(f.cache_seconds)||h,typeof h=="string"&&(h=Number(h)||300),i.cacheSeconds=typeof h=="number"?Math.max(Math.trunc(h),0):0,i.preClearCache=e.hasAttribute(f.pre_clear_cache),typeof O=="string"&&(i.url=O),typeof t=="function"&&(i.fetchData=t);let V=e.querySelector("form[data-ezs-form]");return V&&(i.filterForm=V,i.filterFormSubmitBtn=V.querySelector('[type="submit"]')),i}function ae(e){return __async(this,null,function*(){const{filterSelects:t,filterKeys:r,url:l,fetchData:a,collectionHandle:o,filterForm:u,filterFormSubmitBtn:h,rootNode:g,onEvent:C,autoSearch:b,productTags:i,cacheSeconds:F,preClearCache:O,gotoPendingBtns:V,gotoBaseCollectionBtns:p,loadingBtnClass:P,toggleOpenBtns:ve,filteredLinks:Ae,filteredTitle:Se,hasCsvHeaders:be,triggerVerifyBtns:Ee,isFitmentWidget:Ce,filterKeysSortBy:we,resetNextSelectsOnChange:se}=ye(e);if(g.__ezs_hydrated){z("Already hydrated");return}g.__ezs_hydrated=!0;const U=[()=>{g.__ezs_hydrated=!1}],ce=`/collections/${o}`,oe=F&&F>0,ee=i&&i.length>0?i.reduce((s,_)=>(s[_]=!0,s),{}):null,E=new Map(Array.from({length:r.length},(s,_)=>[r[_],!oe||O?"":ne(r[_])||""]));let J=null;function te({selectIndex:s,updateSelectValue:_=!1,forcePending:n=!1}={}){let d=[...E];d.forEach(([c,A],k)=>{const $=pe({selectedValues:d,index:k,filterTree:J});$?.[A]||E.set(c,"");const y=k>s,v=t[k],m=$?._keys_||[],re=Array.isArray(m)&&m.length>0;v.disabled=!re,oe&&(A?le(c,A,F):M(c)),(s===-1||_?!1:y?se?!1:m.length===v.options.length-1&&m.every((w,S)=>w===v.options[S+1].value):!0)||(v.options.length=1,requestAnimationFrame(()=>{m.forEach((w,S)=>{v.options[S+1]=new Option(w,w)}),v.value=E.get(c)}))}),(b||n||s===-1)&&W({forcePending:n,preventAutosearch:s===-1,activeFiltersList:d}),C?.("SELECTION_UPDATE",{index:s,select:t[s]})}function W({forcePending:s=!1,fromCache:_=!1,preventAutosearch:n=!1}={}){let d=[...E].every(([,m])=>!!m);g.setAttribute("data-ezs-selected-filters",d?"all":"partial");let c=s?null:_?R(ne("selectedItem"),"null"):_e({keys:r,activeFilters:E,filterTree:J}),A=c?._path,k=c?._tag,$=ee?ee[k]:null;g.setAttribute("data-ezs-state",c?$?"valid":"invalid":"pending"),u&&(A?(u.action=A,h&&(h.disabled=!1)):(u.removeAttribute("action"),h&&(h.disabled=!0))),c&&(C?.("SELECTION_COMPLETE",{selected:c}),g.dispatchEvent(new CustomEvent("EZSearch_Selected",{detail:{selected:c},bubbles:!1,cancelable:!1}))),Ae.forEach(m=>{A?(m.setAttribute("href",c?._path),m.disabled=!0):(m.removeAttribute("href"),m.disabled=!0)});let y=c?r.map(m=>E.get(m)).join(" "):"";Se.forEach(m=>{m.textContent=y}),c?le("selectedItem",JSON.stringify(c)):M("selectedItem");let v=A&&u&&b&&!n;v&&(document.body.setAttribute("data-ezs-navigating",""),v&&u.submit())}function ze(s){var _;let n=(_=s?.target)==null?void 0:_.__ezs_index;if(typeof n!="number"){z.warn("no `__ezs_index` found");return}const d=r[n],A=t[n].value;A?E.set(d,A):E.set(d,""),se&&[...E].forEach(([k],$)=>{$>n&&E.set(k,"")}),te({selectIndex:n})}function ue(s,_){if(!E.has(s))return;typeof _=="string"?_=_.trim():_="";let d=T(s,E);d!=null&&(E.set(s,_),te({selectIndex:d,updateSelectValue:!0,forcePending:!0}))}function Y(){M("selectedItem"),r.forEach(s=>M(s))}function Oe(s){let _=s.map((n,d)=>{n.__ezs_index=d;let c=n.options[0];return c?(c.value="",c):(c=new Option("All","",!0,!0),c)});s.forEach((n,d)=>{let c=Z(n,"change",ze);U.push(c),n.options.length=1,n.options[0]=_[d]}),U.push(...Ee.map(n=>(n.disabled&&(n.disabled=!1),Z(n,"click",()=>{W()}))),...V.map(n=>(n.disabled&&(n.disabled=!1),Z(n,"click",()=>{n.__ezs_clear_cache&&(Y(),ue(r[0],"")),W({forcePending:!0}),s[0].focus()}))),...p.map(n=>(n.disabled&&(n.disabled=!1),Z(n,"click",()=>{n.disabled=!0,n.__ezs_clear_cache&&Y(),u?(u.action=ce,u.submit()):window.location.href=ce}))),...ve.map(n=>Z(n,"click",()=>{g.classList.toggle("is-open")})),Z(g,"click",n=>{let d=n?.target;d&&d.__ezs_loadable&&P?.forEach(c=>{d.classList.add(c)})})),te({selectIndex:-1})}function Ie(){return __async(this,null,function*(){let s=ie[l];if(s)return s;if(!l){z.error("no `url` found"),g.classList.add("is-invalid"),g.style.display="none";return}let _=G(l,a).then(n=>{if(n.length===0)return n;(be||r.every((y,v)=>n[0][v]===y))&&(n=n.slice(1));let d=!0,c=r.length,A=r.findIndex(y=>y.toLowerCase()==="year");A!==-1&&(n=n.reduce((y,v)=>{const m=v[A];if(!m.includes("-"))return y.push(v),y;let[I,w]=m.split("-").map(S=>Number(S)).reduce((S,B)=>(S.push(Number.isNaN(B)?null:B),S),[]);if(I&&w){for(let S=I;S<=w;S++)y.push(v.map((B,x)=>x===A?S:B));return y}return!w&&I&&y.push(v.map((S,B)=>B===A?I:S)),y},[]));let k=n.map(y=>(d&&y.length-1!==c&&(z.error("CSV data and `filterKeys` mismatch",{filterKeys:r,line:y}),d=!1),d?y[r.length].includes("$$$products$$$")?[]:y.reduce((I,w,S)=>{let B=r[S];if(B)I[B]=w;else{let x=w.split("$$")[0];typeof x=="string"&&(x=x.replace("/collection/","/collections/")),I._path=o?x.replace("/all/",`/${o}/`):x,I._tag=fe(x.split("/"))}return I},{}):[]));if(!d)throw new Error("CSV data and `filterKeys` mismatch");return he({data:k,activeFilters:[...E],path:[],keys:r,keysSort:we,getValue:(y,v,m)=>y[m]})});return ie[l]=_,_})}function Le(){Ce&&W({fromCache:!0})}function Te(){g.setAttribute("data-ezs-loaded","true")}function Fe(){return __async(this,null,function*(){return O&&Y(),Le(),Ie().then(s=>__async(this,null,function*(){J=s,Oe(t)})).then(()=>{Te()})})}return Fe().then(()=>({filterTree:J,getActiveFilters(){return[...E]},updateFilterValue:ue,clearAllCache:Y,prodcutTagsLookup:ee,destory(){t.forEach(s=>{s.options.length=1}),U.forEach(s=>s()),U.length=1}}))})}const ke="";window.EZSearchDefaultInstances=[];function me(){Array.from(document.querySelectorAll('[data-ezs="search"]:not([data-ezs-auto-initialize="false"])')).forEach(t=>{document.dispatchEvent(new CustomEvent("EZSearch_Loading",{detail:t})),ae({rootNode:t,onEvent:null}).then(r=>{window.EZSearchDefaultInstances.push(r),document.dispatchEvent(new CustomEvent("EZSearch_Loaded",{detail:t}))})})}return de().then(me),{hydrate:ae}});
