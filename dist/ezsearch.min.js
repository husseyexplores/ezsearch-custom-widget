var __async=(T,F,z)=>new Promise((C,Z)=>{var G=O=>{try{B(z.next(O))}catch(D){Z(D)}},V=O=>{try{B(z.throw(O))}catch(D){Z(D)}},B=O=>O.done?C(O.value):Promise.resolve(O.value).then(G,V);B((z=z.apply(T,F)).next())});(function(T,F){typeof exports=="object"&&typeof module<"u"?module.exports=F():typeof define=="function"&&define.amd?define(F):(T=typeof globalThis<"u"?globalThis:T||self,T.EZSearch=F())})(this,function(){"use strict";const T=e=>Object.prototype.toString.call(e).slice(8,-1),F=e=>T(e)==="Object";let z="[EZSearch] :: ";function C(...e){return console.log(z,...e)}C.warn=(...e)=>console.warn(z,...e),C.info=(...e)=>console.info(z,...e),C.error=(...e)=>console.error(z,...e);function Z(e){let t=[],r=!1;for(let n=0,a=0,o=0;o<e.length;o++){let u=e[o],h=e[o+1];if(t[n]=t[n]||[],t[n][a]=t[n][a]||"",u=='"'&&r&&h=='"'){t[n][a]+=u,++o;continue}if(u=='"'){r=!r;continue}if(u==","&&!r){++a;continue}if(u=="\r"&&h==`
`&&!r){++n,a=0,++o;continue}if(u==`
`&&!r){++n,a=0;continue}if(u=="\r"&&!r){++n,a=0;continue}t[n][a]+=u}return t}function G(e,t){return __async(this,null,function*(){if(typeof t=="function")return t(e).then(a=>typeof a=="string"?Z(a):a);let r=yield fetch(e.replace(/\\\//g,"/"));if(!r.ok)return C("Unable to fetch CSV"),null;let n=yield r.text();return Z(n)})}function V(e){return typeof e=="string"&&e.split(/,\s*/),null}function B(e,t="null"){try{return JSON.parse(e||t)}catch{return typeof t=="string"?JSON.parse(t):t}}function O(e,t){let r=0,n=null;return t.forEach((a,o)=>{o===e&&n==null&&(n=r),r++}),n}const D={ATTR:{id:"data-ezs-id",filter:"data-ezs-filter",csv_url:"data-ezs-csv-url",coll_handle:"data-ezs-collection-handle",rest_next_selects_on_change:"data-ezs-reset-next-selects-on-change",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",filtered_title:"data-ezs-filtered-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_cache:"data-ezs-clear-cache",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function ue(e){return e[e.length-1]}const fe=()=>new Promise(e=>{document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",()=>e())});function x(e,t,r,n,a=!1){return n!=null?e.addEventListener(t,r,n):e.addEventListener(t,r),a&&r(),function(){e.removeEventListener(t,r)}}function X(e,t,r=0){if(F(e)){let n=Object.keys(e);n.forEach(a=>{let o=e[a];X(o,t,r+1)}),t(e,n,r)}return Array.isArray(e)&&e.forEach(n=>{X(n,t,r)}),e}function de({data:e,keys:t=[],path:r=[],keysSort:n=[]}){let a={};return t.forEach((o,u)=>{let h=u===t.length-1;e.forEach(g=>{if(!g)return;let E=r.reduce((L,w)=>L[w],g);if(!E)return;let v=E[o];if(typeof v=="number"&&(v=v.toString()),typeof v!="string"||v==="")return;let i=t.slice(0,u).reduce((L,w)=>L[E[w]],a);i&&(i[v]=h?g:{})})}),Object.keys(a).length>0?X(a,(o,u,h)=>{var g;if(!o._tag){const E=(g=n[h])==null?void 0:g.desc;o._keys_=u.sort((v,i)=>E?i.localeCompare(v):v.localeCompare(i))}}):a}function he(e,t){if(t<0||t>=e.length)return!1;let r=e.slice(0,t);return Array.isArray(e[0])?r.every(([a,o])=>!!o):r.every(a=>!!a)}function ge({selectedValues:e,index:t,filterTree:r}){let n=he(e,t);if(!n)return null;if(n){const a=Array.isArray(e[0]);return e.slice(0,t).reduce((u,h)=>{if(u==null)return null;let g=a?h[1]:h;return u[g]},r)}}function pe({keys:e,filterTree:t,activeFilters:r}){return e.reduce((n,a)=>{let o=r.get(a);return o&&n?.[o]||null},t)}const Q=e=>`ezs_${e}`,Y=e=>`${e}__expiresIn`;function H(e){const t=Q(e);return window.localStorage.removeItem(t),window.localStorage.removeItem(Y(t)),!0}function re(e){const t=Q(e);let r=Date.now();return Number(window.localStorage.getItem(Y(t))||"0")<r?(H(t),null):window.localStorage.getItem(t)}function le(e,t,r=60*5){const n=Q(e);r=Math.abs(r);let o=Date.now()+r*1e3;return window.localStorage.setItem(n,t),window.localStorage.setItem(Y(n),o),!0}const{ATTR:f}=D;let ne={};function _e({rootNode:e,fetchData:t,collectionHandle:r,onEvent:n,resetNextSelectsOnChange:a=!1,autoSearch:o=!1,productTags:u=null,cacheSeconds:h=300,hasCsvHeaders:g=!1,isFitmentWidget:E=!1,loadingBtnClass:v="btn--loading"}={}){let i={};if(!(e instanceof HTMLElement))throw new Error("rootNode must be specified");i.rootNode=e;let L=e.getAttribute(f.id)||"";if(i.filterSelects=Array.from(e.querySelectorAll(`select[${f.filter}]`)).map(p=>(p.setAttribute(f.filter,(p.getAttribute(f.filter)||"")+L),p)),i.filterKeys=i.filterSelects.map(p=>p.getAttribute(f.filter)).filter(Boolean),i.filterKeys.length<1||i.filterSelects.length!==i.filterKeys.length)throw new Error("Filter keys/selects mismatch");i.filterKeysSortBy=i.filterSelects.map(p=>{let k=p.getAttribute(f.sort_by)==="desc";return{desc:k,asc:!k}});let w=e.getAttribute(f.csv_url);if(typeof w!="string"&&!t)throw new Error("URL or `fetchData` must be specified");if(i.collectionHandle=typeof r=="string"?r:e.getAttribute(f.coll_handle)||"all",i.onEvent=typeof n=="function"?n:null,i.autoSearch=!!o||e.hasAttribute(f.auto_search),i.resetNextSelectsOnChange=!!a||e.hasAttribute(f.rest_next_selects_on_change),i.hasCsvHeaders=!!g||e.hasAttribute(f.csv_headers),i.isFitmentWidget=!!E||e.hasAttribute(f.fitment_widget),i.loadingBtnClass=(typeof v=="string"?v:e.getAttribute(f.loading_btn_class)||"").split(" ").filter(Boolean),i.loadingBtnClass.length===0&&(i.loadingBtnClass=null),i.filteredLinks=Array.from(e.querySelectorAll(`a[${f.filtered_link}]`)),i.filteredTitle=Array.from(e.querySelectorAll(`[${f.filtered_title}]`)),i.triggerVerifyBtns=Array.from(e.querySelectorAll(`[${f.filter_trigger_verify}]`)),i.toggleOpenBtns=Array.from(e.querySelectorAll(`[${f.toggle_open}]`)),Array.from(e.querySelectorAll(`[${f.loading_on_click}]`)).forEach(p=>{p.__ezs_loadable=!0}),i.gotoPendingBtns=Array.from(e.querySelectorAll(`[${f.goto_pending}]`)).map(p=>(p.hasAttribute(f.clear_cache)&&(p.__ezs_clear_cache=!0),p)),i.gotoBaseCollectionBtns=Array.from(e.querySelectorAll(`[${f.goto_base_collection}]`)).map(p=>(p.hasAttribute(f.clear_cache)&&(p.__ezs_clear_cache=!0),p)),i.productTags=typeof u=="string"?V(u):Array.isArray(u)?u:null,i.productTags==null&&e.hasAttribute(f.prod_tags)){let p=e.getAttribute(f.prod_tags);i.productTags=B(p)||V(p)}h=e.getAttribute(f.cache_seconds)||h,typeof h=="string"&&(h=Number(h)||300),i.cacheSeconds=typeof h=="number"?Math.max(Math.trunc(h),0):0,i.preClearCache=e.hasAttribute(f.pre_clear_cache),typeof w=="string"&&(i.url=w),typeof t=="function"&&(i.fetchData=t);let M=e.querySelector("form[data-ezs-form]");return M&&(i.filterForm=M,i.filterFormSubmitBtn=M.querySelector('[type="submit"]')),i}function ie(e){return __async(this,null,function*(){const{filterSelects:t,filterKeys:r,url:n,fetchData:a,collectionHandle:o,filterForm:u,filterFormSubmitBtn:h,rootNode:g,onEvent:E,autoSearch:v,productTags:i,cacheSeconds:L,preClearCache:w,gotoPendingBtns:M,gotoBaseCollectionBtns:p,loadingBtnClass:k,toggleOpenBtns:me,filteredLinks:ve,filteredTitle:Ae,hasCsvHeaders:Se,triggerVerifyBtns:Ee,isFitmentWidget:be,filterKeysSortBy:Ce,resetNextSelectsOnChange:ae}=_e(e);if(g.__ezs_hydrated){C("Already hydrated");return}g.__ezs_hydrated=!0;const j=[()=>{g.__ezs_hydrated=!1}],se=`/collections/${o}`,ce=L&&L>0,N=i&&i.length>0?i.reduce((s,_)=>(s[_]=!0,s),{}):null,A=new Map(Array.from({length:r.length},(s,_)=>[r[_],!ce||w?"":re(r[_])||""]));let U=null;function ee({selectIndex:s,updateSelectValue:_=!1,forcePending:l=!1}={}){let d=[...A];d.forEach(([c,S],I)=>{const y=ge({selectedValues:d,index:I,filterTree:U});y?.[S]||A.set(c,"");const $=I>s,b=t[I],m=y?._keys_||[],q=Array.isArray(m)&&m.length>0;b.disabled=!q,ce&&(S?le(c,S,L):H(c)),(s===-1||_?!1:$?ae?!1:m.length===b.options.length-1&&m.every((K,P)=>K===b.options[P+1].value):!0)||(b.options.length=1,requestAnimationFrame(()=>{m.forEach((K,P)=>{b.options[P+1]=new Option(K,K)}),b.value=A.get(c)}))}),(v||l||s===-1)&&J({forcePending:l,preventAutosearch:s===-1,activeFiltersList:d}),E?.("SELECTION_UPDATE",{index:s,select:t[s]})}function J({forcePending:s=!1,fromCache:_=!1,preventAutosearch:l=!1}={}){let d=[...A].every(([,m])=>!!m);g.setAttribute("data-ezs-selected-filters",d?"all":"partial");let c=s?null:_?B(re("selectedItem"),"null"):pe({keys:r,activeFilters:A,filterTree:U}),S=c?._path,I=c?._tag,y=N?N[I]:null;g.setAttribute("data-ezs-state",c?y?"valid":"invalid":"pending"),u&&(S?(u.action=S,h&&(h.disabled=!1)):(u.removeAttribute("action"),h&&(h.disabled=!0))),c&&(E?.("SELECTION_COMPLETE",{selected:c}),g.dispatchEvent(new CustomEvent("EZSearch_Selected",{detail:{selected:c},bubbles:!1,cancelable:!1}))),ve.forEach(m=>{S?(m.setAttribute("href",c?._path),m.disabled=!0):(m.removeAttribute("href"),m.disabled=!0)});let $=c?r.map(m=>A.get(m)).join(" "):"";Ae.forEach(m=>{m.textContent=$}),c?le("selectedItem",JSON.stringify(c)):H("selectedItem");let b=S&&u&&v&&!l;b&&(document.body.setAttribute("data-ezs-navigating",""),b&&u.submit())}function we(s){var _;let l=(_=s?.target)==null?void 0:_.__ezs_index;if(typeof l!="number"){C.warn("no `__ezs_index` found");return}const d=r[l],S=t[l].value;S?A.set(d,S):A.set(d,""),ae&&[...A].forEach(([I],y)=>{y>l&&A.set(I,"")}),ee({selectIndex:l})}function oe(s,_){if(!A.has(s))return;typeof _=="string"?_=_.trim():_="";let d=O(s,A);d!=null&&(A.set(s,_),ee({selectIndex:d,updateSelectValue:!0,forcePending:!0}))}function W(){H("selectedItem"),r.forEach(s=>H(s))}function ze(s){let _=s.map((l,d)=>{l.__ezs_index=d;let c=l.options[0];return c?(c.value="",c):(c=new Option("All","",!0,!0),c)});s.forEach((l,d)=>{let c=x(l,"change",we);j.push(c),l.options.length=1,l.options[0]=_[d]}),j.push(...Ee.map(l=>(l.disabled&&(l.disabled=!1),x(l,"click",()=>{J()}))),...M.map(l=>(l.disabled&&(l.disabled=!1),x(l,"click",()=>{l.__ezs_clear_cache&&(W(),oe(r[0],"")),J({forcePending:!0}),s[0].focus()}))),...p.map(l=>(l.disabled&&(l.disabled=!1),x(l,"click",()=>{l.disabled=!0,l.__ezs_clear_cache&&W(),u?(u.action=se,u.submit()):window.location.href=se}))),...me.map(l=>x(l,"click",()=>{g.classList.toggle("is-open")})),x(g,"click",l=>{let d=l?.target;d&&d.__ezs_loadable&&k?.forEach(c=>{d.classList.add(c)})})),ee({selectIndex:-1})}function Oe(){return __async(this,null,function*(){let s=ne[n];if(s)return s;if(!n){C.error("no `url` found"),g.classList.add("is-invalid"),g.style.display="none";return}let _=G(n,a).then(l=>{if(l.length===0)return l;(Se||r.every((y,$)=>l[0][$]===y))&&(l=l.slice(1));let d=!0,c=r.length,S=l.map(y=>(d&&y.length-1!==c&&(C.error("CSV data and `filterKeys` mismatch",{filterKeys:r,line:y}),d=!1),d?y[r.length].includes("$$$products$$$")?[]:y.reduce((q,te,K)=>{let P=r[K];if(P)q[P]=te;else{let R=te.split("$$")[0];typeof R=="string"&&(R=R.replace("/collection/","/collections/")),q._path=o?R.replace("/all/",`/${o}/`):R,q._tag=ue(R.split("/"))}return q},{}):[]));if(!d)throw new Error("CSV data and `filterKeys` mismatch");return de({data:S,activeFilters:[...A],path:[],keys:r,keysSort:Ce,getValue:(y,$,b)=>y[b]})});return ne[n]=_,_})}function Le(){be&&J({fromCache:!0})}function Ie(){g.setAttribute("data-ezs-loaded","true")}function Te(){return __async(this,null,function*(){return w&&W(),Le(),Oe().then(s=>__async(this,null,function*(){U=s,ze(t)})).then(()=>{Ie()})})}return Te().then(()=>({filterTree:U,getActiveFilters(){return[...A]},updateFilterValue:oe,clearAllCache:W,prodcutTagsLookup:N,destory(){t.forEach(s=>{s.options.length=1}),j.forEach(s=>s()),j.length=1}}))})}const Fe="";window.EZSearchDefaultInstances=[];function ye(){Array.from(document.querySelectorAll('[data-ezs="search"]:not([data-ezs-auto-initialize="false"])')).forEach(t=>{document.dispatchEvent(new CustomEvent("EZSearch_Loading",{detail:t})),ie({rootNode:t,onEvent:null}).then(r=>{window.EZSearchDefaultInstances.push(r),document.dispatchEvent(new CustomEvent("EZSearch_Loaded",{detail:t}))})})}return fe().then(ye),{hydrate:ie}});
