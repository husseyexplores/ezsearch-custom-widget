var __async=(C,z,A)=>new Promise((b,T)=>{var Z=I=>{try{F(A.next(I))}catch(L){T(L)}},R=I=>{try{F(A.throw(I))}catch(L){T(L)}},F=I=>I.done?b(I.value):Promise.resolve(I.value).then(Z,R);F((A=A.apply(C,z)).next())});(function(C,z){typeof exports=="object"&&typeof module<"u"?module.exports=z():typeof define=="function"&&define.amd?define(z):(C=typeof globalThis<"u"?globalThis:C||self,C.EZSearch=z())})(this,function(){"use strict";const C=e=>Object.prototype.toString.call(e).slice(8,-1),z=e=>C(e)==="Object";let A="[EZSearch] :: ";function b(...e){return console.log(A,...e)}b.warn=(...e)=>console.warn(A,...e),b.info=(...e)=>console.info(A,...e),b.error=(...e)=>console.error(A,...e);function T(e){let t=[],r=!1;for(let n=0,l=0,o=0;o<e.length;o++){let f=e[o],p=e[o+1];if(t[n]=t[n]||[],t[n][l]=t[n][l]||"",f=='"'&&r&&p=='"'){t[n][l]+=f,++o;continue}if(f=='"'){r=!r;continue}if(f==","&&!r){++l;continue}if(f=="\r"&&p==`
`&&!r){++n,l=0,++o;continue}if(f==`
`&&!r){++n,l=0;continue}if(f=="\r"&&!r){++n,l=0;continue}t[n][l]+=f}return t}function Z(e,t){return __async(this,null,function*(){if(typeof t=="function")return t({parseCSV:T});let r=yield fetch(e);if(!r.ok)return b("Unable to fetch CSV"),null;let n=yield r.text();return T(n)})}function R(e){return typeof e=="string"&&e.split(/,\s*/),null}function F(e,t="null"){try{return JSON.parse(e||t)}catch{return typeof t=="string"?JSON.parse(t):t}}function I(e,t){let r=0,n=null;return t.forEach((l,o)=>{o===e&&n==null&&(n=r),r++}),n}const L={ATTR:{id:"data-ezs-id",filter:"data-ezs-filter",csv_url:"data-ezs-csv-url",coll_handle:"data-ezs-collection-handle",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",filtered_title:"data-ezs-filtered-title",filter_trigger_verify:"data-ezs-trigger-verify",filter_reset:"data-ezs-filter-reset",prod_tags:"data-ezs-product-tags"}};function Y(e){return e[e.length-1]}const N=()=>new Promise(e=>{document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",()=>e())});function D(e,t,r,n={}){const l=n.listener||void 0;return e.addEventListener(t,r,l),typeof n.runImmediately!="boolean"&&(n.runImmediately=!0),n.runImmediately&&r(),function(){e.removeEventListener(t,r)}}function k(e,t){if(z(e)){let r=Object.keys(e);r.forEach(n=>{let l=e[n];k(l,t)}),t(e,r)}return Array.isArray(e)&&e.forEach(r=>{k(r,t)}),e}function ee({data:e,keys:t=[],path:r=[]}){let n={};return t.forEach((l,o)=>{let f=o===t.length-1;e.forEach(p=>{if(!p)return;let i=r.reduce((E,d)=>E[d],p);if(!i)return;let g=i[l];if(typeof g=="number"&&(g=g.toString()),typeof g!="string")return;let O=t.slice(0,o).reduce((E,d)=>E[i[d]],n);!O||(O[g]=f?p:{})})}),Object.keys(n).length>0?k(n,(l,o)=>{l._tag||(l._keys_=o.sort((f,p)=>f.localeCompare(p)))}):n}function te(e,t){if(t<0||t>=e.length)return!1;let r=e.slice(0,t);return Array.isArray(e[0])?r.every(([l,o])=>!!o):r.every(l=>!!l)}function re({selectedValues:e,index:t,filterTree:r}){let n=te(e,t);if(!n)return null;if(n){const l=Array.isArray(e[0]);return e.slice(0,t).reduce((f,p)=>{let i=l?p[1]:p;return f[i]},r)}}function ne({keys:e,filterTree:t,activeFilters:r}){return e.reduce((n,l)=>{let o=r.get(l);return o&&n?.[o]||null},t)}function U(e){return window.localStorage.removeItem(e),window.localStorage.removeItem(e+"_expiresIn"),!0}function ie(e){let t=Date.now();return Number(window.localStorage.getItem(e+"_expiresIn")||"0")<t?(U(e),null):window.localStorage.getItem(e)}function le(e,t,r=60*5){r=Math.abs(r);let l=Date.now()+r*1e3;return window.localStorage.setItem(e,t),window.localStorage.setItem(e+"_expiresIn",l),!0}const{ATTR:m}=L;let J={};function se({rootNode:e,fetchData:t,collectionHandle:r,onEvent:n,autoSearch:l=!1,productTags:o=null,cacheSeconds:f,hasCsvHeaders:p=!1}={}){let i={};if(!(e instanceof HTMLElement))throw new Error("rootNode must be specified");i.rootNode=e;let g=e.getAttribute(m.id)||"";if(i.filterSelects=Array.from(e.querySelectorAll(`select[${m.filter}]`)).map(d=>(d.setAttribute(m.filter,(d.getAttribute(m.filter)||"")+g),d)),i.filterKeys=i.filterSelects.map(d=>d.getAttribute(m.filter)).filter(Boolean),i.filterKeys.length<1||i.filterSelects.length!==i.filterKeys.length)throw new Error("Filter keys/selects mismatch");let O=e.getAttribute(m.csv_url);if(typeof O!="string"&&!t)throw new Error("URL or `fetchData` must be specified");if(i.collectionHandle=typeof r=="string"?r:e.getAttribute(m.coll_handle)||"all",i.onEvent=typeof n=="function"?n:null,i.autoSearch=!!l||e.hasAttribute(m.auto_search),i.hasCsvHeaders=!!p||e.hasAttribute(m.csv_headers),i.filteredLinks=Array.from(e.querySelectorAll(`a[${m.filtered_link}]`)),i.filteredTitle=Array.from(e.querySelectorAll(`[${m.filtered_title}]`)),i.triggerVerifyBtns=Array.from(e.querySelectorAll(`[${m.filter_trigger_verify}]`)),i.resetFilterBtns=Array.from(e.querySelectorAll(`[${m.filter_reset}]`)).map(d=>(d.getAttribute(m.filter_reset)==="hard"&&(d.__ezs_hard_reset=!0),d)),i.productTags=typeof o=="string"?R(o):Array.isArray(o)?o:null,i.productTags==null&&e.hasAttribute(m.prod_tags)){let d=e.getAttribute(m.prod_tags);i.productTags=F(d)||R(d)}f=typeof f=="number"?Math.trunc(f):0,i.cacheSeconds=f>0?f:null,typeof O=="string"&&(i.url=O),typeof t=="function"&&(i.fetchData=t);let E=e.querySelector("form[data-ezs-form]");return E&&(i.filterForm=E,i.filterFormSubmitBtn=E.querySelector('[type="submit"]')),i}function G(e){return __async(this,null,function*(){const{filterSelects:t,filterKeys:r,url:n,fetchData:l,collectionHandle:o,filterForm:f,filterFormSubmitBtn:p,rootNode:i,onEvent:g,autoSearch:O,productTags:E,cacheSeconds:d,resetFilterBtns:X,filteredLinks:oe,filteredTitle:fe,hasCsvHeaders:ce,triggerVerifyBtns:de}=se(e);if(i.__ezs_hydrated){b("Already hydrated");return}i.__ezs_hydrated=!0;const q=[()=>{i.__ezs_hydrated=!1}],Q=d&&d>0,W=E&&E.length>0?E.reduce((a,s)=>(a[s]=!0,a),{}):null,_=new Map(Array.from({length:r.length},(a,s)=>[r[s],Q&&ie(r[s])||""]));let P=null;function B({selectIndex:a,updateSelectValue:s=!1,forcePending:u=!1}={}){let h=[..._];h.forEach(([c,S],H)=>{const v=re({selectedValues:h,index:H,filterTree:P});v?.[S]||_.set(c,"");const x=H>a,y=t[H],w=v?._keys_||[],V=Array.isArray(w)&&w.length>0;y.disabled=!V,Q&&(S?le(c,S,d):U(c)),(a===-1||s?!1:x?w.length===y.options.length-1&&w.every((K,j)=>K===y.options[j+1].value):!0)||(y.options.length=1,requestAnimationFrame(()=>{w.forEach((K,j)=>{y.options[j+1]=new Option(K,K)}),y.value=_.get(c)}))}),(O||u)&&M(u),g?.("SELECTION_UPDATE",{index:a,select:t[a]})}function M({forcePending:a=!1}={}){let s=a?null:ne({keys:r,activeFilters:_,filterTree:P}),u=s?._path;if(W){let c=s?._tag,S=W[c];i.setAttribute("data-ezs-state",s?S?"valid":"invalid":"pending")}f&&(u?(f.action=u,p&&(p.disabled=!1)):(f.removeAttribute("action"),p&&(p.disabled=!0))),s&&(g?.("SELECTION_COMPLETE",{selected:s}),i.dispatchEvent(new CustomEvent("EZSearch_Selected",{detail:{selected:s},bubbles:!1,cancelable:!1}))),oe.forEach(c=>{u?(c.setAttribute("href",s?._path),c.disabled=!0):(c.removeAttribute("href"),c.disabled=!0)});let h=s?r.map(c=>_.get(c)).join(" "):"";fe.forEach(c=>{c.textContent=h}),f&&O&&f.submit()}function he(a){var s;let u=(s=a?.target)==null?void 0:s.__ezs_index;if(typeof u!="number"){b.warn("no `__ezs_index` found");return}const h=r[u],S=t[u].value;S?_.set(h,S):_.set(h,""),B({selectIndex:u})}function pe(a,s){if(!_.has(a))return;typeof s=="string"?s=s.trim():s="";let h=I(a,_);h!=null&&(_.set(a,s),B({selectIndex:h,updateSelectValue:!0,forcePending:!0}))}function me(a){let s=a.map((u,h)=>{u.__ezs_index=h;let c=u.options[0];return c?(c.value="",c):(c=new Option("All","",!0,!0),c)});a.forEach((u,h)=>{let c=D(u,"change",he,{runImmediately:!1});q.push(c),u.options.length=1,u.options[0]=s[h]}),q.push(...de.map(u=>D(u,"click",()=>{M()},{runImmediately:!1})),...X.map(u=>D(u,"click",()=>{M({forcePending:!0}),a[0].focus()},{runImmediately:!1}))),B({selectIndex:-1})}function ye(){return __async(this,null,function*(){let a=J[n];if(a)return a;let s=Z(n,l).then(u=>{if(u.length===0)return u;(ce||r.every((v,x)=>u[0][x]===v))&&(u=u.slice(1));let h=!0,c=r.length,S=u.map(v=>(h&&v.length-1!==c&&(b.error("CSV data and `filterKeys` mismatch",{filterKeys:r,line:v}),h=!1),h?v.reduce((y,w,V)=>{let $=r[V];return $?y[$]=w:(y._path=o?w.replace("/all/",`/${o}/`):w,y._tag=Y(w.split("/"))),y},{}):[]));if(!h)throw new Error("CSV data and `filterKeys` mismatch");return ee({data:S,activeFilters:[..._],path:[],keys:r,getValue:(v,x,y)=>v[y]})});return J[n]=s,s})}function ge(){i.setAttribute("data-ezs-loaded","true")}function _e(){return __async(this,null,function*(){return ye().then(a=>{P=a,me(t)}).then(()=>{ge()})})}return _e().then(()=>({filterTree:P,getActiveFilters(){return[..._]},updateFilterValue:pe,destory(){t.forEach(a=>{a.options.length=1}),q.forEach(a=>a()),q.length=1}}))})}var ve="";window.EZSearchDefaultInstances=[];function ae(){Array.from(document.querySelectorAll('[data-ezs="search"]:not([data-ezs-auto-initialize="false"])')).forEach(t=>{document.dispatchEvent(new CustomEvent("EZSearch_Loading",{detail:t})),G({rootNode:t,autoSearch:!1,cacheSeconds:300,hasCsvHeaders:!1,onEvent:(r,n)=>{var l;console.log(r,n,(l=n?.select)==null?void 0:l.value)}}).then(r=>{window.EZSearchDefaultInstances.push(r),document.dispatchEvent(new CustomEvent("EZSearch_Loaded",{detail:t}))})})}N().then(ae);var ue={hydrate:G};return ue});
