var __async=(F,k,z)=>new Promise((O,K)=>{var J=T=>{try{x(z.next(T))}catch(P){K(P)}},Z=T=>{try{x(z.throw(T))}catch(P){K(P)}},x=T=>T.done?O(T.value):Promise.resolve(T.value).then(J,Z);x((z=z.apply(F,k)).next())});(function(F,k){typeof exports=="object"&&typeof module<"u"?module.exports=k():typeof define=="function"&&define.amd?define(k):(F=typeof globalThis<"u"?globalThis:F||self,F.EZSearch=k())})(this,function(){"use strict";const F=e=>Object.prototype.toString.call(e).slice(8,-1),k=e=>F(e)==="Object";let z="[EZSearch] :: ";function O(...e){return console.log(z,...e)}O.warn=(...e)=>console.warn(z,...e),O.info=(...e)=>console.info(z,...e),O.error=(...e)=>console.error(z,...e);function K(e){let t=[],r=!1;for(let i=0,c=0,o=0;o<e.length;o++){let u=e[o],h=e[o+1];if(t[i]=t[i]||[],t[i][c]=t[i][c]||"",u=='"'&&r&&h=='"'){t[i][c]+=u,++o;continue}if(u=='"'){r=!r;continue}if(u==","&&!r){++c;continue}if(u=="\r"&&h==`
`&&!r){++i,c=0,++o;continue}if(u==`
`&&!r){++i,c=0;continue}if(u=="\r"&&!r){++i,c=0;continue}t[i][c]+=u}return t}function J(e,t){return __async(this,null,function*(){if(typeof t=="function")return t({parseCSV:K});let r=yield fetch(e);if(!r.ok)return O("Unable to fetch CSV"),null;let i=yield r.text();return K(i)})}function Z(e){return typeof e=="string"&&e.split(/,\s*/),null}function x(e,t="null"){try{return JSON.parse(e||t)}catch{return typeof t=="string"?JSON.parse(t):t}}function T(e,t){let r=0,i=null;return t.forEach((c,o)=>{o===e&&i==null&&(i=r),r++}),i}const P={ATTR:{id:"data-ezs-id",filter:"data-ezs-filter",csv_url:"data-ezs-csv-url",coll_handle:"data-ezs-collection-handle",rest_next_selects_on_change:"data-ezs-reset-next-selects-on-change",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",filtered_title:"data-ezs-filtered-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_cache:"data-ezs-clear-cache",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function oe(e){return e[e.length-1]}const ue=()=>new Promise(e=>{document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",()=>e())});function q(e,t,r,i,c=!1){return i!=null?e.addEventListener(t,r,i):e.addEventListener(t,r),c&&r(),function(){e.removeEventListener(t,r)}}function U(e,t,r=0){if(k(e)){let i=Object.keys(e);i.forEach(c=>{let o=e[c];U(o,t,r+1)}),t(e,i,r)}return Array.isArray(e)&&e.forEach(i=>{U(i,t,r)}),e}function fe({data:e,keys:t=[],path:r=[],keysSort:i=[]}){let c={};return t.forEach((o,u)=>{let h=u===t.length-1;e.forEach(p=>{if(!p)return;let b=r.reduce((I,C)=>I[C],p);if(!b)return;let v=b[o];if(typeof v=="number"&&(v=v.toString()),typeof v!="string"||v==="")return;let n=t.slice(0,u).reduce((I,C)=>I[b[C]],c);!n||(n[v]=h?p:{})})}),Object.keys(c).length>0?U(c,(o,u,h)=>{var p;if(!o._tag){const b=(p=i[h])==null?void 0:p.desc;o._keys_=u.sort((v,n)=>b?n.localeCompare(v):v.localeCompare(n))}}):c}function de(e,t){if(t<0||t>=e.length)return!1;let r=e.slice(0,t);return Array.isArray(e[0])?r.every(([c,o])=>!!o):r.every(c=>!!c)}function he({selectedValues:e,index:t,filterTree:r}){let i=de(e,t);if(!i)return null;if(i){const c=Array.isArray(e[0]);return e.slice(0,t).reduce((u,h)=>{if(u==null)return null;let p=c?h[1]:h;return u[p]},r)}}function ge({keys:e,filterTree:t,activeFilters:r}){return e.reduce((i,c)=>{let o=r.get(c);return o&&i?.[o]||null},t)}const W=e=>`ezs_${e}`,G=e=>`${e}__expiresIn`;function $(e){const t=W(e);return window.localStorage.removeItem(t),window.localStorage.removeItem(G(t)),!0}function te(e){const t=W(e);let r=Date.now();return Number(window.localStorage.getItem(G(t))||"0")<r?($(t),null):window.localStorage.getItem(t)}function re(e,t,r=60*5){const i=W(e);r=Math.abs(r);let o=Date.now()+r*1e3;return window.localStorage.setItem(i,t),window.localStorage.setItem(G(i),o),!0}const{ATTR:f}=P;let le={};function _e({rootNode:e,fetchData:t,collectionHandle:r,onEvent:i,resetNextSelectsOnChange:c=!1,autoSearch:o=!1,productTags:u=null,cacheSeconds:h=300,hasCsvHeaders:p=!1,isFitmentWidget:b=!1,loadingBtnClass:v="btn--loading"}={}){let n={};if(!(e instanceof HTMLElement))throw new Error("rootNode must be specified");n.rootNode=e;let I=e.getAttribute(f.id)||"";if(n.filterSelects=Array.from(e.querySelectorAll(`select[${f.filter}]`)).map(g=>(g.setAttribute(f.filter,(g.getAttribute(f.filter)||"")+I),g)),n.filterKeys=n.filterSelects.map(g=>g.getAttribute(f.filter)).filter(Boolean),n.filterKeys.length<1||n.filterSelects.length!==n.filterKeys.length)throw new Error("Filter keys/selects mismatch");n.filterKeysSortBy=n.filterSelects.map(g=>{let B=g.getAttribute(f.sort_by)==="desc";return{desc:B,asc:!B}});let C=e.getAttribute(f.csv_url);if(typeof C!="string"&&!t)throw new Error("URL or `fetchData` must be specified");if(n.collectionHandle=typeof r=="string"?r:e.getAttribute(f.coll_handle)||"all",n.onEvent=typeof i=="function"?i:null,n.autoSearch=!!o||e.hasAttribute(f.auto_search),n.resetNextSelectsOnChange=!!c||e.hasAttribute(f.rest_next_selects_on_change),n.hasCsvHeaders=!!p||e.hasAttribute(f.csv_headers),n.isFitmentWidget=!!b||e.hasAttribute(f.fitment_widget),n.loadingBtnClass=(typeof v=="string"?v:e.getAttribute(f.loading_btn_class)||"").split(" ").filter(Boolean),n.loadingBtnClass.length===0&&(n.loadingBtnClass=null),n.filteredLinks=Array.from(e.querySelectorAll(`a[${f.filtered_link}]`)),n.filteredTitle=Array.from(e.querySelectorAll(`[${f.filtered_title}]`)),n.triggerVerifyBtns=Array.from(e.querySelectorAll(`[${f.filter_trigger_verify}]`)),n.toggleOpenBtns=Array.from(e.querySelectorAll(`[${f.toggle_open}]`)),Array.from(e.querySelectorAll(`[${f.loading_on_click}]`)).forEach(g=>{g.__ezs_loadable=!0}),n.gotoPendingBtns=Array.from(e.querySelectorAll(`[${f.goto_pending}]`)).map(g=>(g.hasAttribute(f.clear_cache)&&(g.__ezs_clear_cache=!0),g)),n.gotoBaseCollectionBtns=Array.from(e.querySelectorAll(`[${f.goto_base_collection}]`)).map(g=>(g.hasAttribute(f.clear_cache)&&(g.__ezs_clear_cache=!0),g)),n.productTags=typeof u=="string"?Z(u):Array.isArray(u)?u:null,n.productTags==null&&e.hasAttribute(f.prod_tags)){let g=e.getAttribute(f.prod_tags);n.productTags=x(g)||Z(g)}h=e.getAttribute(f.cache_seconds)||h,typeof h=="string"&&(h=Number(h)||300),n.cacheSeconds=typeof h=="number"?Math.max(Math.trunc(h),0):0,n.preClearCache=e.hasAttribute(f.pre_clear_cache),typeof C=="string"&&(n.url=C),typeof t=="function"&&(n.fetchData=t);let R=e.querySelector("form[data-ezs-form]");return R&&(n.filterForm=R,n.filterFormSubmitBtn=R.querySelector('[type="submit"]')),n}function ne(e){return __async(this,null,function*(){const{filterSelects:t,filterKeys:r,url:i,fetchData:c,collectionHandle:o,filterForm:u,filterFormSubmitBtn:h,rootNode:p,onEvent:b,autoSearch:v,productTags:n,cacheSeconds:I,preClearCache:C,gotoPendingBtns:R,gotoBaseCollectionBtns:g,loadingBtnClass:B,toggleOpenBtns:me,filteredLinks:ve,filteredTitle:Ae,hasCsvHeaders:Se,triggerVerifyBtns:Ee,isFitmentWidget:be,filterKeysSortBy:Ce,resetNextSelectsOnChange:ie}=_e(e);if(p.__ezs_hydrated){O("Already hydrated");return}p.__ezs_hydrated=!0;const D=[()=>{p.__ezs_hydrated=!1}],ae=`/collections/${o}`,se=I&&I>0,X=n&&n.length>0?n.reduce((a,_)=>(a[_]=!0,a),{}):null,A=new Map(Array.from({length:r.length},(a,_)=>[r[_],!se||C?"":te(r[_])||""]));let H=null;function Q({selectIndex:a,updateSelectValue:_=!1,forcePending:l=!1}={}){let d=[...A];d.forEach(([s,E],L)=>{const m=he({selectedValues:d,index:L,filterTree:H});m?.[E]||A.set(s,"");const y=L>a,S=t[L],w=m?._keys_||[],Y=Array.isArray(w)&&w.length>0;S.disabled=!Y,se&&(E?re(s,E,I):$(s)),(a===-1||_?!1:y?ie?!1:w.length===S.options.length-1&&w.every((j,ee)=>j===S.options[ee+1].value):!0)||(S.options.length=1,requestAnimationFrame(()=>{w.forEach((j,ee)=>{S.options[ee+1]=new Option(j,j)}),S.value=A.get(s)}))}),(v||l||a===-1)&&M({forcePending:l,preventAutosearch:a===-1,activeFiltersList:d}),b?.("SELECTION_UPDATE",{index:a,select:t[a]})}function M({forcePending:a=!1,fromCache:_=!1,preventAutosearch:l=!1}={}){let d=[...A].every(([,y])=>!!y);p.setAttribute("data-ezs-selected-filters",d?"all":"partial");let s=a?null:_?x(te("selectedItem"),"null"):ge({keys:r,activeFilters:A,filterTree:H}),E=s?._path;if(X){let y=s?._tag,S=X[y];p.setAttribute("data-ezs-state",s?S?"valid":"invalid":"pending")}u&&(E?(u.action=E,h&&(h.disabled=!1)):(u.removeAttribute("action"),h&&(h.disabled=!0))),s&&(b?.("SELECTION_COMPLETE",{selected:s}),p.dispatchEvent(new CustomEvent("EZSearch_Selected",{detail:{selected:s},bubbles:!1,cancelable:!1}))),ve.forEach(y=>{E?(y.setAttribute("href",s?._path),y.disabled=!0):(y.removeAttribute("href"),y.disabled=!0)});let L=s?r.map(y=>A.get(y)).join(" "):"";Ae.forEach(y=>{y.textContent=L}),s?re("selectedItem",JSON.stringify(s)):$("selectedItem");let m=E&&u&&v&&!l;m&&(document.body.setAttribute("data-ezs-navigating",""),m&&u.submit())}function we(a){var _;let l=(_=a?.target)==null?void 0:_.__ezs_index;if(typeof l!="number"){O.warn("no `__ezs_index` found");return}const d=r[l],E=t[l].value;E?A.set(d,E):A.set(d,""),ie&&[...A].forEach(([L],m)=>{m>l&&A.set(L,"")}),Q({selectIndex:l})}function ce(a,_){if(!A.has(a))return;typeof _=="string"?_=_.trim():_="";let d=T(a,A);d!=null&&(A.set(a,_),Q({selectIndex:d,updateSelectValue:!0,forcePending:!0}))}function V(){$("selectedItem"),r.forEach(a=>$(a))}function ze(a){let _=a.map((l,d)=>{l.__ezs_index=d;let s=l.options[0];return s?(s.value="",s):(s=new Option("All","",!0,!0),s)});a.forEach((l,d)=>{let s=q(l,"change",we);D.push(s),l.options.length=1,l.options[0]=_[d]}),D.push(...Ee.map(l=>(l.disabled&&(l.disabled=!1),q(l,"click",()=>{M()}))),...R.map(l=>(l.disabled&&(l.disabled=!1),q(l,"click",()=>{l.__ezs_clear_cache&&(V(),ce(r[0],"")),M({forcePending:!0}),a[0].focus()}))),...g.map(l=>(l.disabled&&(l.disabled=!1),q(l,"click",()=>{l.disabled=!0,l.__ezs_clear_cache&&V(),u?(u.action=ae,u.submit()):window.location.href=ae}))),...me.map(l=>q(l,"click",()=>{p.classList.toggle("is-open")})),q(p,"click",l=>{let d=l?.target;d&&d.__ezs_loadable&&B?.forEach(s=>{d.classList.add(s)})})),Q({selectIndex:-1})}function Oe(){return __async(this,null,function*(){let a=le[i];if(a)return a;let _=J(i,c).then(l=>{if(l.length===0)return l;(Se||r.every((m,y)=>l[0][y]===m))&&(l=l.slice(1));let d=!0,s=r.length,E=l.map(m=>(d&&m.length-1!==s&&(O.error("CSV data and `filterKeys` mismatch",{filterKeys:r,line:m}),d=!1),d?m.reduce((S,w,Y)=>{let N=r[Y];return N?S[N]=w:(S._path=o?w.replace("/all/",`/${o}/`):w,S._tag=oe(w.split("/"))),S},{}):[]));if(!d)throw new Error("CSV data and `filterKeys` mismatch");return fe({data:E,activeFilters:[...A],path:[],keys:r,keysSort:Ce,getValue:(m,y,S)=>m[S]})});return le[i]=_,_})}function Te(){be&&M({fromCache:!0})}function Ie(){p.setAttribute("data-ezs-loaded","true")}function Le(){return __async(this,null,function*(){return C&&V(),Te(),Oe().then(a=>__async(this,null,function*(){H=a,ze(t)})).then(()=>{Ie()})})}return Le().then(()=>({filterTree:H,getActiveFilters(){return[...A]},updateFilterValue:ce,clearAllCache:V,prodcutTagsLookup:X,destory(){t.forEach(a=>{a.options.length=1}),D.forEach(a=>a()),D.length=1}}))})}var Fe="";window.EZSearchDefaultInstances=[];function pe(){Array.from(document.querySelectorAll('[data-ezs="search"]:not([data-ezs-auto-initialize="false"])')).forEach(t=>{document.dispatchEvent(new CustomEvent("EZSearch_Loading",{detail:t})),ne({rootNode:t,onEvent:null}).then(r=>{window.EZSearchDefaultInstances.push(r),document.dispatchEvent(new CustomEvent("EZSearch_Loaded",{detail:t}))})})}ue().then(pe);var ye={hydrate:ne};return ye});
