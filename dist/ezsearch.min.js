(function(K,q){typeof exports=="object"&&typeof module<"u"?module.exports=q():typeof define=="function"&&define.amd?define(q):(K=typeof globalThis<"u"?globalThis:K||self,K.EZSearch=q())})(this,function(){"use strict";const K=e=>Object.prototype.toString.call(e).slice(8,-1),q=e=>K(e)==="Object";let D="[EZSearch] :: ";function T(...e){return console.log(D,...e)}T.warn=(...e)=>console.warn(D,...e),T.info=(...e)=>console.info(D,...e),T.error=(...e)=>console.error(D,...e);function N(e){let r=[],t=!1;for(let n=0,l=0,c=0;c<e.length;c++){let m=e[c],y=e[c+1];if(r[n]=r[n]||[],r[n][l]=r[n][l]||"",m=='"'&&t&&y=='"'){r[n][l]+=m,++c;continue}if(m=='"'){t=!t;continue}if(m==","&&!t){++l;continue}if(m=="\r"&&y==`
`&&!t){++n,l=0,++c;continue}if(m==`
`&&!t){++n,l=0;continue}if(m=="\r"&&!t){++n,l=0;continue}r[n][l]+=m}return r}async function de(e,r){if(typeof r=="function")return r(e).then(l=>typeof l=="string"?N(l):l);let t=await fetch(e.replace(/\\\//g,"/"));if(!t.ok)return T("Unable to fetch CSV"),null;let n=await t.text();return N(n)}function ee(e){return typeof e=="string"&&e.split(/,\s*/),null}function te(e,r="null"){try{return JSON.parse(e||r)}catch{return typeof r=="string"?JSON.parse(r):r}}function he(e,r){let t=0,n=null;return r.forEach((l,c)=>{c===e&&n==null&&(n=t),t++}),n}const ge={ATTR:{id:"data-ezs-id",legacy_search:"data-legacy-search",filter:"data-ezs-filter",csv_url:"data-ezs-csv-url",coll_handle:"data-ezs-collection-handle",rest_next_selects_on_change:"data-ezs-reset-next-selects-on-change",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",filtered_title:"data-ezs-filtered-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_cache:"data-ezs-clear-cache",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function re(e){return e[e.length-1]}const pe=()=>new Promise(e=>{document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",()=>e())});function B(e,r,t,n,l=!1){return n!=null?e.addEventListener(r,t,n):e.addEventListener(r,t),l&&t(),function(){e.removeEventListener(r,t)}}function W(e,r,t=0){if(q(e)){let n=Object.keys(e);n.forEach(l=>{let c=e[l];W(c,r,t+1)}),r(e,n,t)}return Array.isArray(e)&&e.forEach(n=>{W(n,r,t)}),e}function _e({data:e,keys:r=[],path:t=[],keysSort:n=[]}){let l={};return r.forEach((c,m)=>{let y=m===r.length-1;e.forEach(E=>{if(!E)return;let f=t.reduce((O,a)=>O[a],E);if(!f)return;let v=f[c];if(typeof v=="number"&&(v=v.toString()),typeof v!="string"||v==="")return;let I=r.slice(0,m).reduce((O,a)=>O[f[a]],l);if(I)if(y){const O=new ne(E);I[v]?Array.isArray(I[v])?I[v].push(O):I[v]=[I[v],O]:I[v]=O}else I[v]={}})}),Object.keys(l).length>0?W(l,(c,m,y)=>{if(!c._tag){const E=n[y]?.desc;c._keys_=m.sort((f,v)=>E?v.localeCompare(f):f.localeCompare(v))}}):l}function ye(e,r){if(r<0||r>=e.length)return!1;let t=e.slice(0,r);return Array.isArray(e[0])?t.every(([l,c])=>!!c):t.every(l=>!!l)}function me({selectedValues:e,index:r,filterTree:t}){let n=ye(e,r);if(!n)return null;if(n){const l=Array.isArray(e[0]);return e.slice(0,r).reduce((m,y)=>{if(m==null)return null;let E=l?y[1]:y;return m[E]},t)}}function be({keys:e,filterTree:r,activeFilters:t}){return e.reduce((n,l)=>{let c=t.get(l);return c&&n?.[c]||null},r)}class ne{constructor(r){this.value=r}}const Y=e=>`ezs_${e}`,G=e=>`${e}__expiresIn`;function R(e){const r=Y(e);return window.localStorage.removeItem(r),window.localStorage.removeItem(G(r)),!0}function le(e){const r=Y(e);let t=Date.now();return Number(window.localStorage.getItem(G(r))||"0")<t?(R(r),null):window.localStorage.getItem(r)}function ae(e,r,t=60*5){const n=Y(e);t=Math.abs(t);let c=Date.now()+t*1e3;return window.localStorage.setItem(n,r),window.localStorage.setItem(G(n),c),!0}const{ATTR:u}=ge;let ie={};function Ae({legacySearch:e,url:r=void 0,rootNode:t,fetchData:n,collectionHandle:l,onEvent:c,resetNextSelectsOnChange:m=!1,autoSearch:y=!1,productTags:E=null,cacheSeconds:f=300,hasCsvHeaders:v=!1,isFitmentWidget:I=!1,loadingBtnClass:O="btn--loading"}={}){let a={__validated:!0};if(!(t instanceof HTMLElement))throw new Error("rootNode must be specified");a.rootNode=t,typeof e>"u"&&(e=t.getAttribute(u.legacy_search)),a.legacySearch=typeof e=="boolean"?e:e==="true"?!0:e!=="false";let H=t.getAttribute(u.id)||"";if(a.filterSelects=Array.from(t.querySelectorAll(`select[${u.filter}]`)).map(b=>(b.setAttribute(u.filter,(b.getAttribute(u.filter)||"")+H),b)),a.filterKeys=a.filterSelects.map(b=>b.getAttribute(u.filter)).filter(Boolean),a.filterKeys.length<1||a.filterSelects.length!==a.filterKeys.length)throw new Error("Filter keys/selects mismatch");if(a.filterKeysSortBy=a.filterSelects.map(b=>{let x=b.getAttribute(u.sort_by)==="desc";return{desc:x,asc:!x}}),(typeof r!="string"||!r.trim())&&(r=t.getAttribute(u.csv_url),typeof r!="string"&&!n))throw new Error("URL or `fetchData` must be specified");if(a.collectionHandle=typeof l=="string"?l:t.getAttribute(u.coll_handle)||"all",a.onEvent=typeof c=="function"?c:null,a.autoSearch=!!y||t.hasAttribute(u.auto_search),a.resetNextSelectsOnChange=!!m||t.hasAttribute(u.rest_next_selects_on_change),a.hasCsvHeaders=!!v||t.hasAttribute(u.csv_headers),a.isFitmentWidget=!!I||t.hasAttribute(u.fitment_widget),a.loadingBtnClass=(typeof O=="string"?O:t.getAttribute(u.loading_btn_class)||"").split(" ").filter(Boolean),a.loadingBtnClass.length===0&&(a.loadingBtnClass=null),a.filteredLinks=Array.from(t.querySelectorAll(`a[${u.filtered_link}]`)),a.filteredTitle=Array.from(t.querySelectorAll(`[${u.filtered_title}]`)),a.triggerVerifyBtns=Array.from(t.querySelectorAll(`[${u.filter_trigger_verify}]`)),a.toggleOpenBtns=Array.from(t.querySelectorAll(`[${u.toggle_open}]`)),Array.from(t.querySelectorAll(`[${u.loading_on_click}]`)).forEach(b=>{b.__ezs_loadable=!0}),a.gotoPendingBtns=Array.from(t.querySelectorAll(`[${u.goto_pending}]`)).map(b=>(b.hasAttribute(u.clear_cache)&&(b.__ezs_clear_cache=!0),b)),a.gotoBaseCollectionBtns=Array.from(t.querySelectorAll(`[${u.goto_base_collection}]`)).map(b=>(b.hasAttribute(u.clear_cache)&&(b.__ezs_clear_cache=!0),b)),a.productTags=typeof E=="string"?ee(E):Array.isArray(E)?E:null,a.productTags==null&&t.hasAttribute(u.prod_tags)){let b=t.getAttribute(u.prod_tags);a.productTags=te(b)||ee(b)}f=t.getAttribute(u.cache_seconds)||f,typeof f=="string"&&(f=Number(f)||300),a.cacheSeconds=typeof f=="number"?Math.max(Math.trunc(f),0):0,a.preClearCache=t.hasAttribute(u.pre_clear_cache),typeof r=="string"&&(a.url=r),typeof n=="function"&&(a.fetchData=n);let P=t.querySelector("form[data-ezs-form]");return P&&(a.filterForm=P,a.filterFormSubmitBtn=P.querySelector('[type="submit"]')),a}async function se(e){const{legacySearch:r,filterSelects:t,filterKeys:n,url:l,fetchData:c,collectionHandle:m,filterForm:y,filterFormSubmitBtn:E,rootNode:f,onEvent:v,autoSearch:I,productTags:O,cacheSeconds:a,preClearCache:H,gotoPendingBtns:P,gotoBaseCollectionBtns:b,loadingBtnClass:x,toggleOpenBtns:Ee,filteredLinks:Se,filteredTitle:Ce,hasCsvHeaders:we,triggerVerifyBtns:ze,isFitmentWidget:Oe,filterKeysSortBy:Ie,resetNextSelectsOnChange:ce}=e.__validated?e:Ae(e);if(f.__ezs_hydrated){T("Already hydrated");return}f.__ezs_hydrated=!0;const M=[()=>{f.__ezs_hydrated=!1}],oe=`/collections/${m}`,ue=a&&a>0,V=O&&O.length>0?O.reduce((s,g)=>(s[g]=!0,s),{}):null,z=new Map(Array.from({length:n.length},(s,g)=>[n[g],!ue||H?"":le(n[g])||""]));let Z=null;function X({selectIndex:s,updateSelectValue:g=!1,forcePending:i=!1}={}){let _=[...z];_.forEach(([p,A],L)=>{const $=me({selectedValues:_,index:L,filterTree:Z});$?.[A]||z.set(p,"");const d=L>s,o=t[L],w=$?._keys_||[],h=Array.isArray(w)&&w.length>0;o.disabled=!h,ue&&(A?ae(p,A,a):R(p)),(s===-1||g?!1:d?ce?!1:w.length===o.options.length-1&&w.every((S,C)=>S===o.options[C+1].value):!0)||(o.options.length=1,requestAnimationFrame(()=>{w.forEach((S,C)=>{o.options[C+1]=new Option(S,S)}),o.value=z.get(p)}))}),(I||i||s===-1)&&j({forcePending:i,preventAutosearch:s===-1,activeFiltersList:_}),v?.("SELECTION_UPDATE",{index:s,select:t[s]}),f.dispatchEvent(new CustomEvent("ezsearch::selection_update",{detail:{index:s,select:t[s]},bubbles:!1,cancelable:!1}))}function j({forcePending:s=!1,fromCache:g=!1,preventAutosearch:i=!1}={}){let _=[...z].every(([,h])=>!!h);f.setAttribute("data-ezs-selected-filters",_?"all":"partial");let p=s?null:g?te(le("selectedItem"),"null"):be({keys:n,activeFilters:z,filterTree:Z}),A=p instanceof ne?p.value:null;Array.isArray(p)&&(A=((V?p.find(h=>{const F=h.value?._tag;return!!V[F]}):null)||p[0]).value);let L=A?._path,$=A?._tag,d=V?V[$]:null;if(f.setAttribute("data-ezs-state",A?d?"valid":"invalid":"pending"),y){let h=null;r||(h=y._filter_p_tag_el,h||(h=document.createElement("input"),h.setAttribute("type","hidden"),h.setAttribute("name","filter.p.tag"),y._filter_p_tag_el=h,y.appendChild(h))),h&&(h.value=$||""),L?(y.action=L,E&&(E.disabled=!1)):(y.removeAttribute("action"),E&&(E.disabled=!0))}A&&(v?.("SELECTION_COMPLETE",{selected:A}),f.dispatchEvent(new CustomEvent("ezsearch::selection_complete",{detail:{selected:A,fits:d==null?void 0:!!d},bubbles:!1,cancelable:!1}))),Se.forEach(h=>{L?(h.setAttribute("href",A?._path),h.disabled=!0):(h.removeAttribute("href"),h.disabled=!0)});let o=A?n.map(h=>z.get(h)).join(" "):"";Ce.forEach(h=>{h.textContent=o}),A?ae("selectedItem",JSON.stringify(A)):R("selectedItem");let w=L&&y&&I&&!i;w&&(document.body.setAttribute("data-ezs-navigating",""),w&&y.submit())}function Le(s){let g=s?.target?.__ezs_index;if(typeof g!="number"){T.warn("no `__ezs_index` found");return}const i=n[g],p=t[g].value;p?z.set(i,p):z.set(i,""),ce&&[...z].forEach(([A],L)=>{L>g&&z.set(A,"")}),X({selectIndex:g})}function fe(s,g){if(!z.has(s))return;typeof g=="string"?g=g.trim():g="";let _=he(s,z);_!=null&&(z.set(s,g),X({selectIndex:_,updateSelectValue:!0,forcePending:!0}))}function U(){R("selectedItem"),n.forEach(s=>R(s))}function Te(s){let g=s.map((i,_)=>{i.__ezs_index=_;let p=i.options[0];return p?(p.value="",p):(p=new Option("All","",!0,!0),p)});s.forEach((i,_)=>{let p=B(i,"change",Le);M.push(p),i.options.length=1,i.options[0]=g[_]}),M.push(...ze.map(i=>(i.disabled&&(i.disabled=!1),B(i,"click",()=>{j()}))),...P.map(i=>(i.disabled&&(i.disabled=!1),B(i,"click",()=>{i.__ezs_clear_cache&&(U(),fe(n[0],"")),j({forcePending:!0}),s[0].focus()}))),...b.map(i=>(i.disabled&&(i.disabled=!1),B(i,"click",()=>{i.disabled=!0,i.__ezs_clear_cache&&U(),y?(y.action=oe,y.submit()):window.location.href=oe}))),...Ee.map(i=>B(i,"click",()=>{f.classList.toggle("is-open")})),B(f,"click",i=>{let _=i?.target;_&&_.__ezs_loadable&&x?.forEach(p=>{_.classList.add(p)})})),X({selectIndex:-1})}async function Fe(){let s=ie[l];if(s)return s;if(!l){T.error("no `url` found"),f.classList.add("is-invalid"),f.style.display="none";return}let g=de(l,c).then(i=>{if(i.length===0)return i;(we||n.every((d,o)=>i[0][o]===d))&&(i=i.slice(1));let _=!0,p=n.length,A=n.findIndex(d=>d.toLowerCase()==="year");A!==-1&&(i=i.reduce((d,o)=>{const w=o[A];if(!w.includes("-"))return d.push(o),d;let[F,S]=w.split("-").map(C=>Number(C)).reduce((C,k)=>(C.push(Number.isNaN(k)?null:k),C),[]);if(F&&S){for(let C=F;C<=S;C++)d.push(o.map((k,J)=>J===A?C:k));return d}return!S&&F&&d.push(o.map((C,k)=>k===A?F:C)),d},[]));let L=i.map(d=>{if(_&&d.length-1!==p&&(T.error("CSV data and `filterKeys` mismatch",{filterKeys:n,line:d}),_=!1),!_)return[];let o=d[n.length];o.startsWith(">")&&(o=o.replace(/^>*/g,""),d[n.length]=o);const w="/collections/all/";if(o.startsWith(w)&&(o=o.slice(w.length)),o.includes("$$$")){const[S]=o.split("$$$");if(S)o=S,d[n.length]=o;else return[]}return d.reduce((S,C,k)=>{let J=n[k];if(J)S[J]=C;else{const Q=re(C.split("/"));S._path=`/collections/${m||"all"}/${Q}`,S._tag=re(Q.split("/")),r||(S._path=`/collections/${m||"all"}?filter.p.tag=${Q}`)}return S},{})});if(!_)throw new Error("CSV data and `filterKeys` mismatch");return _e({data:L,activeFilters:[...z],path:[],keys:n,keysSort:Ie,getValue:(d,o,w)=>d[w]})});return ie[l]=g,g}function ke(){Oe&&j({fromCache:!0})}function $e(){f.setAttribute("data-ezs-loaded","true")}async function Be(){return H&&U(),ke(),Fe().then(async s=>{Z=s,Te(t)}).then(()=>{$e()})}return Be().then(()=>({filterTree:Z,getActiveFilters(){return[...z]},updateFilterValue:fe,clearAllCache:U,prodcutTagsLookup:V,destory(){t.forEach(s=>{s.options.length=1}),M.forEach(s=>s()),M.length=1}}))}const xe="";window.EZSearchDefaultInstances=[];async function ve(){Array.from(document.querySelectorAll('[data-ezs="search"]:not([data-ezs-auto-initialize="false"])')).forEach(async r=>{document.dispatchEvent(new CustomEvent("EZSearch_Loading",{detail:r}));const t=r.getAttribute("data-ezs-config-url");let n=r.getAttribute("data-ezs-csv-url")||"";if(t){const l=await fetch(t).then(c=>c.json()).catch(c=>null);l?.settings?.form?.db&&(n=l.settings.form.db)}se({url:n,rootNode:r,onEvent:null}).then(l=>{window.EZSearchDefaultInstances.push(l),document.dispatchEvent(new CustomEvent("EZSearch_Loaded",{detail:r}))})})}return pe().then(ve),{hydrate:se}});
