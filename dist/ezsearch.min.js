var __async=(k,B,w)=>new Promise((z,K)=>{var U=O=>{try{x(w.next(O))}catch(P){K(P)}},D=O=>{try{x(w.throw(O))}catch(P){K(P)}},x=O=>O.done?z(O.value):Promise.resolve(O.value).then(U,D);x((w=w.apply(k,B)).next())});(function(k,B){typeof exports=="object"&&typeof module<"u"?module.exports=B():typeof define=="function"&&define.amd?define(B):(k=typeof globalThis<"u"?globalThis:k||self,k.EZSearch=B())})(this,function(){"use strict";const k=e=>Object.prototype.toString.call(e).slice(8,-1),B=e=>k(e)==="Object";let w="[EZSearch] :: ";function z(...e){return console.log(w,...e)}z.warn=(...e)=>console.warn(w,...e),z.info=(...e)=>console.info(w,...e),z.error=(...e)=>console.error(w,...e);function K(e){let t=[],r=!1;for(let i=0,a=0,o=0;o<e.length;o++){let u=e[o],h=e[o+1];if(t[i]=t[i]||[],t[i][a]=t[i][a]||"",u=='"'&&r&&h=='"'){t[i][a]+=u,++o;continue}if(u=='"'){r=!r;continue}if(u==","&&!r){++a;continue}if(u=="\r"&&h==`
`&&!r){++i,a=0,++o;continue}if(u==`
`&&!r){++i,a=0;continue}if(u=="\r"&&!r){++i,a=0;continue}t[i][a]+=u}return t}function U(e,t){return __async(this,null,function*(){if(typeof t=="function")return t(e).then(a=>typeof a=="string"?K(a):a);let r=yield fetch(e.replace(/\\\//g,"/"));if(!r.ok)return z("Unable to fetch CSV"),null;let i=yield r.text();return K(i)})}function D(e){return typeof e=="string"&&e.split(/,\s*/),null}function x(e,t="null"){try{return JSON.parse(e||t)}catch{return typeof t=="string"?JSON.parse(t):t}}function O(e,t){let r=0,i=null;return t.forEach((a,o)=>{o===e&&i==null&&(i=r),r++}),i}const P={ATTR:{id:"data-ezs-id",filter:"data-ezs-filter",csv_url:"data-ezs-csv-url",coll_handle:"data-ezs-collection-handle",rest_next_selects_on_change:"data-ezs-reset-next-selects-on-change",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",filtered_title:"data-ezs-filtered-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_cache:"data-ezs-clear-cache",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function oe(e){return e[e.length-1]}const ue=()=>new Promise(e=>{document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",()=>e())});function q(e,t,r,i,a=!1){return i!=null?e.addEventListener(t,r,i):e.addEventListener(t,r),a&&r(),function(){e.removeEventListener(t,r)}}function J(e,t,r=0){if(B(e)){let i=Object.keys(e);i.forEach(a=>{let o=e[a];J(o,t,r+1)}),t(e,i,r)}return Array.isArray(e)&&e.forEach(i=>{J(i,t,r)}),e}function fe({data:e,keys:t=[],path:r=[],keysSort:i=[]}){let a={};return t.forEach((o,u)=>{let h=u===t.length-1;e.forEach(p=>{if(!p)return;let b=r.reduce((I,C)=>I[C],p);if(!b)return;let v=b[o];if(typeof v=="number"&&(v=v.toString()),typeof v!="string"||v==="")return;let n=t.slice(0,u).reduce((I,C)=>I[b[C]],a);n&&(n[v]=h?p:{})})}),Object.keys(a).length>0?J(a,(o,u,h)=>{var p;if(!o._tag){const b=(p=i[h])==null?void 0:p.desc;o._keys_=u.sort((v,n)=>b?n.localeCompare(v):v.localeCompare(n))}}):a}function de(e,t){if(t<0||t>=e.length)return!1;let r=e.slice(0,t);return Array.isArray(e[0])?r.every(([a,o])=>!!o):r.every(a=>!!a)}function he({selectedValues:e,index:t,filterTree:r}){let i=de(e,t);if(!i)return null;if(i){const a=Array.isArray(e[0]);return e.slice(0,t).reduce((u,h)=>{if(u==null)return null;let p=a?h[1]:h;return u[p]},r)}}function ge({keys:e,filterTree:t,activeFilters:r}){return e.reduce((i,a)=>{let o=r.get(a);return o&&i?.[o]||null},t)}const W=e=>`ezs_${e}`,G=e=>`${e}__expiresIn`;function R(e){const t=W(e);return window.localStorage.removeItem(t),window.localStorage.removeItem(G(t)),!0}function te(e){const t=W(e);let r=Date.now();return Number(window.localStorage.getItem(G(t))||"0")<r?(R(t),null):window.localStorage.getItem(t)}function re(e,t,r=60*5){const i=W(e);r=Math.abs(r);let o=Date.now()+r*1e3;return window.localStorage.setItem(i,t),window.localStorage.setItem(G(i),o),!0}const{ATTR:f}=P;let le={};function _e({rootNode:e,fetchData:t,collectionHandle:r,onEvent:i,resetNextSelectsOnChange:a=!1,autoSearch:o=!1,productTags:u=null,cacheSeconds:h=300,hasCsvHeaders:p=!1,isFitmentWidget:b=!1,loadingBtnClass:v="btn--loading"}={}){let n={};if(!(e instanceof HTMLElement))throw new Error("rootNode must be specified");n.rootNode=e;let I=e.getAttribute(f.id)||"";if(n.filterSelects=Array.from(e.querySelectorAll(`select[${f.filter}]`)).map(g=>(g.setAttribute(f.filter,(g.getAttribute(f.filter)||"")+I),g)),n.filterKeys=n.filterSelects.map(g=>g.getAttribute(f.filter)).filter(Boolean),n.filterKeys.length<1||n.filterSelects.length!==n.filterKeys.length)throw new Error("Filter keys/selects mismatch");n.filterKeysSortBy=n.filterSelects.map(g=>{let $=g.getAttribute(f.sort_by)==="desc";return{desc:$,asc:!$}});let C=e.getAttribute(f.csv_url);if(typeof C!="string"&&!t)throw new Error("URL or `fetchData` must be specified");if(n.collectionHandle=typeof r=="string"?r:e.getAttribute(f.coll_handle)||"all",n.onEvent=typeof i=="function"?i:null,n.autoSearch=!!o||e.hasAttribute(f.auto_search),n.resetNextSelectsOnChange=!!a||e.hasAttribute(f.rest_next_selects_on_change),n.hasCsvHeaders=!!p||e.hasAttribute(f.csv_headers),n.isFitmentWidget=!!b||e.hasAttribute(f.fitment_widget),n.loadingBtnClass=(typeof v=="string"?v:e.getAttribute(f.loading_btn_class)||"").split(" ").filter(Boolean),n.loadingBtnClass.length===0&&(n.loadingBtnClass=null),n.filteredLinks=Array.from(e.querySelectorAll(`a[${f.filtered_link}]`)),n.filteredTitle=Array.from(e.querySelectorAll(`[${f.filtered_title}]`)),n.triggerVerifyBtns=Array.from(e.querySelectorAll(`[${f.filter_trigger_verify}]`)),n.toggleOpenBtns=Array.from(e.querySelectorAll(`[${f.toggle_open}]`)),Array.from(e.querySelectorAll(`[${f.loading_on_click}]`)).forEach(g=>{g.__ezs_loadable=!0}),n.gotoPendingBtns=Array.from(e.querySelectorAll(`[${f.goto_pending}]`)).map(g=>(g.hasAttribute(f.clear_cache)&&(g.__ezs_clear_cache=!0),g)),n.gotoBaseCollectionBtns=Array.from(e.querySelectorAll(`[${f.goto_base_collection}]`)).map(g=>(g.hasAttribute(f.clear_cache)&&(g.__ezs_clear_cache=!0),g)),n.productTags=typeof u=="string"?D(u):Array.isArray(u)?u:null,n.productTags==null&&e.hasAttribute(f.prod_tags)){let g=e.getAttribute(f.prod_tags);n.productTags=x(g)||D(g)}h=e.getAttribute(f.cache_seconds)||h,typeof h=="string"&&(h=Number(h)||300),n.cacheSeconds=typeof h=="number"?Math.max(Math.trunc(h),0):0,n.preClearCache=e.hasAttribute(f.pre_clear_cache),typeof C=="string"&&(n.url=C),typeof t=="function"&&(n.fetchData=t);let Z=e.querySelector("form[data-ezs-form]");return Z&&(n.filterForm=Z,n.filterFormSubmitBtn=Z.querySelector('[type="submit"]')),n}function ne(e){return __async(this,null,function*(){const{filterSelects:t,filterKeys:r,url:i,fetchData:a,collectionHandle:o,filterForm:u,filterFormSubmitBtn:h,rootNode:p,onEvent:b,autoSearch:v,productTags:n,cacheSeconds:I,preClearCache:C,gotoPendingBtns:Z,gotoBaseCollectionBtns:g,loadingBtnClass:$,toggleOpenBtns:ye,filteredLinks:me,filteredTitle:ve,hasCsvHeaders:Ae,triggerVerifyBtns:Se,isFitmentWidget:Ee,filterKeysSortBy:be,resetNextSelectsOnChange:ie}=_e(e);if(p.__ezs_hydrated){z("Already hydrated");return}p.__ezs_hydrated=!0;const H=[()=>{p.__ezs_hydrated=!1}],ae=`/collections/${o}`,se=I&&I>0,X=n&&n.length>0?n.reduce((s,_)=>(s[_]=!0,s),{}):null,A=new Map(Array.from({length:r.length},(s,_)=>[r[_],!se||C?"":te(r[_])||""]));let M=null;function Q({selectIndex:s,updateSelectValue:_=!1,forcePending:l=!1}={}){let d=[...A];d.forEach(([c,E],L)=>{const m=he({selectedValues:d,index:L,filterTree:M});m?.[E]||A.set(c,"");const y=L>s,S=t[L],T=m?._keys_||[],Y=Array.isArray(T)&&T.length>0;S.disabled=!Y,se&&(E?re(c,E,I):R(c)),(s===-1||_?!1:y?ie?!1:T.length===S.options.length-1&&T.every((F,ee)=>F===S.options[ee+1].value):!0)||(S.options.length=1,requestAnimationFrame(()=>{T.forEach((F,ee)=>{S.options[ee+1]=new Option(F,F)}),S.value=A.get(c)}))}),(v||l||s===-1)&&V({forcePending:l,preventAutosearch:s===-1,activeFiltersList:d}),b?.("SELECTION_UPDATE",{index:s,select:t[s]})}function V({forcePending:s=!1,fromCache:_=!1,preventAutosearch:l=!1}={}){let d=[...A].every(([,y])=>!!y);p.setAttribute("data-ezs-selected-filters",d?"all":"partial");let c=s?null:_?x(te("selectedItem"),"null"):ge({keys:r,activeFilters:A,filterTree:M}),E=c?._path;if(X){let y=c?._tag,S=X[y];p.setAttribute("data-ezs-state",c?S?"valid":"invalid":"pending")}u&&(E?(u.action=E,h&&(h.disabled=!1)):(u.removeAttribute("action"),h&&(h.disabled=!0))),c&&(b?.("SELECTION_COMPLETE",{selected:c}),p.dispatchEvent(new CustomEvent("EZSearch_Selected",{detail:{selected:c},bubbles:!1,cancelable:!1}))),me.forEach(y=>{E?(y.setAttribute("href",c?._path),y.disabled=!0):(y.removeAttribute("href"),y.disabled=!0)});let L=c?r.map(y=>A.get(y)).join(" "):"";ve.forEach(y=>{y.textContent=L}),c?re("selectedItem",JSON.stringify(c)):R("selectedItem");let m=E&&u&&v&&!l;m&&(document.body.setAttribute("data-ezs-navigating",""),m&&u.submit())}function Ce(s){var _;let l=(_=s?.target)==null?void 0:_.__ezs_index;if(typeof l!="number"){z.warn("no `__ezs_index` found");return}const d=r[l],E=t[l].value;E?A.set(d,E):A.set(d,""),ie&&[...A].forEach(([L],m)=>{m>l&&A.set(L,"")}),Q({selectIndex:l})}function ce(s,_){if(!A.has(s))return;typeof _=="string"?_=_.trim():_="";let d=O(s,A);d!=null&&(A.set(s,_),Q({selectIndex:d,updateSelectValue:!0,forcePending:!0}))}function j(){R("selectedItem"),r.forEach(s=>R(s))}function we(s){let _=s.map((l,d)=>{l.__ezs_index=d;let c=l.options[0];return c?(c.value="",c):(c=new Option("All","",!0,!0),c)});s.forEach((l,d)=>{let c=q(l,"change",Ce);H.push(c),l.options.length=1,l.options[0]=_[d]}),H.push(...Se.map(l=>(l.disabled&&(l.disabled=!1),q(l,"click",()=>{V()}))),...Z.map(l=>(l.disabled&&(l.disabled=!1),q(l,"click",()=>{l.__ezs_clear_cache&&(j(),ce(r[0],"")),V({forcePending:!0}),s[0].focus()}))),...g.map(l=>(l.disabled&&(l.disabled=!1),q(l,"click",()=>{l.disabled=!0,l.__ezs_clear_cache&&j(),u?(u.action=ae,u.submit()):window.location.href=ae}))),...ye.map(l=>q(l,"click",()=>{p.classList.toggle("is-open")})),q(p,"click",l=>{let d=l?.target;d&&d.__ezs_loadable&&$?.forEach(c=>{d.classList.add(c)})})),Q({selectIndex:-1})}function ze(){return __async(this,null,function*(){let s=le[i];if(s)return s;let _=U(i,a).then(l=>{if(l.length===0)return l;(Ae||r.every((m,y)=>l[0][y]===m))&&(l=l.slice(1));let d=!0,c=r.length,E=l.map(m=>(d&&m.length-1!==c&&(z.error("CSV data and `filterKeys` mismatch",{filterKeys:r,line:m}),d=!1),d?m.reduce((S,T,Y)=>{let N=r[Y];if(N)S[N]=T;else{const F=T.split("$$$url")[0];S._path=o?F.replace("/all/",`/${o}/`):F,S._tag=oe(F.split("/"))}return S},{}):[]));if(!d)throw new Error("CSV data and `filterKeys` mismatch");return fe({data:E,activeFilters:[...A],path:[],keys:r,keysSort:be,getValue:(m,y,S)=>m[S]})});return le[i]=_,_})}function Oe(){Ee&&V({fromCache:!0})}function Ie(){p.setAttribute("data-ezs-loaded","true")}function Le(){return __async(this,null,function*(){return C&&j(),Oe(),ze().then(s=>__async(this,null,function*(){M=s,we(t)})).then(()=>{Ie()})})}return Le().then(()=>({filterTree:M,getActiveFilters(){return[...A]},updateFilterValue:ce,clearAllCache:j,prodcutTagsLookup:X,destory(){t.forEach(s=>{s.options.length=1}),H.forEach(s=>s()),H.length=1}}))})}const Te="";window.EZSearchDefaultInstances=[];function pe(){Array.from(document.querySelectorAll('[data-ezs="search"]:not([data-ezs-auto-initialize="false"])')).forEach(t=>{document.dispatchEvent(new CustomEvent("EZSearch_Loading",{detail:t})),ne({rootNode:t,onEvent:null}).then(r=>{window.EZSearchDefaultInstances.push(r),document.dispatchEvent(new CustomEvent("EZSearch_Loaded",{detail:t}))})})}return ue().then(pe),{hydrate:ne}});
