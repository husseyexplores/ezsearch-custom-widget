var __async=(q,P,T)=>new Promise(($,D)=>{var Q=F=>{try{V(T.next(F))}catch(H){D(H)}},J=F=>{try{V(T.throw(F))}catch(H){D(H)}},V=F=>F.done?$(F.value):Promise.resolve(F.value).then(Q,J);V((T=T.apply(q,P)).next())});(function(q,P){typeof exports=="object"&&typeof module<"u"?module.exports=P():typeof define=="function"&&define.amd?define(P):(q=typeof globalThis<"u"?globalThis:q||self,q.EZSearch=P())})(this,function(){"use strict";const q=t=>Object.prototype.toString.call(t).slice(8,-1),P=t=>q(t)==="Object";let T="[EZSearch] :: ";function $(...t){return console.log(T,...t)}$.warn=(...t)=>console.warn(T,...t),$.info=(...t)=>console.info(T,...t),$.error=(...t)=>console.error(T,...t);function D(t){let e=[],r=!1;for(let n=0,a=0,o=0;o<t.length;o++){let c=t[o],m=t[o+1];if(e[n]=e[n]||[],e[n][a]=e[n][a]||"",c=='"'&&r&&m=='"'){e[n][a]+=c,++o;continue}if(c=='"'){r=!r;continue}if(c==","&&!r){++a;continue}if(c=="\r"&&m==`
`&&!r){++n,a=0,++o;continue}if(c==`
`&&!r){++n,a=0;continue}if(c=="\r"&&!r){++n,a=0;continue}e[n][a]+=c}return e}function Q(t,e){return __async(this,null,function*(){if(typeof e=="function")return e(t).then(a=>typeof a=="string"?D(a):a);let r=yield fetch(t.replace(/\\\//g,"/"));if(!r.ok)return $("Unable to fetch CSV"),null;let n=yield r.text();return D(n)})}function J(t){return typeof t=="string"&&t.split(/,\s*/),null}function V(t,e="null"){try{return JSON.parse(t||e)}catch{return typeof e=="string"?JSON.parse(e):e}}function F(t,e){let r=0,n=null;return e.forEach((a,o)=>{o===t&&n==null&&(n=r),r++}),n}const H={ATTR:{id:"data-ezs-id",filter:"data-ezs-filter",csv_url:"data-ezs-csv-url",coll_handle:"data-ezs-collection-handle",rest_next_selects_on_change:"data-ezs-reset-next-selects-on-change",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",filtered_title:"data-ezs-filtered-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_cache:"data-ezs-clear-cache",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function de(t){return t[t.length-1]}const he=()=>new Promise(t=>{document.readyState!=="loading"?t():document.addEventListener("DOMContentLoaded",()=>t())});function Z(t,e,r,n,a=!1){return n!=null?t.addEventListener(e,r,n):t.addEventListener(e,r),a&&r(),function(){t.removeEventListener(e,r)}}function N(t,e,r=0){if(P(t)){let n=Object.keys(t);n.forEach(a=>{let o=t[a];N(o,e,r+1)}),e(t,n,r)}return Array.isArray(t)&&t.forEach(n=>{N(n,e,r)}),t}function ge({data:t,keys:e=[],path:r=[],keysSort:n=[]}){let a={};return e.forEach((o,c)=>{let m=c===e.length-1;t.forEach(u=>{if(!u)return;let I=r.reduce((i,x)=>i[x],u);if(!I)return;let b=I[o];if(typeof b=="number"&&(b=b.toString()),typeof b!="string"||b==="")return;let A=e.slice(0,c).reduce((i,x)=>i[I[x]],a);if(A)if(m){const i=new ne(u);A[b]?Array.isArray(A[b])?A[b].push(i):A[b]=[A[b],i]:A[b]=i}else A[b]={}})}),Object.keys(a).length>0?N(a,(o,c,m)=>{var u;if(!o._tag){const I=(u=n[m])==null?void 0:u.desc;o._keys_=c.sort((b,A)=>I?A.localeCompare(b):b.localeCompare(A))}}):a}function pe(t,e){if(e<0||e>=t.length)return!1;let r=t.slice(0,e);return Array.isArray(t[0])?r.every(([a,o])=>!!o):r.every(a=>!!a)}function _e({selectedValues:t,index:e,filterTree:r}){let n=pe(t,e);if(!n)return null;if(n){const a=Array.isArray(t[0]);return t.slice(0,e).reduce((c,m)=>{if(c==null)return null;let u=a?m[1]:m;return c[u]},r)}}function ye({keys:t,filterTree:e,activeFilters:r}){return t.reduce((n,a)=>{let o=r.get(a);return o&&n?.[o]||null},e)}class ne{constructor(e){this.value=e}}const ee=t=>`ezs_${t}`,te=t=>`${t}__expiresIn`;function M(t){const e=ee(t);return window.localStorage.removeItem(e),window.localStorage.removeItem(te(e)),!0}function le(t){const e=ee(t);let r=Date.now();return Number(window.localStorage.getItem(te(e))||"0")<r?(M(e),null):window.localStorage.getItem(e)}function ie(t,e,r=60*5){const n=ee(t);r=Math.abs(r);let o=Date.now()+r*1e3;return window.localStorage.setItem(n,e),window.localStorage.setItem(te(n),o),!0}const{ATTR:f}=H;let ae={};function me({url:t=void 0,rootNode:e,fetchData:r,collectionHandle:n,onEvent:a,resetNextSelectsOnChange:o=!1,autoSearch:c=!1,productTags:m=null,cacheSeconds:u=300,hasCsvHeaders:I=!1,isFitmentWidget:b=!1,loadingBtnClass:A="btn--loading"}={}){let i={__validated:!0};if(!(e instanceof HTMLElement))throw new Error("rootNode must be specified");i.rootNode=e;let x=e.getAttribute(f.id)||"";if(i.filterSelects=Array.from(e.querySelectorAll(`select[${f.filter}]`)).map(_=>(_.setAttribute(f.filter,(_.getAttribute(f.filter)||"")+x),_)),i.filterKeys=i.filterSelects.map(_=>_.getAttribute(f.filter)).filter(Boolean),i.filterKeys.length<1||i.filterSelects.length!==i.filterKeys.length)throw new Error("Filter keys/selects mismatch");if(i.filterKeysSortBy=i.filterSelects.map(_=>{let R=_.getAttribute(f.sort_by)==="desc";return{desc:R,asc:!R}}),(typeof t!="string"||!t.trim())&&(t=e.getAttribute(f.csv_url),typeof t!="string"&&!r))throw new Error("URL or `fetchData` must be specified");if(i.collectionHandle=typeof n=="string"?n:e.getAttribute(f.coll_handle)||"all",i.onEvent=typeof a=="function"?a:null,i.autoSearch=!!c||e.hasAttribute(f.auto_search),i.resetNextSelectsOnChange=!!o||e.hasAttribute(f.rest_next_selects_on_change),i.hasCsvHeaders=!!I||e.hasAttribute(f.csv_headers),i.isFitmentWidget=!!b||e.hasAttribute(f.fitment_widget),i.loadingBtnClass=(typeof A=="string"?A:e.getAttribute(f.loading_btn_class)||"").split(" ").filter(Boolean),i.loadingBtnClass.length===0&&(i.loadingBtnClass=null),i.filteredLinks=Array.from(e.querySelectorAll(`a[${f.filtered_link}]`)),i.filteredTitle=Array.from(e.querySelectorAll(`[${f.filtered_title}]`)),i.triggerVerifyBtns=Array.from(e.querySelectorAll(`[${f.filter_trigger_verify}]`)),i.toggleOpenBtns=Array.from(e.querySelectorAll(`[${f.toggle_open}]`)),Array.from(e.querySelectorAll(`[${f.loading_on_click}]`)).forEach(_=>{_.__ezs_loadable=!0}),i.gotoPendingBtns=Array.from(e.querySelectorAll(`[${f.goto_pending}]`)).map(_=>(_.hasAttribute(f.clear_cache)&&(_.__ezs_clear_cache=!0),_)),i.gotoBaseCollectionBtns=Array.from(e.querySelectorAll(`[${f.goto_base_collection}]`)).map(_=>(_.hasAttribute(f.clear_cache)&&(_.__ezs_clear_cache=!0),_)),i.productTags=typeof m=="string"?J(m):Array.isArray(m)?m:null,i.productTags==null&&e.hasAttribute(f.prod_tags)){let _=e.getAttribute(f.prod_tags);i.productTags=V(_)||J(_)}u=e.getAttribute(f.cache_seconds)||u,typeof u=="string"&&(u=Number(u)||300),i.cacheSeconds=typeof u=="number"?Math.max(Math.trunc(u),0):0,i.preClearCache=e.hasAttribute(f.pre_clear_cache),typeof t=="string"&&(i.url=t),typeof r=="function"&&(i.fetchData=r);let U=e.querySelector("form[data-ezs-form]");return U&&(i.filterForm=U,i.filterFormSubmitBtn=U.querySelector('[type="submit"]')),i}function se(t){return __async(this,null,function*(){const{filterSelects:e,filterKeys:r,url:n,fetchData:a,collectionHandle:o,filterForm:c,filterFormSubmitBtn:m,rootNode:u,onEvent:I,autoSearch:b,productTags:A,cacheSeconds:i,preClearCache:x,gotoPendingBtns:U,gotoBaseCollectionBtns:_,loadingBtnClass:R,toggleOpenBtns:be,filteredLinks:Ae,filteredTitle:Se,hasCsvHeaders:Ee,triggerVerifyBtns:Ce,isFitmentWidget:we,filterKeysSortBy:ze,resetNextSelectsOnChange:oe}=t.__validated?t:me(t);if(u.__ezs_hydrated){$("Already hydrated");return}u.__ezs_hydrated=!0;const W=[()=>{u.__ezs_hydrated=!1}],ce=`/collections/${o}`,ue=i&&i>0,j=A&&A.length>0?A.reduce((s,y)=>(s[y]=!0,s),{}):null,z=new Map(Array.from({length:r.length},(s,y)=>[r[y],!ue||x?"":le(r[y])||""]));let Y=null;function re({selectIndex:s,updateSelectValue:y=!1,forcePending:l=!1}={}){let d=[...z];d.forEach(([g,h],L)=>{const k=_e({selectedValues:d,index:L,filterTree:Y});k?.[h]||z.set(g,"");const p=L>s,v=e[L],O=k?._keys_||[],E=Array.isArray(O)&&O.length>0;v.disabled=!E,ue&&(h?ie(g,h,i):M(g)),(s===-1||y?!1:p?oe?!1:O.length===v.options.length-1&&O.every((C,w)=>C===v.options[w+1].value):!0)||(v.options.length=1,requestAnimationFrame(()=>{O.forEach((C,w)=>{v.options[w+1]=new Option(C,C)}),v.value=z.get(g)}))}),(b||l||s===-1)&&G({forcePending:l,preventAutosearch:s===-1,activeFiltersList:d}),I?.("SELECTION_UPDATE",{index:s,select:e[s]})}function G({forcePending:s=!1,fromCache:y=!1,preventAutosearch:l=!1}={}){let d=[...z].every(([,E])=>!!E);u.setAttribute("data-ezs-selected-filters",d?"all":"partial");let g=s?null:y?V(le("selectedItem"),"null"):ye({keys:r,activeFilters:z,filterTree:Y}),h=g instanceof ne?g.value:null;Array.isArray(g)&&(h=((j?g.find(E=>{var S;const C=(S=E.value)==null?void 0:S._tag;return!!j[C]}):null)||g[0]).value);let L=h?._path,k=h?._tag,p=j?j[k]:null;u.setAttribute("data-ezs-state",h?p?"valid":"invalid":"pending"),c&&(L?(c.action=L,m&&(m.disabled=!1)):(c.removeAttribute("action"),m&&(m.disabled=!0))),h&&(I?.("SELECTION_COMPLETE",{selected:h}),u.dispatchEvent(new CustomEvent("EZSearch_Selected",{detail:{selected:h},bubbles:!1,cancelable:!1}))),Ae.forEach(E=>{L?(E.setAttribute("href",h?._path),E.disabled=!0):(E.removeAttribute("href"),E.disabled=!0)});let v=h?r.map(E=>z.get(E)).join(" "):"";Se.forEach(E=>{E.textContent=v}),h?ie("selectedItem",JSON.stringify(h)):M("selectedItem");let O=L&&c&&b&&!l;O&&(document.body.setAttribute("data-ezs-navigating",""),O&&c.submit())}function Oe(s){var y;let l=(y=s?.target)==null?void 0:y.__ezs_index;if(typeof l!="number"){$.warn("no `__ezs_index` found");return}const d=r[l],h=e[l].value;h?z.set(d,h):z.set(d,""),oe&&[...z].forEach(([L],k)=>{k>l&&z.set(L,"")}),re({selectIndex:l})}function fe(s,y){if(!z.has(s))return;typeof y=="string"?y=y.trim():y="";let d=F(s,z);d!=null&&(z.set(s,y),re({selectIndex:d,updateSelectValue:!0,forcePending:!0}))}function X(){M("selectedItem"),r.forEach(s=>M(s))}function Ie(s){let y=s.map((l,d)=>{l.__ezs_index=d;let g=l.options[0];return g?(g.value="",g):(g=new Option("All","",!0,!0),g)});s.forEach((l,d)=>{let g=Z(l,"change",Oe);W.push(g),l.options.length=1,l.options[0]=y[d]}),W.push(...Ce.map(l=>(l.disabled&&(l.disabled=!1),Z(l,"click",()=>{G()}))),...U.map(l=>(l.disabled&&(l.disabled=!1),Z(l,"click",()=>{l.__ezs_clear_cache&&(X(),fe(r[0],"")),G({forcePending:!0}),s[0].focus()}))),..._.map(l=>(l.disabled&&(l.disabled=!1),Z(l,"click",()=>{l.disabled=!0,l.__ezs_clear_cache&&X(),c?(c.action=ce,c.submit()):window.location.href=ce}))),...be.map(l=>Z(l,"click",()=>{u.classList.toggle("is-open")})),Z(u,"click",l=>{let d=l?.target;d&&d.__ezs_loadable&&R?.forEach(g=>{d.classList.add(g)})})),re({selectIndex:-1})}function Le(){return __async(this,null,function*(){let s=ae[n];if(s)return s;if(!n){$.error("no `url` found"),u.classList.add("is-invalid"),u.style.display="none";return}let y=Q(n,a).then(l=>{if(l.length===0)return l;(Ee||r.every((p,v)=>l[0][v]===p))&&(l=l.slice(1));let d=!0,g=r.length,h=r.findIndex(p=>p.toLowerCase()==="year");h!==-1&&(l=l.reduce((p,v)=>{const O=v[h];if(!O.includes("-"))return p.push(v),p;let[S,C]=O.split("-").map(w=>Number(w)).reduce((w,B)=>(w.push(Number.isNaN(B)?null:B),w),[]);if(S&&C){for(let w=S;w<=C;w++)p.push(v.map((B,K)=>K===h?w:B));return p}return!C&&S&&p.push(v.map((w,B)=>B===h?S:w)),p},[]));let L=l.map(p=>{if(d&&p.length-1!==g&&($.error("CSV data and `filterKeys` mismatch",{filterKeys:r,line:p}),d=!1),!d)return[];let v=p[r.length];if(v.includes("$$$products$$$")){const[S]=v.split("$$$products$$$"),C="/collections/all/";if(S.startsWith(C)&&S.length>C.length)v=S,p[r.length]=v;else return[]}return p.reduce((S,C,w)=>{let B=r[w];if(B)S[B]=C;else{let K=C.split("$$")[0];typeof K=="string"&&(K=K.replace("/collection/","/collections/")),S._path=o?K.replace("/all/",`/${o}/`):K,S._tag=de(K.split("/"))}return S},{})});if(!d)throw new Error("CSV data and `filterKeys` mismatch");return ge({data:L,activeFilters:[...z],path:[],keys:r,keysSort:ze,getValue:(p,v,O)=>p[O]})});return ae[n]=y,y})}function $e(){we&&G({fromCache:!0})}function Te(){u.setAttribute("data-ezs-loaded","true")}function Fe(){return __async(this,null,function*(){return x&&X(),$e(),Le().then(s=>__async(this,null,function*(){Y=s,Ie(e)})).then(()=>{Te()})})}return Fe().then(()=>({filterTree:Y,getActiveFilters(){return[...z]},updateFilterValue:fe,clearAllCache:X,prodcutTagsLookup:j,destory(){e.forEach(s=>{s.options.length=1}),W.forEach(s=>s()),W.length=1}}))})}const ke="";window.EZSearchDefaultInstances=[];function ve(){return __async(this,null,function*(){Array.from(document.querySelectorAll('[data-ezs="search"]:not([data-ezs-auto-initialize="false"])')).forEach(e=>__async(this,null,function*(){var r,n;document.dispatchEvent(new CustomEvent("EZSearch_Loading",{detail:e}));const a=e.getAttribute("data-ezs-config-url");let o="";if(a){const c=yield fetch(a).then(m=>m.json());(n=(r=c?.settings)==null?void 0:r.form)!=null&&n.db&&(o=c.settings.form.db)}se({url:o,rootNode:e,onEvent:null}).then(c=>{window.EZSearchDefaultInstances.push(c),document.dispatchEvent(new CustomEvent("EZSearch_Loaded",{detail:e}))})}))})}return he().then(ve),{hydrate:se}});
