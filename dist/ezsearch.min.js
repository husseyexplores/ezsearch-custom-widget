var __async=(F,k,z)=>new Promise((O,P)=>{var j=T=>{try{B(z.next(T))}catch($){P($)}},R=T=>{try{B(z.throw(T))}catch($){P($)}},B=T=>T.done?O(T.value):Promise.resolve(T.value).then(j,R);B((z=z.apply(F,k)).next())});(function(F,k){typeof exports=="object"&&typeof module<"u"?module.exports=k():typeof define=="function"&&define.amd?define(k):(F=typeof globalThis<"u"?globalThis:F||self,F.EZSearch=k())})(this,function(){"use strict";const F=e=>Object.prototype.toString.call(e).slice(8,-1),k=e=>F(e)==="Object";let z="[EZSearch] :: ";function O(...e){return console.log(z,...e)}O.warn=(...e)=>console.warn(z,...e),O.info=(...e)=>console.info(z,...e),O.error=(...e)=>console.error(z,...e);function P(e){let t=[],r=!1;for(let i=0,c=0,s=0;s<e.length;s++){let o=e[s],m=e[s+1];if(t[i]=t[i]||[],t[i][c]=t[i][c]||"",o=='"'&&r&&m=='"'){t[i][c]+=o,++s;continue}if(o=='"'){r=!r;continue}if(o==","&&!r){++c;continue}if(o=="\r"&&m==`
`&&!r){++i,c=0,++s;continue}if(o==`
`&&!r){++i,c=0;continue}if(o=="\r"&&!r){++i,c=0;continue}t[i][c]+=o}return t}function j(e,t){return __async(this,null,function*(){if(typeof t=="function")return t({parseCSV:P});let r=yield fetch(e);if(!r.ok)return O("Unable to fetch CSV"),null;let i=yield r.text();return P(i)})}function R(e){return typeof e=="string"&&e.split(/,\s*/),null}function B(e,t="null"){try{return JSON.parse(e||t)}catch{return typeof t=="string"?JSON.parse(t):t}}function T(e,t){let r=0,i=null;return t.forEach((c,s)=>{s===e&&i==null&&(i=r),r++}),i}const $={ATTR:{id:"data-ezs-id",filter:"data-ezs-filter",csv_url:"data-ezs-csv-url",coll_handle:"data-ezs-collection-handle",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",filtered_title:"data-ezs-filtered-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_cache:"data-ezs-clear-cache",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function oe(e){return e[e.length-1]}const ce=()=>new Promise(e=>{document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",()=>e())});function q(e,t,r,i,c=!1){return i!=null?e.addEventListener(t,r,i):e.addEventListener(t,r),c&&r(),function(){e.removeEventListener(t,r)}}function J(e,t,r=0){if(k(e)){let i=Object.keys(e);i.forEach(c=>{let s=e[c];J(s,t,r+1)}),t(e,i,r)}return Array.isArray(e)&&e.forEach(i=>{J(i,t,r)}),e}function ue({data:e,keys:t=[],path:r=[],keysSort:i=[]}){let c={};return t.forEach((s,o)=>{let m=o===t.length-1;e.forEach(_=>{if(!_)return;let A=r.reduce((w,C)=>w[C],_);if(!A)return;let l=A[s];if(typeof l=="number"&&(l=l.toString()),typeof l!="string"||l==="")return;let b=t.slice(0,o).reduce((w,C)=>w[A[C]],c);!b||(b[l]=m?_:{})})}),Object.keys(c).length>0?J(c,(s,o,m)=>{var _;if(!s._tag){const A=(_=i[m])==null?void 0:_.desc;s._keys_=o.sort((l,b)=>A?b.localeCompare(l):l.localeCompare(b))}}):c}function fe(e,t){if(t<0||t>=e.length)return!1;let r=e.slice(0,t);return Array.isArray(e[0])?r.every(([c,s])=>!!s):r.every(c=>!!c)}function de({selectedValues:e,index:t,filterTree:r}){let i=fe(e,t);if(!i)return null;if(i){const c=Array.isArray(e[0]);return e.slice(0,t).reduce((o,m)=>{let _=c?m[1]:m;return o[_]},r)}}function he({keys:e,filterTree:t,activeFilters:r}){return e.reduce((i,c)=>{let s=r.get(c);return s&&i?.[s]||null},t)}const U=e=>`ezs_${e}`,W=e=>`${e}__expiresIn`;function x(e){const t=U(e);return window.localStorage.removeItem(t),window.localStorage.removeItem(W(t)),!0}function N(e){const t=U(e);let r=Date.now();return Number(window.localStorage.getItem(W(t))||"0")<r?(x(t),null):window.localStorage.getItem(t)}function ee(e,t,r=60*5){const i=U(e);r=Math.abs(r);let s=Date.now()+r*1e3;return window.localStorage.setItem(i,t),window.localStorage.setItem(W(i),s),!0}const{ATTR:d}=$;let te={};function ge({rootNode:e,fetchData:t,collectionHandle:r,onEvent:i,autoSearch:c=!1,productTags:s=null,cacheSeconds:o=300,hasCsvHeaders:m=!1,isFitmentWidget:_=!1,loadingBtnClass:A="btn--loading"}={}){let l={};if(!(e instanceof HTMLElement))throw new Error("rootNode must be specified");l.rootNode=e;let b=e.getAttribute(d.id)||"";if(l.filterSelects=Array.from(e.querySelectorAll(`select[${d.filter}]`)).map(h=>(h.setAttribute(d.filter,(h.getAttribute(d.filter)||"")+b),h)),l.filterKeys=l.filterSelects.map(h=>h.getAttribute(d.filter)).filter(Boolean),l.filterKeys.length<1||l.filterSelects.length!==l.filterKeys.length)throw new Error("Filter keys/selects mismatch");l.filterKeysSortBy=l.filterSelects.map(h=>{let K=h.getAttribute(d.sort_by)==="desc";return{desc:K,asc:!K}});let w=e.getAttribute(d.csv_url);if(typeof w!="string"&&!t)throw new Error("URL or `fetchData` must be specified");if(l.collectionHandle=typeof r=="string"?r:e.getAttribute(d.coll_handle)||"all",l.onEvent=typeof i=="function"?i:null,l.autoSearch=!!c||e.hasAttribute(d.auto_search),l.hasCsvHeaders=!!m||e.hasAttribute(d.csv_headers),l.isFitmentWidget=!!_||e.hasAttribute(d.fitment_widget),l.loadingBtnClass=(typeof A=="string"?A:e.getAttribute(d.loading_btn_class)||"").split(" ").filter(Boolean),l.loadingBtnClass.length===0&&(l.loadingBtnClass=null),l.filteredLinks=Array.from(e.querySelectorAll(`a[${d.filtered_link}]`)),l.filteredTitle=Array.from(e.querySelectorAll(`[${d.filtered_title}]`)),l.triggerVerifyBtns=Array.from(e.querySelectorAll(`[${d.filter_trigger_verify}]`)),l.toggleOpenBtns=Array.from(e.querySelectorAll(`[${d.toggle_open}]`)),Array.from(e.querySelectorAll(`[${d.loading_on_click}]`)).forEach(h=>{h.__ezs_loadable=!0}),l.gotoPendingBtns=Array.from(e.querySelectorAll(`[${d.goto_pending}]`)).map(h=>(h.hasAttribute(d.clear_cache)&&(h.__ezs_clear_cache=!0),h)),l.gotoBaseCollectionBtns=Array.from(e.querySelectorAll(`[${d.goto_base_collection}]`)).map(h=>(h.hasAttribute(d.clear_cache)&&(h.__ezs_clear_cache=!0),h)),l.productTags=typeof s=="string"?R(s):Array.isArray(s)?s:null,l.productTags==null&&e.hasAttribute(d.prod_tags)){let h=e.getAttribute(d.prod_tags);l.productTags=B(h)||R(h)}o=e.getAttribute(d.cache_seconds)||o,typeof o=="string"&&(o=Number(o)||300),l.cacheSeconds=typeof o=="number"?Math.max(Math.trunc(o),0):0,l.preClearCache=e.hasAttribute(d.pre_clear_cache),typeof w=="string"&&(l.url=w),typeof t=="function"&&(l.fetchData=t);let C=e.querySelector("form[data-ezs-form]");return C&&(l.filterForm=C,l.filterFormSubmitBtn=C.querySelector('[type="submit"]')),l}function re(e){return __async(this,null,function*(){const{filterSelects:t,filterKeys:r,url:i,fetchData:c,collectionHandle:s,filterForm:o,filterFormSubmitBtn:m,rootNode:_,onEvent:A,autoSearch:l,productTags:b,cacheSeconds:w,preClearCache:C,gotoPendingBtns:h,gotoBaseCollectionBtns:K,loadingBtnClass:le,toggleOpenBtns:ye,filteredLinks:me,filteredTitle:ve,hasCsvHeaders:Ae,triggerVerifyBtns:Ee,isFitmentWidget:Se,filterKeysSortBy:be}=ge(e);if(_.__ezs_hydrated){O("Already hydrated");return}_.__ezs_hydrated=!0;const Z=[()=>{_.__ezs_hydrated=!1}],ne=`/collections/${s}`,ie=w&&w>0,ae=b&&b.length>0?b.reduce((a,g)=>(a[g]=!0,a),{}):null,E=new Map(Array.from({length:r.length},(a,g)=>[r[g],!ie||C?"":N(r[g])||""]));let D=null;function G({selectIndex:a,updateSelectValue:g=!1,forcePending:n=!1}={}){let u=[...E];u.forEach(([y,p],I)=>{const v=de({selectedValues:u,index:I,filterTree:D});v?.[p]||E.set(y,"");const L=I>a,f=t[I],S=v?._keys_||[],X=Array.isArray(S)&&S.length>0;f.disabled=!X,ie&&(p?ee(y,p,w):x(y)),(a===-1||g?!1:L?S.length===f.options.length-1&&S.every((V,Y)=>V===f.options[Y+1].value):!0)||(f.options.length=1,requestAnimationFrame(()=>{S.forEach((V,Y)=>{f.options[Y+1]=new Option(V,V)}),f.value=E.get(y)}))}),(l||n||a===-1)&&H({forcePending:n,preventAutosearch:a===-1,activeFiltersList:u}),A?.("SELECTION_UPDATE",{index:a,select:t[a]})}function H({forcePending:a=!1,fromCache:g=!1,preventAutosearch:n=!1,activeFiltersList:u}={}){let y=(u||[...E]).every(([,f])=>!!f);_.setAttribute("data-ezs-selected-filters",y?"all":"partial");let p=a?null:g?B(N("selectedItem"),"null"):he({keys:r,activeFilters:E,filterTree:D}),I=p?._path;if(ae){let f=p?._tag,S=ae[f];_.setAttribute("data-ezs-state",p?S?"valid":"invalid":"pending")}o&&(I?(o.action=I,m&&(m.disabled=!1)):(o.removeAttribute("action"),m&&(m.disabled=!0))),p&&(A?.("SELECTION_COMPLETE",{selected:p}),_.dispatchEvent(new CustomEvent("EZSearch_Selected",{detail:{selected:p},bubbles:!1,cancelable:!1}))),me.forEach(f=>{I?(f.setAttribute("href",p?._path),f.disabled=!0):(f.removeAttribute("href"),f.disabled=!0)});let v=p?r.map(f=>E.get(f)).join(" "):"";ve.forEach(f=>{f.textContent=v}),p?ee("selectedItem",JSON.stringify(p)):x("selectedItem");let L=I&&o&&l&&!n;L&&(document.body.setAttribute("data-ezs-navigating",""),L&&o.submit())}function we(a){var g;let n=(g=a?.target)==null?void 0:g.__ezs_index;if(typeof n!="number"){O.warn("no `__ezs_index` found");return}const u=r[n],p=t[n].value;p?E.set(u,p):E.set(u,""),G({selectIndex:n})}function se(a,g){if(!E.has(a))return;typeof g=="string"?g=g.trim():g="";let u=T(a,E);u!=null&&(E.set(a,g),G({selectIndex:u,updateSelectValue:!0,forcePending:!0}))}function M(){x("selectedItem"),r.forEach(a=>x(a))}function Ce(a){let g=a.map((n,u)=>{n.__ezs_index=u;let y=n.options[0];return y?(y.value="",y):(y=new Option("All","",!0,!0),y)});a.forEach((n,u)=>{let y=q(n,"change",we);Z.push(y),n.options.length=1,n.options[0]=g[u]}),Z.push(...Ee.map(n=>(n.disabled&&(n.disabled=!1),q(n,"click",()=>{H()}))),...h.map(n=>(n.disabled&&(n.disabled=!1),q(n,"click",()=>{n.__ezs_clear_cache&&(M(),se(r[0],"")),H({forcePending:!0}),a[0].focus()}))),...K.map(n=>(n.disabled&&(n.disabled=!1),q(n,"click",()=>{n.disabled=!0,n.__ezs_clear_cache&&M(),o?(o.action=ne,o.submit()):window.location.href=ne}))),...ye.map(n=>q(n,"click",()=>{_.classList.toggle("is-open")})),q(_,"click",n=>{let u=n?.target;u&&u.__ezs_loadable&&le?.forEach(y=>{u.classList.add(y)})})),G({selectIndex:-1})}function ze(){return __async(this,null,function*(){let a=te[i];if(a)return a;let g=j(i,c).then(n=>{if(n.length===0)return n;(Ae||r.every((v,L)=>n[0][L]===v))&&(n=n.slice(1));let u=!0,y=r.length,p=n.map(v=>(u&&v.length-1!==y&&(O.error("CSV data and `filterKeys` mismatch",{filterKeys:r,line:v}),u=!1),u?v.reduce((f,S,X)=>{let Q=r[X];return Q?f[Q]=S:(f._path=s?S.replace("/all/",`/${s}/`):S,f._tag=oe(S.split("/"))),f},{}):[]));if(!u)throw new Error("CSV data and `filterKeys` mismatch");return ue({data:p,activeFilters:[...E],path:[],keys:r,keysSort:be,getValue:(v,L,f)=>v[f]})});return te[i]=g,g})}function Oe(){Se&&H({fromCache:!0})}function Te(){_.setAttribute("data-ezs-loaded","true")}function Ie(){return __async(this,null,function*(){return C&&M(),Oe(),ze().then(a=>__async(this,null,function*(){D=a,Ce(t)})).then(()=>{Te()})})}return Ie().then(()=>({filterTree:D,getActiveFilters(){return[...E]},updateFilterValue:se,clearAllCache:M,destory(){t.forEach(a=>{a.options.length=1}),Z.forEach(a=>a()),Z.length=1}}))})}var Le="";window.EZSearchDefaultInstances=[];function pe(){Array.from(document.querySelectorAll('[data-ezs="search"]:not([data-ezs-auto-initialize="false"])')).forEach(t=>{document.dispatchEvent(new CustomEvent("EZSearch_Loading",{detail:t})),re({rootNode:t,onEvent:null}).then(r=>{window.EZSearchDefaultInstances.push(r),document.dispatchEvent(new CustomEvent("EZSearch_Loaded",{detail:t}))})})}ce().then(pe);var _e={hydrate:re};return _e});
