var __async=(K,P,k)=>new Promise((F,Z)=>{var N=$=>{try{R(k.next($))}catch(D){Z(D)}},U=$=>{try{R(k.throw($))}catch(D){Z(D)}},R=$=>$.done?F($.value):Promise.resolve($.value).then(N,U);R((k=k.apply(K,P)).next())});(function(K,P){typeof exports=="object"&&typeof module<"u"?module.exports=P():typeof define=="function"&&define.amd?define(P):(K=typeof globalThis<"u"?globalThis:K||self,K.EZSearch=P())})(this,function(){"use strict";const K=e=>Object.prototype.toString.call(e).slice(8,-1),P=e=>K(e)==="Object";let k="[EZSearch] :: ";function F(...e){return console.log(k,...e)}F.warn=(...e)=>console.warn(k,...e),F.info=(...e)=>console.info(k,...e),F.error=(...e)=>console.error(k,...e);function Z(e){let r=[],t=!1;for(let l=0,a=0,o=0;o<e.length;o++){let c=e[o],_=e[o+1];if(r[l]=r[l]||[],r[l][a]=r[l][a]||"",c=='"'&&t&&_=='"'){r[l][a]+=c,++o;continue}if(c=='"'){t=!t;continue}if(c==","&&!t){++a;continue}if(c=="\r"&&_==`
`&&!t){++l,a=0,++o;continue}if(c==`
`&&!t){++l,a=0;continue}if(c=="\r"&&!t){++l,a=0;continue}r[l][a]+=c}return r}function N(e,r){return __async(this,null,function*(){if(typeof r=="function")return r(e).then(a=>typeof a=="string"?Z(a):a);let t=yield fetch(e.replace(/\\\//g,"/"));if(!t.ok)return F("Unable to fetch CSV"),null;let l=yield t.text();return Z(l)})}function U(e){return typeof e=="string"&&e.split(/,\s*/),null}function R(e,r="null"){try{return JSON.parse(e||r)}catch{return typeof r=="string"?JSON.parse(r):r}}function $(e,r){let t=0,l=null;return r.forEach((a,o)=>{o===e&&l==null&&(l=t),t++}),l}const D={ATTR:{id:"data-ezs-id",legacy_search:"data-legacy-search",filter:"data-ezs-filter",csv_url:"data-ezs-csv-url",coll_handle:"data-ezs-collection-handle",rest_next_selects_on_change:"data-ezs-reset-next-selects-on-change",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",filtered_title:"data-ezs-filtered-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_cache:"data-ezs-clear-cache",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function ie(e){return e[e.length-1]}const pe=()=>new Promise(e=>{document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",()=>e())});function V(e,r,t,l,a=!1){return l!=null?e.addEventListener(r,t,l):e.addEventListener(r,t),a&&t(),function(){e.removeEventListener(r,t)}}function ee(e,r,t=0){if(P(e)){let l=Object.keys(e);l.forEach(a=>{let o=e[a];ee(o,r,t+1)}),r(e,l,t)}return Array.isArray(e)&&e.forEach(l=>{ee(l,r,t)}),e}function _e({data:e,keys:r=[],path:t=[],keysSort:l=[]}){let a={};return r.forEach((o,c)=>{let _=c===r.length-1;e.forEach(S=>{if(!S)return;let y=t.reduce((I,i)=>I[i],S);if(!y)return;let v=y[o];if(typeof v=="number"&&(v=v.toString()),typeof v!="string"||v==="")return;let w=r.slice(0,c).reduce((I,i)=>I[y[i]],a);if(w)if(_){const I=new ae(S);w[v]?Array.isArray(w[v])?w[v].push(I):w[v]=[w[v],I]:w[v]=I}else w[v]={}})}),Object.keys(a).length>0?ee(a,(o,c,_)=>{var S;if(!o._tag){const y=(S=l[_])==null?void 0:S.desc;o._keys_=c.sort((v,w)=>y?w.localeCompare(v):v.localeCompare(w))}}):a}function ye(e,r){if(r<0||r>=e.length)return!1;let t=e.slice(0,r);return Array.isArray(e[0])?t.every(([a,o])=>!!o):t.every(a=>!!a)}function me({selectedValues:e,index:r,filterTree:t}){let l=ye(e,r);if(!l)return null;if(l){const a=Array.isArray(e[0]);return e.slice(0,r).reduce((c,_)=>{if(c==null)return null;let S=a?_[1]:_;return c[S]},t)}}function ve({keys:e,filterTree:r,activeFilters:t}){return e.reduce((l,a)=>{let o=t.get(a);return o&&l?.[o]||null},r)}class ae{constructor(r){this.value=r}}const te=e=>`ezs_${e}`,re=e=>`${e}__expiresIn`;function H(e){const r=te(e);return window.localStorage.removeItem(r),window.localStorage.removeItem(re(r)),!0}function se(e){const r=te(e);let t=Date.now();return Number(window.localStorage.getItem(re(r))||"0")<t?(H(r),null):window.localStorage.getItem(r)}function oe(e,r,t=60*5){const l=te(e);t=Math.abs(t);let o=Date.now()+t*1e3;return window.localStorage.setItem(l,r),window.localStorage.setItem(re(l),o),!0}const{ATTR:f}=D;let ce={};function be({legacySearch:e,url:r=void 0,rootNode:t,fetchData:l,collectionHandle:a,onEvent:o,resetNextSelectsOnChange:c=!1,autoSearch:_=!1,productTags:S=null,cacheSeconds:y=300,hasCsvHeaders:v=!1,isFitmentWidget:w=!1,loadingBtnClass:I="btn--loading"}={}){let i={__validated:!0};if(!(t instanceof HTMLElement))throw new Error("rootNode must be specified");i.rootNode=t,typeof e>"u"&&(e=t.getAttribute(f.legacy_search)),i.legacySearch=typeof e=="boolean"?e:e==="true"?!0:e!=="false";let J=t.getAttribute(f.id)||"";if(i.filterSelects=Array.from(t.querySelectorAll(`select[${f.filter}]`)).map(b=>(b.setAttribute(f.filter,(b.getAttribute(f.filter)||"")+J),b)),i.filterKeys=i.filterSelects.map(b=>b.getAttribute(f.filter)).filter(Boolean),i.filterKeys.length<1||i.filterSelects.length!==i.filterKeys.length)throw new Error("Filter keys/selects mismatch");if(i.filterKeysSortBy=i.filterSelects.map(b=>{let q=b.getAttribute(f.sort_by)==="desc";return{desc:q,asc:!q}}),(typeof r!="string"||!r.trim())&&(r=t.getAttribute(f.csv_url),typeof r!="string"&&!l))throw new Error("URL or `fetchData` must be specified");if(i.collectionHandle=typeof a=="string"?a:t.getAttribute(f.coll_handle)||"all",i.onEvent=typeof o=="function"?o:null,i.autoSearch=!!_||t.hasAttribute(f.auto_search),i.resetNextSelectsOnChange=!!c||t.hasAttribute(f.rest_next_selects_on_change),i.hasCsvHeaders=!!v||t.hasAttribute(f.csv_headers),i.isFitmentWidget=!!w||t.hasAttribute(f.fitment_widget),i.loadingBtnClass=(typeof I=="string"?I:t.getAttribute(f.loading_btn_class)||"").split(" ").filter(Boolean),i.loadingBtnClass.length===0&&(i.loadingBtnClass=null),i.filteredLinks=Array.from(t.querySelectorAll(`a[${f.filtered_link}]`)),i.filteredTitle=Array.from(t.querySelectorAll(`[${f.filtered_title}]`)),i.triggerVerifyBtns=Array.from(t.querySelectorAll(`[${f.filter_trigger_verify}]`)),i.toggleOpenBtns=Array.from(t.querySelectorAll(`[${f.toggle_open}]`)),Array.from(t.querySelectorAll(`[${f.loading_on_click}]`)).forEach(b=>{b.__ezs_loadable=!0}),i.gotoPendingBtns=Array.from(t.querySelectorAll(`[${f.goto_pending}]`)).map(b=>(b.hasAttribute(f.clear_cache)&&(b.__ezs_clear_cache=!0),b)),i.gotoBaseCollectionBtns=Array.from(t.querySelectorAll(`[${f.goto_base_collection}]`)).map(b=>(b.hasAttribute(f.clear_cache)&&(b.__ezs_clear_cache=!0),b)),i.productTags=typeof S=="string"?U(S):Array.isArray(S)?S:null,i.productTags==null&&t.hasAttribute(f.prod_tags)){let b=t.getAttribute(f.prod_tags);i.productTags=R(b)||U(b)}y=t.getAttribute(f.cache_seconds)||y,typeof y=="string"&&(y=Number(y)||300),i.cacheSeconds=typeof y=="number"?Math.max(Math.trunc(y),0):0,i.preClearCache=t.hasAttribute(f.pre_clear_cache),typeof r=="string"&&(i.url=r),typeof l=="function"&&(i.fetchData=l);let M=t.querySelector("form[data-ezs-form]");return M&&(i.filterForm=M,i.filterFormSubmitBtn=M.querySelector('[type="submit"]')),i}function ue(e){return __async(this,null,function*(){const{legacySearch:r,filterSelects:t,filterKeys:l,url:a,fetchData:o,collectionHandle:c,filterForm:_,filterFormSubmitBtn:S,rootNode:y,onEvent:v,autoSearch:w,productTags:I,cacheSeconds:i,preClearCache:J,gotoPendingBtns:M,gotoBaseCollectionBtns:b,loadingBtnClass:q,toggleOpenBtns:Ee,filteredLinks:Se,filteredTitle:Ce,hasCsvHeaders:we,triggerVerifyBtns:ze,isFitmentWidget:Oe,filterKeysSortBy:Ie,resetNextSelectsOnChange:fe}=e.__validated?e:be(e);if(y.__ezs_hydrated){F("Already hydrated");return}y.__ezs_hydrated=!0;const W=[()=>{y.__ezs_hydrated=!1}],de=`/collections/${c}`,he=i&&i>0,j=I&&I.length>0?I.reduce((s,A)=>(s[A]=!0,s),{}):null,O=new Map(Array.from({length:l.length},(s,A)=>[l[A],!he||J?"":se(l[A])||""]));let Y=null;function le({selectIndex:s,updateSelectValue:A=!1,forcePending:n=!1}={}){let d=[...O];d.forEach(([m,h],L)=>{const T=me({selectedValues:d,index:L,filterTree:Y});T?.[h]||O.set(m,"");const g=L>s,u=t[L],z=T?._keys_||[],p=Array.isArray(z)&&z.length>0;u.disabled=!p,he&&(h?oe(m,h,i):H(m)),(s===-1||A?!1:g?fe?!1:z.length===u.options.length-1&&z.every((E,C)=>E===u.options[C+1].value):!0)||(u.options.length=1,requestAnimationFrame(()=>{z.forEach((E,C)=>{u.options[C+1]=new Option(E,E)}),u.value=O.get(m)}))}),(w||n||s===-1)&&G({forcePending:n,preventAutosearch:s===-1,activeFiltersList:d}),v?.("SELECTION_UPDATE",{index:s,select:t[s]})}function G({forcePending:s=!1,fromCache:A=!1,preventAutosearch:n=!1}={}){let d=[...O].every(([,p])=>!!p);y.setAttribute("data-ezs-selected-filters",d?"all":"partial");let m=s?null:A?R(se("selectedItem"),"null"):ve({keys:l,activeFilters:O,filterTree:Y}),h=m instanceof ae?m.value:null;Array.isArray(m)&&(h=((j?m.find(p=>{var B;const E=(B=p.value)==null?void 0:B._tag;return!!j[E]}):null)||m[0]).value);let L=h?._path,T=h?._tag,g=j?j[T]:null;if(y.setAttribute("data-ezs-state",h?g?"valid":"invalid":"pending"),_){let p=null;r||(p=_._filter_p_tag_el,p||(p=document.createElement("input"),p.setAttribute("type","hidden"),p.setAttribute("name","filter.p.tag"),_._filter_p_tag_el=p,_.appendChild(p))),p&&(p.value=T||""),L?(_.action=L,S&&(S.disabled=!1)):(_.removeAttribute("action"),S&&(S.disabled=!0))}h&&(v?.("SELECTION_COMPLETE",{selected:h}),y.dispatchEvent(new CustomEvent("EZSearch_Selected",{detail:{selected:h,fits:g==null?void 0:!!g},bubbles:!1,cancelable:!1}))),Se.forEach(p=>{L?(p.setAttribute("href",h?._path),p.disabled=!0):(p.removeAttribute("href"),p.disabled=!0)});let u=h?l.map(p=>O.get(p)).join(" "):"";Ce.forEach(p=>{p.textContent=u}),h?oe("selectedItem",JSON.stringify(h)):H("selectedItem");let z=L&&_&&w&&!n;z&&(document.body.setAttribute("data-ezs-navigating",""),z&&_.submit())}function Le(s){var A;let n=(A=s?.target)==null?void 0:A.__ezs_index;if(typeof n!="number"){F.warn("no `__ezs_index` found");return}const d=l[n],h=t[n].value;h?O.set(d,h):O.set(d,""),fe&&[...O].forEach(([L],T)=>{T>n&&O.set(L,"")}),le({selectIndex:n})}function ge(s,A){if(!O.has(s))return;typeof A=="string"?A=A.trim():A="";let d=$(s,O);d!=null&&(O.set(s,A),le({selectIndex:d,updateSelectValue:!0,forcePending:!0}))}function X(){H("selectedItem"),l.forEach(s=>H(s))}function Te(s){let A=s.map((n,d)=>{n.__ezs_index=d;let m=n.options[0];return m?(m.value="",m):(m=new Option("All","",!0,!0),m)});s.forEach((n,d)=>{let m=V(n,"change",Le);W.push(m),n.options.length=1,n.options[0]=A[d]}),W.push(...ze.map(n=>(n.disabled&&(n.disabled=!1),V(n,"click",()=>{G()}))),...M.map(n=>(n.disabled&&(n.disabled=!1),V(n,"click",()=>{n.__ezs_clear_cache&&(X(),ge(l[0],"")),G({forcePending:!0}),s[0].focus()}))),...b.map(n=>(n.disabled&&(n.disabled=!1),V(n,"click",()=>{n.disabled=!0,n.__ezs_clear_cache&&X(),_?(_.action=de,_.submit()):window.location.href=de}))),...Ee.map(n=>V(n,"click",()=>{y.classList.toggle("is-open")})),V(y,"click",n=>{let d=n?.target;d&&d.__ezs_loadable&&q?.forEach(m=>{d.classList.add(m)})})),le({selectIndex:-1})}function Fe(){return __async(this,null,function*(){let s=ce[a];if(s)return s;if(!a){F.error("no `url` found"),y.classList.add("is-invalid"),y.style.display="none";return}let A=N(a,o).then(n=>{if(n.length===0)return n;(we||l.every((g,u)=>n[0][u]===g))&&(n=n.slice(1));let d=!0,m=l.length,h=l.findIndex(g=>g.toLowerCase()==="year");h!==-1&&(n=n.reduce((g,u)=>{const z=u[h];if(!z.includes("-"))return g.push(u),g;let[B,E]=z.split("-").map(C=>Number(C)).reduce((C,x)=>(C.push(Number.isNaN(x)?null:x),C),[]);if(B&&E){for(let C=B;C<=E;C++)g.push(u.map((x,Q)=>Q===h?C:x));return g}return!E&&B&&g.push(u.map((C,x)=>x===h?B:C)),g},[]));let L=n.map(g=>{if(d&&g.length-1!==m&&(F.error("CSV data and `filterKeys` mismatch",{filterKeys:l,line:g}),d=!1),!d)return[];let u=g[l.length];u.startsWith(">>")&&(u=u.slice(2),g[l.length]=u);const z="/collections/all/";if(u.startsWith(z)&&(u=u.slice(z.length)),u.includes("$$$")){const[E]=u.split("$$$");if(E)u=E,g[l.length]=u;else return[]}return g.reduce((E,C,x)=>{let Q=l[x];if(Q)E[Q]=C;else{const ne=ie(C.split("/"));E._path=`/collections/${c||"all"}/${ne}`,E._tag=ie(ne.split("/")),r||(E._path=`/collections/${c||"all"}?filter.p.tag=${ne}`)}return E},{})});if(!d)throw new Error("CSV data and `filterKeys` mismatch");return _e({data:L,activeFilters:[...O],path:[],keys:l,keysSort:Ie,getValue:(g,u,z)=>g[z]})});return ce[a]=A,A})}function ke(){Oe&&G({fromCache:!0})}function $e(){y.setAttribute("data-ezs-loaded","true")}function Be(){return __async(this,null,function*(){return J&&X(),ke(),Fe().then(s=>__async(this,null,function*(){Y=s,Te(t)})).then(()=>{$e()})})}return Be().then(()=>({filterTree:Y,getActiveFilters(){return[...O]},updateFilterValue:ge,clearAllCache:X,prodcutTagsLookup:j,destory(){t.forEach(s=>{s.options.length=1}),W.forEach(s=>s()),W.length=1}}))})}const xe="";window.EZSearchDefaultInstances=[];function Ae(){return __async(this,null,function*(){Array.from(document.querySelectorAll('[data-ezs="search"]:not([data-ezs-auto-initialize="false"])')).forEach(r=>__async(this,null,function*(){var t,l;document.dispatchEvent(new CustomEvent("EZSearch_Loading",{detail:r}));const a=r.getAttribute("data-ezs-config-url");let o="";if(a){const c=yield fetch(a).then(_=>_.json());(l=(t=c?.settings)==null?void 0:t.form)!=null&&l.db&&(o=c.settings.form.db)}ue({url:o,rootNode:r,onEvent:null}).then(c=>{window.EZSearchDefaultInstances.push(c),document.dispatchEvent(new CustomEvent("EZSearch_Loaded",{detail:r}))})}))})}return pe().then(Ae),{hydrate:ue}});
