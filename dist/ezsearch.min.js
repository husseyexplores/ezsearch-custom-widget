var __async=(F,k,z)=>new Promise((C,K)=>{var U=O=>{try{x(z.next(O))}catch(P){K(P)}},D=O=>{try{x(z.throw(O))}catch(P){K(P)}},x=O=>O.done?C(O.value):Promise.resolve(O.value).then(U,D);x((z=z.apply(F,k)).next())});(function(F,k){typeof exports=="object"&&typeof module<"u"?module.exports=k():typeof define=="function"&&define.amd?define(k):(F=typeof globalThis<"u"?globalThis:F||self,F.EZSearch=k())})(this,function(){"use strict";const F=e=>Object.prototype.toString.call(e).slice(8,-1),k=e=>F(e)==="Object";let z="[EZSearch] :: ";function C(...e){return console.log(z,...e)}C.warn=(...e)=>console.warn(z,...e),C.info=(...e)=>console.info(z,...e),C.error=(...e)=>console.error(z,...e);function K(e){let t=[],r=!1;for(let n=0,a=0,o=0;o<e.length;o++){let u=e[o],h=e[o+1];if(t[n]=t[n]||[],t[n][a]=t[n][a]||"",u=='"'&&r&&h=='"'){t[n][a]+=u,++o;continue}if(u=='"'){r=!r;continue}if(u==","&&!r){++a;continue}if(u=="\r"&&h==`
`&&!r){++n,a=0,++o;continue}if(u==`
`&&!r){++n,a=0;continue}if(u=="\r"&&!r){++n,a=0;continue}t[n][a]+=u}return t}function U(e,t){return __async(this,null,function*(){if(typeof t=="function")return t(e).then(a=>typeof a=="string"?K(a):a);let r=yield fetch(e.replace(/\\\//g,"/"));if(!r.ok)return C("Unable to fetch CSV"),null;let n=yield r.text();return K(n)})}function D(e){return typeof e=="string"&&e.split(/,\s*/),null}function x(e,t="null"){try{return JSON.parse(e||t)}catch{return typeof t=="string"?JSON.parse(t):t}}function O(e,t){let r=0,n=null;return t.forEach((a,o)=>{o===e&&n==null&&(n=r),r++}),n}const P={ATTR:{id:"data-ezs-id",filter:"data-ezs-filter",csv_url:"data-ezs-csv-url",coll_handle:"data-ezs-collection-handle",rest_next_selects_on_change:"data-ezs-reset-next-selects-on-change",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",filtered_title:"data-ezs-filtered-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_cache:"data-ezs-clear-cache",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function oe(e){return e[e.length-1]}const ue=()=>new Promise(e=>{document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",()=>e())});function q(e,t,r,n,a=!1){return n!=null?e.addEventListener(t,r,n):e.addEventListener(t,r),a&&r(),function(){e.removeEventListener(t,r)}}function J(e,t,r=0){if(k(e)){let n=Object.keys(e);n.forEach(a=>{let o=e[a];J(o,t,r+1)}),t(e,n,r)}return Array.isArray(e)&&e.forEach(n=>{J(n,t,r)}),e}function fe({data:e,keys:t=[],path:r=[],keysSort:n=[]}){let a={};return t.forEach((o,u)=>{let h=u===t.length-1;e.forEach(g=>{if(!g)return;let b=r.reduce((L,w)=>L[w],g);if(!b)return;let A=b[o];if(typeof A=="number"&&(A=A.toString()),typeof A!="string"||A==="")return;let i=t.slice(0,u).reduce((L,w)=>L[b[w]],a);i&&(i[A]=h?g:{})})}),Object.keys(a).length>0?J(a,(o,u,h)=>{var g;if(!o._tag){const b=(g=n[h])==null?void 0:g.desc;o._keys_=u.sort((A,i)=>b?i.localeCompare(A):A.localeCompare(i))}}):a}function de(e,t){if(t<0||t>=e.length)return!1;let r=e.slice(0,t);return Array.isArray(e[0])?r.every(([a,o])=>!!o):r.every(a=>!!a)}function he({selectedValues:e,index:t,filterTree:r}){let n=de(e,t);if(!n)return null;if(n){const a=Array.isArray(e[0]);return e.slice(0,t).reduce((u,h)=>{if(u==null)return null;let g=a?h[1]:h;return u[g]},r)}}function ge({keys:e,filterTree:t,activeFilters:r}){return e.reduce((n,a)=>{let o=r.get(a);return o&&n?.[o]||null},t)}const W=e=>`ezs_${e}`,G=e=>`${e}__expiresIn`;function R(e){const t=W(e);return window.localStorage.removeItem(t),window.localStorage.removeItem(G(t)),!0}function te(e){const t=W(e);let r=Date.now();return Number(window.localStorage.getItem(G(t))||"0")<r?(R(t),null):window.localStorage.getItem(t)}function re(e,t,r=60*5){const n=W(e);r=Math.abs(r);let o=Date.now()+r*1e3;return window.localStorage.setItem(n,t),window.localStorage.setItem(G(n),o),!0}const{ATTR:f}=P;let le={};function _e({rootNode:e,fetchData:t,collectionHandle:r,onEvent:n,resetNextSelectsOnChange:a=!1,autoSearch:o=!1,productTags:u=null,cacheSeconds:h=300,hasCsvHeaders:g=!1,isFitmentWidget:b=!1,loadingBtnClass:A="btn--loading"}={}){let i={};if(!(e instanceof HTMLElement))throw new Error("rootNode must be specified");i.rootNode=e;let L=e.getAttribute(f.id)||"";if(i.filterSelects=Array.from(e.querySelectorAll(`select[${f.filter}]`)).map(_=>(_.setAttribute(f.filter,(_.getAttribute(f.filter)||"")+L),_)),i.filterKeys=i.filterSelects.map(_=>_.getAttribute(f.filter)).filter(Boolean),i.filterKeys.length<1||i.filterSelects.length!==i.filterKeys.length)throw new Error("Filter keys/selects mismatch");i.filterKeysSortBy=i.filterSelects.map(_=>{let B=_.getAttribute(f.sort_by)==="desc";return{desc:B,asc:!B}});let w=e.getAttribute(f.csv_url);if(typeof w!="string"&&!t)throw new Error("URL or `fetchData` must be specified");if(i.collectionHandle=typeof r=="string"?r:e.getAttribute(f.coll_handle)||"all",i.onEvent=typeof n=="function"?n:null,i.autoSearch=!!o||e.hasAttribute(f.auto_search),i.resetNextSelectsOnChange=!!a||e.hasAttribute(f.rest_next_selects_on_change),i.hasCsvHeaders=!!g||e.hasAttribute(f.csv_headers),i.isFitmentWidget=!!b||e.hasAttribute(f.fitment_widget),i.loadingBtnClass=(typeof A=="string"?A:e.getAttribute(f.loading_btn_class)||"").split(" ").filter(Boolean),i.loadingBtnClass.length===0&&(i.loadingBtnClass=null),i.filteredLinks=Array.from(e.querySelectorAll(`a[${f.filtered_link}]`)),i.filteredTitle=Array.from(e.querySelectorAll(`[${f.filtered_title}]`)),i.triggerVerifyBtns=Array.from(e.querySelectorAll(`[${f.filter_trigger_verify}]`)),i.toggleOpenBtns=Array.from(e.querySelectorAll(`[${f.toggle_open}]`)),Array.from(e.querySelectorAll(`[${f.loading_on_click}]`)).forEach(_=>{_.__ezs_loadable=!0}),i.gotoPendingBtns=Array.from(e.querySelectorAll(`[${f.goto_pending}]`)).map(_=>(_.hasAttribute(f.clear_cache)&&(_.__ezs_clear_cache=!0),_)),i.gotoBaseCollectionBtns=Array.from(e.querySelectorAll(`[${f.goto_base_collection}]`)).map(_=>(_.hasAttribute(f.clear_cache)&&(_.__ezs_clear_cache=!0),_)),i.productTags=typeof u=="string"?D(u):Array.isArray(u)?u:null,i.productTags==null&&e.hasAttribute(f.prod_tags)){let _=e.getAttribute(f.prod_tags);i.productTags=x(_)||D(_)}h=e.getAttribute(f.cache_seconds)||h,typeof h=="string"&&(h=Number(h)||300),i.cacheSeconds=typeof h=="number"?Math.max(Math.trunc(h),0):0,i.preClearCache=e.hasAttribute(f.pre_clear_cache),typeof w=="string"&&(i.url=w),typeof t=="function"&&(i.fetchData=t);let Z=e.querySelector("form[data-ezs-form]");return Z&&(i.filterForm=Z,i.filterFormSubmitBtn=Z.querySelector('[type="submit"]')),i}function ne(e){return __async(this,null,function*(){const{filterSelects:t,filterKeys:r,url:n,fetchData:a,collectionHandle:o,filterForm:u,filterFormSubmitBtn:h,rootNode:g,onEvent:b,autoSearch:A,productTags:i,cacheSeconds:L,preClearCache:w,gotoPendingBtns:Z,gotoBaseCollectionBtns:_,loadingBtnClass:B,toggleOpenBtns:ye,filteredLinks:me,filteredTitle:ve,hasCsvHeaders:Ae,triggerVerifyBtns:Se,isFitmentWidget:Ee,filterKeysSortBy:be,resetNextSelectsOnChange:ie}=_e(e);if(g.__ezs_hydrated){C("Already hydrated");return}g.__ezs_hydrated=!0;const H=[()=>{g.__ezs_hydrated=!1}],ae=`/collections/${o}`,se=L&&L>0,X=i&&i.length>0?i.reduce((s,p)=>(s[p]=!0,s),{}):null,S=new Map(Array.from({length:r.length},(s,p)=>[r[p],!se||w?"":te(r[p])||""]));let M=null;function Q({selectIndex:s,updateSelectValue:p=!1,forcePending:l=!1}={}){let d=[...S];d.forEach(([c,E],I)=>{const m=he({selectedValues:d,index:I,filterTree:M});m?.[E]||S.set(c,"");const $=I>s,v=t[I],y=m?._keys_||[],Y=Array.isArray(y)&&y.length>0;v.disabled=!Y,se&&(E?re(c,E,L):R(c)),(s===-1||p?!1:$?ie?!1:y.length===v.options.length-1&&y.every((T,ee)=>T===v.options[ee+1].value):!0)||(v.options.length=1,requestAnimationFrame(()=>{y.forEach((T,ee)=>{v.options[ee+1]=new Option(T,T)}),v.value=S.get(c)}))}),(A||l||s===-1)&&V({forcePending:l,preventAutosearch:s===-1,activeFiltersList:d}),b?.("SELECTION_UPDATE",{index:s,select:t[s]})}function V({forcePending:s=!1,fromCache:p=!1,preventAutosearch:l=!1}={}){let d=[...S].every(([,y])=>!!y);g.setAttribute("data-ezs-selected-filters",d?"all":"partial");let c=s?null:p?x(te("selectedItem"),"null"):ge({keys:r,activeFilters:S,filterTree:M}),E=c?._path,I=c?._tag,m=X?X[I]:null;g.setAttribute("data-ezs-state",c?m?"valid":"invalid":"pending"),u&&(E?(u.action=E,h&&(h.disabled=!1)):(u.removeAttribute("action"),h&&(h.disabled=!0))),c&&(b?.("SELECTION_COMPLETE",{selected:c}),g.dispatchEvent(new CustomEvent("EZSearch_Selected",{detail:{selected:c},bubbles:!1,cancelable:!1}))),me.forEach(y=>{E?(y.setAttribute("href",c?._path),y.disabled=!0):(y.removeAttribute("href"),y.disabled=!0)});let $=c?r.map(y=>S.get(y)).join(" "):"";ve.forEach(y=>{y.textContent=$}),c?re("selectedItem",JSON.stringify(c)):R("selectedItem");let v=E&&u&&A&&!l;v&&(document.body.setAttribute("data-ezs-navigating",""),v&&u.submit())}function Ce(s){var p;let l=(p=s?.target)==null?void 0:p.__ezs_index;if(typeof l!="number"){C.warn("no `__ezs_index` found");return}const d=r[l],E=t[l].value;E?S.set(d,E):S.set(d,""),ie&&[...S].forEach(([I],m)=>{m>l&&S.set(I,"")}),Q({selectIndex:l})}function ce(s,p){if(!S.has(s))return;typeof p=="string"?p=p.trim():p="";let d=O(s,S);d!=null&&(S.set(s,p),Q({selectIndex:d,updateSelectValue:!0,forcePending:!0}))}function j(){R("selectedItem"),r.forEach(s=>R(s))}function we(s){let p=s.map((l,d)=>{l.__ezs_index=d;let c=l.options[0];return c?(c.value="",c):(c=new Option("All","",!0,!0),c)});s.forEach((l,d)=>{let c=q(l,"change",Ce);H.push(c),l.options.length=1,l.options[0]=p[d]}),H.push(...Se.map(l=>(l.disabled&&(l.disabled=!1),q(l,"click",()=>{V()}))),...Z.map(l=>(l.disabled&&(l.disabled=!1),q(l,"click",()=>{l.__ezs_clear_cache&&(j(),ce(r[0],"")),V({forcePending:!0}),s[0].focus()}))),..._.map(l=>(l.disabled&&(l.disabled=!1),q(l,"click",()=>{l.disabled=!0,l.__ezs_clear_cache&&j(),u?(u.action=ae,u.submit()):window.location.href=ae}))),...ye.map(l=>q(l,"click",()=>{g.classList.toggle("is-open")})),q(g,"click",l=>{let d=l?.target;d&&d.__ezs_loadable&&B?.forEach(c=>{d.classList.add(c)})})),Q({selectIndex:-1})}function ze(){return __async(this,null,function*(){let s=le[n];if(s)return s;if(!n){C.error("no `url` found"),g.classList.add("is-invalid"),g.style.display="none";return}let p=U(n,a).then(l=>{if(l.length===0)return l;(Ae||r.every((m,$)=>l[0][$]===m))&&(l=l.slice(1));let d=!0,c=r.length,E=l.map(m=>(d&&m.length-1!==c&&(C.error("CSV data and `filterKeys` mismatch",{filterKeys:r,line:m}),d=!1),d?m.reduce((v,y,Y)=>{let N=r[Y];if(N)v[N]=y;else{const T=y.split("$$$url")[0];v._path=o?T.replace("/all/",`/${o}/`):T,v._tag=oe(T.split("/"))}return v},{}):[]));if(!d)throw new Error("CSV data and `filterKeys` mismatch");return fe({data:E,activeFilters:[...S],path:[],keys:r,keysSort:be,getValue:(m,$,v)=>m[v]})});return le[n]=p,p})}function Oe(){Ee&&V({fromCache:!0})}function Le(){g.setAttribute("data-ezs-loaded","true")}function Ie(){return __async(this,null,function*(){return w&&j(),Oe(),ze().then(s=>__async(this,null,function*(){M=s,we(t)})).then(()=>{Le()})})}return Ie().then(()=>({filterTree:M,getActiveFilters(){return[...S]},updateFilterValue:ce,clearAllCache:j,prodcutTagsLookup:X,destory(){t.forEach(s=>{s.options.length=1}),H.forEach(s=>s()),H.length=1}}))})}const Te="";window.EZSearchDefaultInstances=[];function pe(){Array.from(document.querySelectorAll('[data-ezs="search"]:not([data-ezs-auto-initialize="false"])')).forEach(t=>{document.dispatchEvent(new CustomEvent("EZSearch_Loading",{detail:t})),ne({rootNode:t,onEvent:null}).then(r=>{window.EZSearchDefaultInstances.push(r),document.dispatchEvent(new CustomEvent("EZSearch_Loaded",{detail:t}))})})}return ue().then(pe),{hydrate:ne}});
